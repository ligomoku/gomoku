export default function (opts) {
    const minLength = opts.minLength || 3, empty = opts.empty || (() => '<div class="complete-list__empty">No results.</div>'), cache = new Map(), fetchResults = term => {
        if (cache.has(term))
            return new Promise(res => setTimeout(() => res(cache.get(term)), 50));
        else if (term.length > 3 &&
            Array.from({ length: term.length - 3 }, (_, i) => -i - 1)
                .map(i => term.slice(0, i))
                .some(sub => cache.has(sub) && !cache.get(sub).length))
            return Promise.resolve([]);
        return opts.fetch(term).then(results => {
            cache.set(term, results);
            return results;
        });
    }, selectedResult = () => {
        if (selectedIndex === null)
            return;
        return renderedResults[selectedIndex];
    }, moveSelection = (offset) => {
        const nb = renderedResults.length;
        selectedIndex = (selectedIndex === null ? (offset == 1 ? 0 : -1) : selectedIndex + offset) % nb;
        if (selectedIndex < 0)
            selectedIndex += nb;
        renderSelection();
        const result = selectedResult();
        if (result)
            opts.input.value = opts.populate(result);
    }, renderSelection = () => {
        $container.find('.complete-selected').removeClass('complete-selected');
        if (selectedIndex !== null)
            $container.find('.complete-result').eq(selectedIndex).addClass('complete-selected');
    };
    const $container = $('<div class="complete-list none"></div>').insertAfter(opts.input);
    let selectedIndex = null, renderedResults = [];
    opts.input.autocomplete = 'off';
    const update = () => {
        const term = opts.input.value.trim();
        if (term.length >= minLength && (!opts.regex || term.match(opts.regex)))
            fetchResults(term).then(renderResults, console.log);
        else
            $container.addClass('none');
    };
    $(opts.input).on({
        input: update,
        focus: update,
        // must be delayed, otherwise the result click event doesn't fire
        blur() {
            setTimeout(() => $container.addClass('none'), 100);
            return true;
        },
        keydown(e) {
            if ($container.hasClass('none'))
                return;
            if (e.code == 'ArrowDown') {
                moveSelection(1);
                return false;
            }
            if (e.code == 'ArrowUp') {
                moveSelection(-1);
                return false;
            }
            if (e.code == 'Enter') {
                $container.addClass('none');
                const result = selectedResult() ||
                    (renderedResults[0] && opts.populate(renderedResults[0]) == opts.input.value
                        ? renderedResults[0]
                        : undefined);
                if (result) {
                    if (opts.onSelect)
                        opts.onSelect(result);
                    return false;
                }
            }
            return;
        },
    });
    const renderResults = (results) => {
        $container.empty();
        if (results[0])
            results.forEach(result => $(opts.render(result))
                /* can't use click because blur fires first and removes the click target */
                .on('mousedown touchdown', () => {
                /* crazy shit here
                   just `opts.input.value = opts.select(result);`
                   does nothing. `opts.select` is not called.
                   */
                const newValue = opts.populate(result);
                opts.input.value = newValue;
                if (opts.onSelect)
                    opts.onSelect(result);
                return true;
            })
                .appendTo($container));
        else
            $container.html(empty());
        renderedResults = results;
        selectedIndex = null;
        renderSelection();
        $container.removeClass('none');
    };
    /* opts.input.value = 'chess'; */
    /* $(opts.input).trigger('input'); */
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGxldGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvY29tcGxldGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBYUEsTUFBTSxDQUFDLE9BQU8sV0FBbUIsSUFBa0I7SUFDakQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsSUFBSSxDQUFDLEVBQ25DLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMscURBQXFELENBQUMsRUFDbkYsS0FBSyxHQUFHLElBQUksR0FBRyxFQUFvQixFQUNuQyxZQUFZLEdBQWtCLElBQUksQ0FBQyxFQUFFO1FBQ25DLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFBRSxPQUFPLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQzthQUN2RixJQUNILElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQztZQUNmLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztpQkFDdEQsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7aUJBQzFCLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBRSxDQUFDLE1BQU0sQ0FBQztZQUV6RCxPQUFPLE9BQU8sQ0FBQyxPQUFPLENB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RSxHQUFHLEVBQUU7Z0JBQzlCOzs7cUJBR0s7Z0JBQ0wsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDdkMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsUUFBUSxDQUFDO2dCQUM1QixJQUFJLElBQUksQ0FBQyxRQUFRO29CQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBQ3pDLE9BQU8sSUFBSSxDQUFDO1lBQ2QsQ0FBQyxDQUFDO2lCQUNELFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FDeEIsQ0FBQzs7WUFDQyxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDOUIsZUFBZSxHQUFHLE9BQU8sQ0FBQztRQUMxQixhQUFhLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLGVBQWUsRUFBRSxDQUFDO1FBQ2xCLFVBQVUsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDakMsQ0FBQyxDQUFDO0lBRUYsaUNBQWlDO0lBQ2pDLHFDQUFxQztBQUN2QyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsidHlwZSBGZXRjaDxSZXN1bHQ+ID0gKHRlcm06IHN0cmluZykgPT4gUHJvbWlzZTxSZXN1bHRbXT47XG5cbmludGVyZmFjZSBPcHRzPFJlc3VsdD4ge1xuICBpbnB1dDogSFRNTElucHV0RWxlbWVudDtcbiAgZmV0Y2g6IEZldGNoPFJlc3VsdD47XG4gIHJlbmRlcjogKHJlc3VsdDogUmVzdWx0KSA9PiBzdHJpbmc7XG4gIHBvcHVsYXRlOiAocmVzdWx0OiBSZXN1bHQpID0+IHN0cmluZzsgLy8gaW5wdXQgdmFsdWUgZnJvbSBhIHNlYXJjaCByZXN1bHRcbiAgb25TZWxlY3Q/OiAocmVzdWx0OiBSZXN1bHQpID0+IHZvaWQ7XG4gIGVtcHR5PzogKCkgPT4gc3RyaW5nO1xuICBtaW5MZW5ndGg/OiBudW1iZXI7XG4gIHJlZ2V4PzogUmVnRXhwO1xufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiA8UmVzdWx0PihvcHRzOiBPcHRzPFJlc3VsdD4pIHtcbiAgY29uc3QgbWluTGVuZ3RoID0gb3B0cy5taW5MZW5ndGggfHwgMyxcbiAgICBlbXB0eSA9IG9wdHMuZW1wdHkgfHwgKCgpID0+ICc8ZGl2IGNsYXNzPVwiY29tcGxldGUtbGlzdF9fZW1wdHlcIj5ObyByZXN1bHRzLjwvZGl2PicpLFxuICAgIGNhY2hlID0gbmV3IE1hcDxzdHJpbmcsIFJlc3VsdFtdPigpLFxuICAgIGZldGNoUmVzdWx0czogRmV0Y2g8UmVzdWx0PiA9IHRlcm0gPT4ge1xuICAgICAgaWYgKGNhY2hlLmhhcyh0ZXJtKSkgcmV0dXJuIG5ldyBQcm9taXNlKHJlcyA9PiBzZXRUaW1lb3V0KCgpID0+IHJlcyhjYWNoZS5nZXQodGVybSkhKSwgNTApKTtcbiAgICAgIGVsc2UgaWYgKFxuICAgICAgICB0ZXJtLmxlbmd0aCA+IDMgJiZcbiAgICAgICAgQXJyYXkuZnJvbSh7IGxlbmd0aDogdGVybS5sZW5ndGggLSAzIH0sIChfLCBpKSA9PiAtaSAtIDEpXG4gICAgICAgICAgLm1hcChpID0+IHRlcm0uc2xpY2UoMCwgaSkpXG4gICAgICAgICAgLnNvbWUoc3ViID0+IGNhY2hlLmhhcyhzdWIpICYmICFjYWNoZS5nZXQoc3ViKSEubGVuZ3RoKVxuICAgICAgKVxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKFtdKTtcbiAgICAgIHJldHVybiBvcHRzLmZldGNoKHRlcm0pLnRoZW4ocmVzdWx0cyA9PiB7XG4gICAgICAgIGNhY2hlLnNldCh0ZXJtLCByZXN1bHRzKTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdHM7XG4gICAgICB9KTtcbiAgICB9LFxuICAgIHNlbGVjdGVkUmVzdWx0ID0gKCk6IFJlc3VsdCB8IHVuZGVmaW5lZCA9PiB7XG4gICAgICBpZiAoc2VsZWN0ZWRJbmRleCA9PT0gbnVsbCkgcmV0dXJuO1xuICAgICAgcmV0dXJuIHJlbmRlcmVkUmVzdWx0c1tzZWxlY3RlZEluZGV4XTtcbiAgICB9LFxuICAgIG1vdmVTZWxlY3Rpb24gPSAob2Zmc2V0OiBudW1iZXIpID0+IHtcbiAgICAgIGNvbnN0IG5iID0gcmVuZGVyZWRSZXN1bHRzLmxlbmd0aDtcbiAgICAgIHNlbGVjdGVkSW5kZXggPSAoc2VsZWN0ZWRJbmRleCA9PT0gbnVsbCA/IChvZmZzZXQgPT0gMSA/IDAgOiAtMSkgOiBzZWxlY3RlZEluZGV4ICsgb2Zmc2V0KSAlIG5iO1xuICAgICAgaWYgKHNlbGVjdGVkSW5kZXggPCAwKSBzZWxlY3RlZEluZGV4ICs9IG5iO1xuICAgICAgcmVuZGVyU2VsZWN0aW9uKCk7XG4gICAgICBjb25zdCByZXN1bHQgPSBzZWxlY3RlZFJlc3VsdCgpO1xuICAgICAgaWYgKHJlc3VsdCkgb3B0cy5pbnB1dC52YWx1ZSA9IG9wdHMucG9wdWxhdGUocmVzdWx0KTtcbiAgICB9LFxuICAgIHJlbmRlclNlbGVjdGlvbiA9ICgpID0+IHtcbiAgICAgICRjb250YWluZXIuZmluZCgnLmNvbXBsZXRlLXNlbGVjdGVkJykucmVtb3ZlQ2xhc3MoJ2NvbXBsZXRlLXNlbGVjdGVkJyk7XG4gICAgICBpZiAoc2VsZWN0ZWRJbmRleCAhPT0gbnVsbCkgJGNvbnRhaW5lci5maW5kKCcuY29tcGxldGUtcmVzdWx0JykuZXEoc2VsZWN0ZWRJbmRleCkuYWRkQ2xhc3MoJ2NvbXBsZXRlLXNlbGVjdGVkJyk7XG4gICAgfTtcblxuICBjb25zdCAkY29udGFpbmVyOiBDYXNoID0gJCgnPGRpdiBjbGFzcz1cImNvbXBsZXRlLWxpc3Qgbm9uZVwiPjwvZGl2PicpLmluc2VydEFmdGVyKG9wdHMuaW5wdXQpO1xuICBsZXQgc2VsZWN0ZWRJbmRleDogbnVtYmVyIHwgbnVsbCA9IG51bGwsXG4gICAgcmVuZGVyZWRSZXN1bHRzOiBSZXN1bHRbXSA9IFtdO1xuXG4gIG9wdHMuaW5wdXQuYXV0b2NvbXBsZXRlID0gJ29mZic7XG5cbiAgY29uc3QgdXBkYXRlID0gKCkgPT4ge1xuICAgIGNvbnN0IHRlcm0gPSBvcHRzLmlucHV0LnZhbHVlLnRyaW0oKTtcbiAgICBpZiAodGVybS5sZW5ndGggPj0gbWluTGVuZ3RoICYmICghb3B0cy5yZWdleCB8fCB0ZXJtLm1hdGNoKG9wdHMucmVnZXgpKSlcbiAgICAgIGZldGNoUmVzdWx0cyh0ZXJtKS50aGVuKHJlbmRlclJlc3VsdHMsIGNvbnNvbGUubG9nKTtcbiAgICBlbHNlICRjb250YWluZXIuYWRkQ2xhc3MoJ25vbmUnKTtcbiAgfTtcblxuICAkKG9wdHMuaW5wdXQpLm9uKHtcbiAgICBpbnB1dDogdXBkYXRlLFxuICAgIGZvY3VzOiB1cGRhdGUsXG4gICAgLy8gbXVzdCBiZSBkZWxheWVkLCBvdGhlcndpc2UgdGhlIHJlc3VsdCBjbGljayBldmVudCBkb2Vzbid0IGZpcmVcbiAgICBibHVyKCkge1xuICAgICAgc2V0VGltZW91dCgoKSA9PiAkY29udGFpbmVyLmFkZENsYXNzKCdub25lJyksIDEwMCk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9LFxuICAgIGtleWRvd24oZTogS2V5Ym9hcmRFdmVudCkge1xuICAgICAgaWYgKCRjb250YWluZXIuaGFzQ2xhc3MoJ25vbmUnKSkgcmV0dXJuO1xuICAgICAgaWYgKGUuY29kZSA9PSAnQXJyb3dEb3duJykge1xuICAgICAgICBtb3ZlU2VsZWN0aW9uKDEpO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgICBpZiAoZS5jb2RlID09ICdBcnJvd1VwJykge1xuICAgICAgICBtb3ZlU2VsZWN0aW9uKC0xKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgaWYgKGUuY29kZSA9PSAnRW50ZXInKSB7XG4gICAgICAgICRjb250YWluZXIuYWRkQ2xhc3MoJ25vbmUnKTtcbiAgICAgICAgY29uc3QgcmVzdWx0ID1cbiAgICAgICAgICBzZWxlY3RlZFJlc3VsdCgpIHx8XG4gICAgICAgICAgKHJlbmRlcmVkUmVzdWx0c1swXSAmJiBvcHRzLnBvcHVsYXRlKHJlbmRlcmVkUmVzdWx0c1swXSkgPT0gb3B0cy5pbnB1dC52YWx1ZVxuICAgICAgICAgICAgPyByZW5kZXJlZFJlc3VsdHNbMF1cbiAgICAgICAgICAgIDogdW5kZWZpbmVkKTtcbiAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgIGlmIChvcHRzLm9uU2VsZWN0KSBvcHRzLm9uU2VsZWN0KHJlc3VsdCk7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm47XG4gICAgfSxcbiAgfSk7XG5cbiAgY29uc3QgcmVuZGVyUmVzdWx0cyA9IChyZXN1bHRzOiBSZXN1bHRbXSkgPT4ge1xuICAgICRjb250YWluZXIuZW1wdHkoKTtcbiAgICBpZiAocmVzdWx0c1swXSlcbiAgICAgIHJlc3VsdHMuZm9yRWFjaChyZXN1bHQgPT5cbiAgICAgICAgJChvcHRzLnJlbmRlcihyZXN1bHQpKVxuICAgICAgICAgIC8qIGNhbid0IHVzZSBjbGljayBiZWNhdXNlIGJsdXIgZmlyZXMgZmlyc3QgYW5kIHJlbW92ZXMgdGhlIGNsaWNrIHRhcmdldCAqL1xuICAgICAgICAgIC5vbignbW91c2Vkb3duIHRvdWNoZG93bicsICgpID0+IHtcbiAgICAgICAgICAgIC8qIGNyYXp5IHNoaXQgaGVyZVxuICAgICAgICAgICAgICAganVzdCBgb3B0cy5pbnB1dC52YWx1ZSA9IG9wdHMuc2VsZWN0KHJlc3VsdCk7YFxuICAgICAgICAgICAgICAgZG9lcyBub3RoaW5nLiBgb3B0cy5zZWxlY3RgIGlzIG5vdCBjYWxsZWQuXG4gICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgY29uc3QgbmV3VmFsdWUgPSBvcHRzLnBvcHVsYXRlKHJlc3VsdCk7XG4gICAgICAgICAgICBvcHRzLmlucHV0LnZhbHVlID0gbmV3VmFsdWU7XG4gICAgICAgICAgICBpZiAob3B0cy5vblNlbGVjdCkgb3B0cy5vblNlbGVjdChyZXN1bHQpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgfSlcbiAgICAgICAgICAuYXBwZW5kVG8oJGNvbnRhaW5lcilcbiAgICAgICk7XG4gICAgZWxzZSAkY29udGFpbmVyLmh0bWwoZW1wdHkoKSk7XG4gICAgcmVuZGVyZWRSZXN1bHRzID0gcmVzdWx0cztcbiAgICBzZWxlY3RlZEluZGV4ID0gbnVsbDtcbiAgICByZW5kZXJTZWxlY3Rpb24oKTtcbiAgICAkY29udGFpbmVyLnJlbW92ZUNsYXNzKCdub25lJyk7XG4gIH07XG5cbiAgLyogb3B0cy5pbnB1dC52YWx1ZSA9ICdjaGVzcyc7ICovXG4gIC8qICQob3B0cy5pbnB1dCkudHJpZ2dlcignaW5wdXQnKTsgKi9cbn1cbiJdfQ==