// from https://github.com/bryanwoods/autolink-js/blob/master/autolink.js
export const linkRegex = /(^|[\s\n]|<[A-Za-z]*\/?>)((?:(?:https?|ftp):\/\/|lichess\.org)[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~()_|])/gi;
export const newLineRegex = /\n/g;
export const userPattern = /(^|[^\w@#/])@([a-z0-9][a-z0-9_-]{0,28}[a-z0-9])/gi;
// looks like it has a @mention or #gameid or a url.tld
export const isMoreThanText = (str) => /(\n|(@|#|\.)\w{2,})/.test(str);
export function toLink(url) {
    if (!url.match(/^[A-Za-z]+:\/\//))
        url = 'https://' + url;
    return `<a target="_blank" rel="nofollow noopener noreferrer" href="${url}">${url.replace(/https?:\/\//, '')}</a>`;
}
export const autolink = (str, callback) => str.replace(linkRegex, (_, space, url) => space + callback(url));
export const innerHTML = (a, toHtml) => ({
    insert(vnode) {
        vnode.elm.innerHTML = toHtml(a);
        vnode.data.cachedA = a;
    },
    postpatch(old, vnode) {
        if (old.data.cachedA !== a) {
            vnode.elm.innerHTML = toHtml(a);
        }
        vnode.data.cachedA = a;
    },
});
export function linkReplace(href, body, cls) {
    if (href.includes('&quot;'))
        return href;
    return `<a target="_blank" rel="noopener nofollow noreferrer" href="${href.startsWith('/') || href.includes('://') ? href : '//' + href}"${cls ? ` class="${cls}"` : ''}>${body ? body : href}</a>`;
}
export const userLinkReplace = (_, prefix, user) => prefix + linkReplace('/@/' + user, '@' + user);
export const expandMentions = (html) => html.replace(userPattern, userLinkReplace);
export function enrichText(text, allowNewlines = true) {
    let html = autolink(lichess.escapeHtml(text), toLink);
    if (allowNewlines)
        html = html.replace(newLineRegex, '<br>');
    return html;
}
export function richHTML(text, newLines = true) {
    return innerHTML(text, t => enrichText(t, newLines));
}
const linkPattern = /\b\b(?:https?:\/\/)?(lichess\.org\/[-–—\w+&'@#\/%?=()~|!:,.;]+[\w+&@#\/%=~|])/gi;
const pawnDropPattern = /^[a-h][2-7]$/;
const movePattern = /\b(\d+)\s*(\.+)\s*(?:[o0-]+[o0]|[NBRQKP\u2654\u2655\u2656\u2657\u2658\u2659]?[a-h]?[1-8]?[x@]?[a-z][1-8](?:=[NBRQK\u2654\u2655\u2656\u2657\u2658\u2659])?)\+?#?[!\?=]{0,5}/gi;
function moveReplacer(match, turn, dots) {
    if (turn < 1 || turn > 200)
        return match;
    const ply = turn * 2 - (dots.length > 1 ? 0 : 1);
    return '<a class="jump" data-ply="' + ply + '">' + match + '</a>';
}
const addPlies = (html) => html.replace(movePattern, moveReplacer);
const userLinkReplacePawn = (orig, prefix, user) => user.match(pawnDropPattern) ? orig : userLinkReplace(orig, prefix, user);
export function enhance(text, parseMoves) {
    const escaped = lichess.escapeHtml(text);
    const linked = escaped.replace(userPattern, userLinkReplacePawn).replace(linkPattern, linkReplace);
    const plied = parseMoves && linked === escaped ? addPlies(linked) : linked;
    return plied;
}
function toYouTubeEmbedUrl(url) {
    if (!url)
        return;
    const m = url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com|youtu\.be)\/(?:watch)?(?:\?v=)?([^"&?\/ ]{11})(?:\?|&|)(\S*)/i);
    if (!m)
        return;
    let start = 0;
    m[2].split('&').forEach(function (p) {
        const s = p.split('=');
        if (s[0] === 't' || s[0] === 'start') {
            if (s[1].match(/^\d+$/))
                start = parseInt(s[1]);
            else {
                const n = s[1].match(/(?:(\d+)h)?(?:(\d+)m)?(?:(\d+)s)?/);
                start = (parseInt(n[1]) || 0) * 3600 + (parseInt(n[2]) || 0) * 60 + (parseInt(n[3]) || 0);
            }
        }
    });
    const params = 'modestbranding=1&rel=0&controls=2&iv_load_policy=3' + (start ? '&start=' + start : '');
    return 'https://www.youtube.com/embed/' + m[1] + '?' + params;
}
export function toYouTubeEmbed(url) {
    const embedUrl = toYouTubeEmbedUrl(url);
    return embedUrl
        ? `<div class="embed"><iframe width="100%" src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>`
        : undefined;
}
function toTwitchEmbedUrl(url) {
    if (!url)
        return;
    const m = url.match(/(?:https?:\/\/)?(?:www\.)?(?:twitch.tv)\/([^"&?/ ]+)/i);
    return m ? `https://player.twitch.tv/?channel=${m[1]}&parent=${location.hostname}&autoplay=false` : undefined;
}
export function toTwitchEmbed(url) {
    const embedUrl = toTwitchEmbedUrl(url);
    return embedUrl
        ? `<div class="embed"><iframe width="100%" src="${embedUrl}" frameborder=0 allowfullscreen></iframe></div>`
        : undefined;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmljaFRleHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmljaFRleHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBSUEseUVBQXlFO0FBQ3pFLE1BQU0sQ0FBQyxNQUFNLFNBQVMsR0FDcEIsd0lBQXdJLENBQUM7QUFDM0ksTUFBTSxDQUFDLE1BQU0sWUFBWSxHQUFHLEtBQUssQ0FBQztBQUNsQyxNQUFNLENBQUMsTUFBTSxXQUFXLEdBQUcsbURBQW1ELENBQUM7QUFFL0UsdURBQXVEO0FBQ3ZELE1BQU0sQ0FBQyxNQUFNLGNBQWMsR0FBRyxDQUFDLEdBQVcsRUFBRSxFQUFFLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBRS9FLE1BQU0sVUFBVSxNQUFNLENBQUMsR0FBVztJQUNoQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQztRQUFFLEdBQUcsR0FBRyxVQUFVLEdBQUcsR0FBRyxDQUFDO0lBQzFELE9BQU8sK0RBQStELEdBQUcsS0FBSyxHQUFHLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDO0FBQ3JILENBQUM7QUFFRCxNQUFNLENBQUMsTUFBTSxRQUFRLEdBQUcsQ0FBQyxHQUFXLEVBQUUsUUFBaUMsRUFBVSxFQUFFLENBQ2pGLEdBQUcsQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUFDLEtBQUssR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUVuRSxNQUFNLENBQUMsTUFBTSxTQUFTLEdBQUcsQ0FBSSxDQUFJLEVBQUUsTUFBd0IsRUFBUyxFQUFFLENBQUMsQ0FBQztJQUN0RSxNQUFNLENBQUMsS0FBWTtRQUNoQixLQUFLLENBQUMsR0FBbUIsQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2pELEtB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Q0FBQyxDQUFDLHFDQUFxQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsUUFBUSxDQUFDLFFBQVEsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztBQUNoSCxDQUFDO0FBRUQsTUFBTSxVQUFVLGFBQWEsQ0FBQyxHQUFXO0lBQ3ZDLE1BQU0sUUFBUSxHQUFHLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3ZDLE9BQU8sUUFBUTtRQUNiLENBQUMsQ0FBQyxnREFBZ0QsUUFBUSxpREFBaUQ7UUFDM0csQ0FBQyxDQUFDLFNBQVMsQ0FBQztBQUNoQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gUmljaCBUZXh0IGhlbHBlciBmdW5jdGlvbnNcbi8vIFJlZmFjdG9yZWQgZm9yIGh0dHBzOi8vZ2l0aHViLmNvbS9saWNoZXNzLW9yZy9saWxhL2lzc3Vlcy83MzQyIHJlcXVlc3RcbmltcG9ydCB7IFZOb2RlLCBIb29rcyB9IGZyb20gJ3NuYWJiZG9tJztcblxuLy8gZnJvbSBodHRwczovL2dpdGh1Yi5jb20vYnJ5YW53b29kcy9hdXRvbGluay1qcy9ibG9iL21hc3Rlci9hdXRvbGluay5qc1xuZXhwb3J0IGNvbnN0IGxpbmtSZWdleCA9XG4gIC8oXnxbXFxzXFxuXXw8W0EtWmEtel0qXFwvPz4pKCg/Oig/Omh0dHBzP3xmdHApOlxcL1xcL3xsaWNoZXNzXFwub3JnKVtcXC1BLVowLTkrXFx1MDAyNlxcdTIwMTlAI1xcLyU/PSgpfl98ITosLjtdKltcXC1BLVowLTkrXFx1MDAyNkAjXFwvJT1+KClffF0pL2dpO1xuZXhwb3J0IGNvbnN0IG5ld0xpbmVSZWdleCA9IC9cXG4vZztcbmV4cG9ydCBjb25zdCB1c2VyUGF0dGVybiA9IC8oXnxbXlxcd0AjL10pQChbYS16MC05XVthLXowLTlfLV17MCwyOH1bYS16MC05XSkvZ2k7XG5cbi8vIGxvb2tzIGxpa2UgaXQgaGFzIGEgQG1lbnRpb24gb3IgI2dhbWVpZCBvciBhIHVybC50bGRcbmV4cG9ydCBjb25zdCBpc01vcmVUaGFuVGV4dCA9IChzdHI6IHN0cmluZykgPT4gLyhcXG58KEB8I3xcXC4pXFx3ezIsfSkvLnRlc3Qoc3RyKTtcblxuZXhwb3J0IGZ1bmN0aW9uIHRvTGluayh1cmw6IHN0cmluZyk6IHN0cmluZyB7XG4gIGlmICghdXJsLm1hdGNoKC9eW0EtWmEtel0rOlxcL1xcLy8pKSB1cmwgPSAnaHR0cHM6Ly8nICsgdXJsO1xuICByZXR1cm4gYDxhIHRhcmdldD1cIl9ibGFua1wiIHJlbD1cIm5vZm9sbG93IG5vb3BlbmVyIG5vcmVmZXJyZXJcIiBocmVmPVwiJHt1cmx9XCI+JHt1cmwucmVwbGFjZSgvaHR0cHM/OlxcL1xcLy8sICcnKX08L2E+YDtcbn1cblxuZXhwb3J0IGNvbnN0IGF1dG9saW5rID0gKHN0cjogc3RyaW5nLCBjYWxsYmFjazogKHN0cjogc3RyaW5nKSA9PiBzdHJpbmcpOiBzdHJpbmcgPT5cbiAgc3RyLnJlcGxhY2UobGlua1JlZ2V4LCAoXywgc3BhY2UsIHVybCkgPT4gc3BhY2UgKyBjYWxsYmFjayh1cmwpKTtcblxuZXhwb3J0IGNvbnN0IGlubmVySFRNTCA9IDxBPihhOiBBLCB0b0h0bWw6IChhOiBBKSA9PiBzdHJpbmcpOiBIb29rcyA9PiAoe1xuICBpbnNlcnQodm5vZGU6IFZOb2RlKSB7XG4gICAgKHZub2RlLmVsbSBhcyBIVE1MRWxlbWVudCkuaW5uZXJIVE1MID0gdG9IdG1sKGEpO1xuICAgIHZub2RlLmRhdGEhLmNhY2hlZEEgPSBhO1xuICB9LFxuICBwb3N0cGF0Y2gob2xkOiBWTm9kZSwgdm5vZGU6IFZOb2RlKSB7XG4gICAgaWYgKG9sZC5kYXRhIS5jYWNoZWRBICE9PSBhKSB7XG4gICAgICAodm5vZGUuZWxtIGFzIEhUTUxFbGVtZW50KS5pbm5lckhUTUwgPSB0b0h0bWwoYSk7XG4gICAgfVxuICAgIHZub2RlLmRhdGEhLmNhY2hlZEEgPSBhO1xuICB9LFxufSk7XG5cbmV4cG9ydCBmdW5jdGlvbiBsaW5rUmVwbGFjZShocmVmOiBzdHJpbmcsIGJvZHk/OiBzdHJpbmcsIGNscz86IHN0cmluZykge1xuICBpZiAoaHJlZi5pbmNsdWRlcygnJnF1b3Q7JykpIHJldHVybiBocmVmO1xuICByZXR1cm4gYDxhIHRhcmdldD1cIl9ibGFua1wiIHJlbD1cIm5vb3BlbmVyIG5vZm9sbG93IG5vcmVmZXJyZXJcIiBocmVmPVwiJHtcbiAgICBocmVmLnN0YXJ0c1dpdGgoJy8nKSB8fCBocmVmLmluY2x1ZGVzKCc6Ly8nKSA/IGhyZWYgOiAnLy8nICsgaHJlZlxuICB9XCIke2NscyA/IGAgY2xhc3M9XCIke2Nsc31cImAgOiAnJ30+JHtib2R5ID8gYm9keSA6IGhyZWZ9PC9hPmA7XG59XG5cbmV4cG9ydCBjb25zdCB1c2VyTGlua1JlcGxhY2UgPSAoXzogc3RyaW5nLCBwcmVmaXg6IHN0cmluZywgdXNlcjogc3RyaW5nKSA9PlxuICBwcmVmaXggKyBsaW5rUmVwbGFjZSgnL0AvJyArIHVzZXIsICdAJyArIHVzZXIpO1xuXG5leHBvcnQgY29uc3QgZXhwYW5kTWVudGlvbnMgPSAoaHRtbDogc3RyaW5nKSA9PiBodG1sLnJlcGxhY2UodXNlclBhdHRlcm4sIHVzZXJMaW5rUmVwbGFjZSk7XG5cbmV4cG9ydCBmdW5jdGlvbiBlbnJpY2hUZXh0KHRleHQ6IHN0cmluZywgYWxsb3dOZXdsaW5lcyA9IHRydWUpOiBzdHJpbmcge1xuICBsZXQgaHRtbCA9IGF1dG9saW5rKGxpY2hlc3MuZXNjYXBlSHRtbCh0ZXh0KSwgdG9MaW5rKTtcbiAgaWYgKGFsbG93TmV3bGluZXMpIGh0bWwgPSBodG1sLnJlcGxhY2UobmV3TGluZVJlZ2V4LCAnPGJyPicpO1xuICByZXR1cm4gaHRtbDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJpY2hIVE1MKHRleHQ6IHN0cmluZywgbmV3TGluZXMgPSB0cnVlKTogSG9va3Mge1xuICByZXR1cm4gaW5uZXJIVE1MKHRleHQsIHQgPT4gZW5yaWNoVGV4dCh0LCBuZXdMaW5lcykpO1xufVxuXG5jb25zdCBsaW5rUGF0dGVybiA9IC9cXGJcXGIoPzpodHRwcz86XFwvXFwvKT8obGljaGVzc1xcLm9yZ1xcL1st4oCT4oCUXFx3KyYnQCNcXC8lPz0oKX58ITosLjtdK1tcXHcrJkAjXFwvJT1+fF0pL2dpO1xuY29uc3QgcGF3bkRyb3BQYXR0ZXJuID0gL15bYS1oXVsyLTddJC87XG5jb25zdCBtb3ZlUGF0dGVybiA9XG4gIC9cXGIoXFxkKylcXHMqKFxcLispXFxzKig/OltvMC1dK1tvMF18W05CUlFLUFxcdTI2NTRcXHUyNjU1XFx1MjY1NlxcdTI2NTdcXHUyNjU4XFx1MjY1OV0/W2EtaF0/WzEtOF0/W3hAXT9bYS16XVsxLThdKD86PVtOQlJRS1xcdTI2NTRcXHUyNjU1XFx1MjY1NlxcdTI2NTdcXHUyNjU4XFx1MjY1OV0pPylcXCs/Iz9bIVxcPz1dezAsNX0vZ2k7XG5cbmZ1bmN0aW9uIG1vdmVSZXBsYWNlcihtYXRjaDogc3RyaW5nLCB0dXJuOiBudW1iZXIsIGRvdHM6IHN0cmluZykge1xuICBpZiAodHVybiA8IDEgfHwgdHVybiA+IDIwMCkgcmV0dXJuIG1hdGNoO1xuICBjb25zdCBwbHkgPSB0dXJuICogMiAtIChkb3RzLmxlbmd0aCA+IDEgPyAwIDogMSk7XG4gIHJldHVybiAnPGEgY2xhc3M9XCJqdW1wXCIgZGF0YS1wbHk9XCInICsgcGx5ICsgJ1wiPicgKyBtYXRjaCArICc8L2E+Jztcbn1cblxuY29uc3QgYWRkUGxpZXMgPSAoaHRtbDogc3RyaW5nKSA9PiBodG1sLnJlcGxhY2UobW92ZVBhdHRlcm4sIG1vdmVSZXBsYWNlcik7XG5cbmNvbnN0IHVzZXJMaW5rUmVwbGFjZVBhd24gPSAob3JpZzogc3RyaW5nLCBwcmVmaXg6IHN0cmluZywgdXNlcjogc3RyaW5nKSA9PlxuICB1c2VyLm1hdGNoKHBhd25Ecm9wUGF0dGVybikgPyBvcmlnIDogdXNlckxpbmtSZXBsYWNlKG9yaWcsIHByZWZpeCwgdXNlcik7XG5cbmV4cG9ydCBmdW5jdGlvbiBlbmhhbmNlKHRleHQ6IHN0cmluZywgcGFyc2VNb3ZlczogYm9vbGVhbik6IHN0cmluZyB7XG4gIGNvbnN0IGVzY2FwZWQgPSBsaWNoZXNzLmVzY2FwZUh0bWwodGV4dCk7XG4gIGNvbnN0IGxpbmtlZCA9IGVzY2FwZWQucmVwbGFjZSh1c2VyUGF0dGVybiwgdXNlckxpbmtSZXBsYWNlUGF3bikucmVwbGFjZShsaW5rUGF0dGVybiwgbGlua1JlcGxhY2UpO1xuICBjb25zdCBwbGllZCA9IHBhcnNlTW92ZXMgJiYgbGlua2VkID09PSBlc2NhcGVkID8gYWRkUGxpZXMobGlua2VkKSA6IGxpbmtlZDtcbiAgcmV0dXJuIHBsaWVkO1xufVxuXG5mdW5jdGlvbiB0b1lvdVR1YmVFbWJlZFVybCh1cmw6IHN0cmluZykge1xuICBpZiAoIXVybCkgcmV0dXJuO1xuICBjb25zdCBtID0gdXJsLm1hdGNoKFxuICAgIC8oPzpodHRwcz86XFwvXFwvKT8oPzp3d3dcXC4pPyg/OnlvdXR1YmVcXC5jb218eW91dHVcXC5iZSlcXC8oPzp3YXRjaCk/KD86XFw/dj0pPyhbXlwiJj9cXC8gXXsxMX0pKD86XFw/fCZ8KShcXFMqKS9pXG4gICk7XG4gIGlmICghbSkgcmV0dXJuO1xuICBsZXQgc3RhcnQgPSAwO1xuICBtWzJdLnNwbGl0KCcmJykuZm9yRWFjaChmdW5jdGlvbiAocCkge1xuICAgIGNvbnN0IHMgPSBwLnNwbGl0KCc9Jyk7XG4gICAgaWYgKHNbMF0gPT09ICd0JyB8fCBzWzBdID09PSAnc3RhcnQnKSB7XG4gICAgICBpZiAoc1sxXS5tYXRjaCgvXlxcZCskLykpIHN0YXJ0ID0gcGFyc2VJbnQoc1sxXSk7XG4gICAgICBlbHNlIHtcbiAgICAgICAgY29uc3QgbiA9IHNbMV0ubWF0Y2goLyg/OihcXGQrKWgpPyg/OihcXGQrKW0pPyg/OihcXGQrKXMpPy8pITtcbiAgICAgICAgc3RhcnQgPSAocGFyc2VJbnQoblsxXSkgfHwgMCkgKiAzNjAwICsgKHBhcnNlSW50KG5bMl0pIHx8IDApICogNjAgKyAocGFyc2VJbnQoblszXSkgfHwgMCk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcbiAgY29uc3QgcGFyYW1zID0gJ21vZGVzdGJyYW5kaW5nPTEmcmVsPTAmY29udHJvbHM9MiZpdl9sb2FkX3BvbGljeT0zJyArIChzdGFydCA/ICcmc3RhcnQ9JyArIHN0YXJ0IDogJycpO1xuICByZXR1cm4gJ2h0dHBzOi8vd3d3LnlvdXR1YmUuY29tL2VtYmVkLycgKyBtWzFdICsgJz8nICsgcGFyYW1zO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdG9Zb3VUdWJlRW1iZWQodXJsOiBzdHJpbmcpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICBjb25zdCBlbWJlZFVybCA9IHRvWW91VHViZUVtYmVkVXJsKHVybCk7XG4gIHJldHVybiBlbWJlZFVybFxuICAgID8gYDxkaXYgY2xhc3M9XCJlbWJlZFwiPjxpZnJhbWUgd2lkdGg9XCIxMDAlXCIgc3JjPVwiJHtlbWJlZFVybH1cIiBmcmFtZWJvcmRlcj1cIjBcIiBhbGxvdz1cImFjY2VsZXJvbWV0ZXI7IGF1dG9wbGF5OyBlbmNyeXB0ZWQtbWVkaWE7IGd5cm9zY29wZTsgcGljdHVyZS1pbi1waWN0dXJlXCIgYWxsb3dmdWxsc2NyZWVuPjwvaWZyYW1lPjwvZGl2PmBcbiAgICA6IHVuZGVmaW5lZDtcbn1cblxuZnVuY3Rpb24gdG9Ud2l0Y2hFbWJlZFVybCh1cmw6IHN0cmluZykge1xuICBpZiAoIXVybCkgcmV0dXJuO1xuICBjb25zdCBtID0gdXJsLm1hdGNoKC8oPzpodHRwcz86XFwvXFwvKT8oPzp3d3dcXC4pPyg/OnR3aXRjaC50dilcXC8oW15cIiY/LyBdKykvaSk7XG4gIHJldHVybiBtID8gYGh0dHBzOi8vcGxheWVyLnR3aXRjaC50di8/Y2hhbm5lbD0ke21bMV19JnBhcmVudD0ke2xvY2F0aW9uLmhvc3RuYW1lfSZhdXRvcGxheT1mYWxzZWAgOiB1bmRlZmluZWQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0b1R3aXRjaEVtYmVkKHVybDogc3RyaW5nKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgY29uc3QgZW1iZWRVcmwgPSB0b1R3aXRjaEVtYmVkVXJsKHVybCk7XG4gIHJldHVybiBlbWJlZFVybFxuICAgID8gYDxkaXYgY2xhc3M9XCJlbWJlZFwiPjxpZnJhbWUgd2lkdGg9XCIxMDAlXCIgc3JjPVwiJHtlbWJlZFVybH1cIiBmcmFtZWJvcmRlcj0wIGFsbG93ZnVsbHNjcmVlbj48L2lmcmFtZT48L2Rpdj5gXG4gICAgOiB1bmRlZmluZWQ7XG59XG4iXX0=