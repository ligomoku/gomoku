import * as miniBoard from 'common/mini-board';
import { Chess } from 'chessops/chess';
import { h } from 'snabbdom';
import { parseFen, makeFen } from 'chessops/fen';
import { parseUci } from 'chessops/util';
import { onInsert } from 'common/snabbdom';
const slowPuzzleIds = (ctrl) => {
    if (!ctrl.filters.slow() || !ctrl.run.history.length)
        return undefined;
    const mean = ctrl.run.history.reduce((a, r) => a + r.millis, 0) / ctrl.run.history.length;
    const threshold = mean * 1.5;
    return new Set(ctrl.run.history.filter(r => r.millis > threshold).map(r => r.puzzle.id));
};
const toggleButton = (prop, title) => h('button.puz-history__filter.button', {
    class: {
        active: prop(),
        'button-empty': !prop,
    },
    hook: onInsert(e => e.addEventListener('click', prop.toggle)),
}, title);
export default (ctrl) => {
    const slowIds = slowPuzzleIds(ctrl), filters = ctrl.filters, noarg = ctrl.trans.noarg, buttons = [
        toggleButton(filters.fail, noarg('failedPuzzles')),
        toggleButton(filters.slow, noarg('slowPuzzles')),
    ];
    if (filters.skip)
        buttons.push(toggleButton(filters.skip, noarg('skippedPuzzle')));
    return h('div.puz-history.box.box-pad', [
        h('div.box__top', [h('h2', ctrl.trans('puzzlesPlayed')), h('div.box__top__actions', buttons)]),
        h('div.puz-history__rounds', ctrl.run.history
            .filter(r => (!r.win || !filters.fail()) &&
            (!slowIds || slowIds.has(r.puzzle.id)) &&
            (!filters.skip || !filters.skip() || r.puzzle.id === ctrl.run.skipId))
            .map(round => h('div.puz-history__round', {
            key: round.puzzle.id,
        }, [
            h('a.puz-history__round__puzzle.mini-board.cg-wrap.is2d', {
                attrs: {
                    href: `/training/${round.puzzle.id}`,
                    target: '_blank',
                    rel: 'noopener',
                },
                hook: onInsert(e => {
                    const pos = Chess.fromSetup(parseFen(round.puzzle.fen).unwrap()).unwrap();
                    const uci = round.puzzle.line.split(' ')[0];
                    pos.play(parseUci(uci));
                    miniBoard.initWith(e, makeFen(pos.toSetup()), pos.turn, uci);
                }),
            }),
            h('span.puz-history__round__meta', [
                h('span.puz-history__round__result', [
                    h(round.win ? 'good' : 'bad', Math.round(round.millis / 1000) + 's'),
                    h('rating', round.puzzle.rating),
                ]),
                h('span.puz-history__round__id', '#' + round.puzzle.id),
            ]),
        ]))),
    ]);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGlzdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy92aWV3L2hpc3RvcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLFNBQVMsTUFBTSxtQkFBbUIsQ0FBQztBQUUvQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdkMsT0FBTyxFQUFFLENBQUMsRUFBUyxNQUFNLFVBQVUsQ0FBQztBQUNwQyxPQUFPLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUNqRCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUczQyxNQUFNLGFBQWEsR0FBRyxDQUFDLElBQWEsRUFBMkIsRUFBRTtJQUMvRCxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU07UUFBRSxPQUFPLFNBQVMsQ0FBQztJQUN2RSxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUM7SUFDMUYsTUFBTSxTQUFTLEdBQUcsSUFBSSxHQUFHLEdBQUcsQ0FBQztJQUM3QixPQUFPLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLEdBQUcsU0FBUyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQzNGLENBQUMsQ0FBQztBQUVGLE1BQU0sWUFBWSxHQUFHLENBQUMsSUFBWSxFQUFFLEtBQWEsRUFBUyxFQUFFLENBQzFELENBQUMsQ0FDQyxtQ0FBbUMsRUFDbkM7SUFDRSxLQUFLLEVBQUU7UUFDTCxNQUFNLEVBQUUsSUFBSSxFQUFFO1FBQ2QsY0FBYyxFQUFFLENBQUMsSUFBSTtLQUN0QjtJQUNELElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztDQUM5RCxFQUNELEtBQUssQ0FDTixDQUFDO0FBRUosZUFBZSxDQUFDLElBQWEsRUFBUyxFQUFFO0lBQ3RDLE1BQU0sT0FBTyxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsRUFDakMsT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLEVBQ3RCLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFDeEIsT0FBTyxHQUFZO1FBQ2pCLFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUNsRCxZQUFZLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsYUFBYSxDQUFDLENBQUM7S0FDakQsQ0FBQztJQUNKLElBQUksT0FBTyxDQUFDLElBQUk7UUFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDbkYsT0FBTyxDQUFDLENBQUMsNkJBQTZCLEVBQUU7UUFDdEMsQ0FBQyxDQUFDLGNBQWMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyx1QkFBdUIsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQzlGLENBQUMsQ0FDQyx5QkFBeUIsRUFDekIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPO2FBQ2IsTUFBTSxDQUNMLENBQUMsQ0FBQyxFQUFFLENBQ0YsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDM0IsQ0FBQyxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDdEMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FDeEU7YUFDQSxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FDWCxDQUFDLENBQ0Msd0JBQXdCLEVBQ3hCO1lBQ0UsR0FBRyxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRTtTQUNyQixFQUNEO1lBQ0UsQ0FBQyxDQUFDLHNEQUFzRCxFQUFFO2dCQUN4RCxLQUFLLEVBQUU7b0JBQ0wsSUFBSSxFQUFFLGFBQWEsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUU7b0JBQ3BDLE1BQU0sRUFBRSxRQUFRO29CQUNoQixHQUFHLEVBQUUsVUFBVTtpQkFDaEI7Z0JBQ0QsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRTtvQkFDakIsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDO29CQUMxRSxNQUFNLEdBQUcsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQzVDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBRSxDQUFDLENBQUM7b0JBQ3pCLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLENBQUMsRUFBRSxHQUFHLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO2dCQUMvRCxDQUFDLENBQUM7YUFDSCxDQUFDO1lBQ0YsQ0FBQyxDQUFDLCtCQUErQixFQUFFO2dCQUNqQyxDQUFDLENBQUMsaUNBQWlDLEVBQUU7b0JBQ25DLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLEdBQUcsR0FBRyxDQUFDO29CQUNwRSxDQUFDLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDO2lCQUNqQyxDQUFDO2dCQUNGLENBQUMsQ0FBQyw2QkFBNkIsRUFBRSxHQUFHLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7YUFDeEQsQ0FBQztTQUNILENBQ0YsQ0FDRixDQUNKO0tBQ0YsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgbWluaUJvYXJkIGZyb20gJ2NvbW1vbi9taW5pLWJvYXJkJztcbmltcG9ydCB7IFB1ekN0cmwgfSBmcm9tICcuLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IENoZXNzIH0gZnJvbSAnY2hlc3NvcHMvY2hlc3MnO1xuaW1wb3J0IHsgaCwgVk5vZGUgfSBmcm9tICdzbmFiYmRvbSc7XG5pbXBvcnQgeyBwYXJzZUZlbiwgbWFrZUZlbiB9IGZyb20gJ2NoZXNzb3BzL2Zlbic7XG5pbXBvcnQgeyBwYXJzZVVjaSB9IGZyb20gJ2NoZXNzb3BzL3V0aWwnO1xuaW1wb3J0IHsgb25JbnNlcnQgfSBmcm9tICdjb21tb24vc25hYmJkb20nO1xuaW1wb3J0IHsgVG9nZ2xlIH0gZnJvbSAnY29tbW9uJztcblxuY29uc3Qgc2xvd1B1enpsZUlkcyA9IChjdHJsOiBQdXpDdHJsKTogU2V0PHN0cmluZz4gfCB1bmRlZmluZWQgPT4ge1xuICBpZiAoIWN0cmwuZmlsdGVycy5zbG93KCkgfHwgIWN0cmwucnVuLmhpc3RvcnkubGVuZ3RoKSByZXR1cm4gdW5kZWZpbmVkO1xuICBjb25zdCBtZWFuID0gY3RybC5ydW4uaGlzdG9yeS5yZWR1Y2UoKGEsIHIpID0+IGEgKyByLm1pbGxpcywgMCkgLyBjdHJsLnJ1bi5oaXN0b3J5Lmxlbmd0aDtcbiAgY29uc3QgdGhyZXNob2xkID0gbWVhbiAqIDEuNTtcbiAgcmV0dXJuIG5ldyBTZXQoY3RybC5ydW4uaGlzdG9yeS5maWx0ZXIociA9PiByLm1pbGxpcyA+IHRocmVzaG9sZCkubWFwKHIgPT4gci5wdXp6bGUuaWQpKTtcbn07XG5cbmNvbnN0IHRvZ2dsZUJ1dHRvbiA9IChwcm9wOiBUb2dnbGUsIHRpdGxlOiBzdHJpbmcpOiBWTm9kZSA9PlxuICBoKFxuICAgICdidXR0b24ucHV6LWhpc3RvcnlfX2ZpbHRlci5idXR0b24nLFxuICAgIHtcbiAgICAgIGNsYXNzOiB7XG4gICAgICAgIGFjdGl2ZTogcHJvcCgpLFxuICAgICAgICAnYnV0dG9uLWVtcHR5JzogIXByb3AsXG4gICAgICB9LFxuICAgICAgaG9vazogb25JbnNlcnQoZSA9PiBlLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgcHJvcC50b2dnbGUpKSxcbiAgICB9LFxuICAgIHRpdGxlXG4gICk7XG5cbmV4cG9ydCBkZWZhdWx0IChjdHJsOiBQdXpDdHJsKTogVk5vZGUgPT4ge1xuICBjb25zdCBzbG93SWRzID0gc2xvd1B1enpsZUlkcyhjdHJsKSxcbiAgICBmaWx0ZXJzID0gY3RybC5maWx0ZXJzLFxuICAgIG5vYXJnID0gY3RybC50cmFucy5ub2FyZyxcbiAgICBidXR0b25zOiBWTm9kZVtdID0gW1xuICAgICAgdG9nZ2xlQnV0dG9uKGZpbHRlcnMuZmFpbCwgbm9hcmcoJ2ZhaWxlZFB1enpsZXMnKSksXG4gICAgICB0b2dnbGVCdXR0b24oZmlsdGVycy5zbG93LCBub2FyZygnc2xvd1B1enpsZXMnKSksXG4gICAgXTtcbiAgaWYgKGZpbHRlcnMuc2tpcCkgYnV0dG9ucy5wdXNoKHRvZ2dsZUJ1dHRvbihmaWx0ZXJzLnNraXAsIG5vYXJnKCdza2lwcGVkUHV6emxlJykpKTtcbiAgcmV0dXJuIGgoJ2Rpdi5wdXotaGlzdG9yeS5ib3guYm94LXBhZCcsIFtcbiAgICBoKCdkaXYuYm94X190b3AnLCBbaCgnaDInLCBjdHJsLnRyYW5zKCdwdXp6bGVzUGxheWVkJykpLCBoKCdkaXYuYm94X190b3BfX2FjdGlvbnMnLCBidXR0b25zKV0pLFxuICAgIGgoXG4gICAgICAnZGl2LnB1ei1oaXN0b3J5X19yb3VuZHMnLFxuICAgICAgY3RybC5ydW4uaGlzdG9yeVxuICAgICAgICAuZmlsdGVyKFxuICAgICAgICAgIHIgPT5cbiAgICAgICAgICAgICghci53aW4gfHwgIWZpbHRlcnMuZmFpbCgpKSAmJlxuICAgICAgICAgICAgKCFzbG93SWRzIHx8IHNsb3dJZHMuaGFzKHIucHV6emxlLmlkKSkgJiZcbiAgICAgICAgICAgICghZmlsdGVycy5za2lwIHx8ICFmaWx0ZXJzLnNraXAoKSB8fCByLnB1enpsZS5pZCA9PT0gY3RybC5ydW4uc2tpcElkKVxuICAgICAgICApXG4gICAgICAgIC5tYXAocm91bmQgPT5cbiAgICAgICAgICBoKFxuICAgICAgICAgICAgJ2Rpdi5wdXotaGlzdG9yeV9fcm91bmQnLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBrZXk6IHJvdW5kLnB1enpsZS5pZCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBbXG4gICAgICAgICAgICAgIGgoJ2EucHV6LWhpc3RvcnlfX3JvdW5kX19wdXp6bGUubWluaS1ib2FyZC5jZy13cmFwLmlzMmQnLCB7XG4gICAgICAgICAgICAgICAgYXR0cnM6IHtcbiAgICAgICAgICAgICAgICAgIGhyZWY6IGAvdHJhaW5pbmcvJHtyb3VuZC5wdXp6bGUuaWR9YCxcbiAgICAgICAgICAgICAgICAgIHRhcmdldDogJ19ibGFuaycsXG4gICAgICAgICAgICAgICAgICByZWw6ICdub29wZW5lcicsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBob29rOiBvbkluc2VydChlID0+IHtcbiAgICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IENoZXNzLmZyb21TZXR1cChwYXJzZUZlbihyb3VuZC5wdXp6bGUuZmVuKS51bndyYXAoKSkudW53cmFwKCk7XG4gICAgICAgICAgICAgICAgICBjb25zdCB1Y2kgPSByb3VuZC5wdXp6bGUubGluZS5zcGxpdCgnICcpWzBdO1xuICAgICAgICAgICAgICAgICAgcG9zLnBsYXkocGFyc2VVY2kodWNpKSEpO1xuICAgICAgICAgICAgICAgICAgbWluaUJvYXJkLmluaXRXaXRoKGUsIG1ha2VGZW4ocG9zLnRvU2V0dXAoKSksIHBvcy50dXJuLCB1Y2kpO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgaCgnc3Bhbi5wdXotaGlzdG9yeV9fcm91bmRfX21ldGEnLCBbXG4gICAgICAgICAgICAgICAgaCgnc3Bhbi5wdXotaGlzdG9yeV9fcm91bmRfX3Jlc3VsdCcsIFtcbiAgICAgICAgICAgICAgICAgIGgocm91bmQud2luID8gJ2dvb2QnIDogJ2JhZCcsIE1hdGgucm91bmQocm91bmQubWlsbGlzIC8gMTAwMCkgKyAncycpLFxuICAgICAgICAgICAgICAgICAgaCgncmF0aW5nJywgcm91bmQucHV6emxlLnJhdGluZyksXG4gICAgICAgICAgICAgICAgXSksXG4gICAgICAgICAgICAgICAgaCgnc3Bhbi5wdXotaGlzdG9yeV9fcm91bmRfX2lkJywgJyMnICsgcm91bmQucHV6emxlLmlkKSxcbiAgICAgICAgICAgICAgXSksXG4gICAgICAgICAgICBdXG4gICAgICAgICAgKVxuICAgICAgICApXG4gICAgKSxcbiAgXSk7XG59O1xuIl19