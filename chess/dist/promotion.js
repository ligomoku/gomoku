import { h } from 'snabbdom';
import * as Prefs from 'common/prefs';
import { bind, onInsert } from 'common/snabbdom';
import * as cgUtil from 'chessground/util';
const PROMOTABLE_ROLES = ['queen', 'knight', 'rook', 'bishop'];
export function promote(g, key, role) {
    const piece = g.state.pieces.get(key);
    if (piece && piece.role == 'pawn') {
        g.setPieces(new Map([
            [
                key,
                {
                    color: piece.color,
                    role,
                    promoted: true,
                },
            ],
        ]));
    }
}
export class PromotionCtrl {
    constructor(withGround, onCancel, redraw, autoQueenPref = Prefs.AutoQueen.Never) {
        this.withGround = withGround;
        this.onCancel = onCancel;
        this.redraw = redraw;
        this.autoQueenPref = autoQueenPref;
        this.start = (orig, dest, callback, meta, forceAutoQueen = false) => this.withGround(g => {
            const premovePiece = g.state.pieces.get(orig);
            const piece = premovePiece || g.state.pieces.get(dest);
            if ((piece === null || piece === void 0 ? void 0 : piece.role) == 'pawn' &&
                ((dest[1] == '8' && g.state.turnColor == 'black') || (dest[1] == '1' && g.state.turnColor == 'white'))) {
                if (this.prePromotionRole && (meta === null || meta === void 0 ? void 0 : meta.premove)) {
                    this.doPromote({ orig, dest, callback }, this.prePromotionRole);
                    return true;
                }
                if (!(meta === null || meta === void 0 ? void 0 : meta.ctrlKey) &&
                    !this.promoting &&
                    (this.autoQueenPref === Prefs.AutoQueen.Always ||
                        (this.autoQueenPref === Prefs.AutoQueen.OnPremove && premovePiece) ||
                        forceAutoQueen)) {
                    if (premovePiece)
                        this.setPrePromotion(dest, 'queen');
                    else
                        this.doPromote({ orig, dest, callback }, 'queen');
                    return true;
                }
                this.promoting = { orig, dest, pre: !!premovePiece, callback };
                this.redraw();
                return true;
            }
            return false;
        }) || false;
        this.cancel = () => {
            this.cancelPrePromotion();
            if (this.promoting) {
                this.promoting = undefined;
                this.onCancel();
                this.redraw();
            }
        };
        this.cancelPrePromotion = () => {
            if (this.prePromotionRole) {
                this.withGround(g => g.setAutoShapes([]));
                this.prePromotionRole = undefined;
                this.redraw();
            }
        };
        this.view = (antichess) => {
            const promoting = this.promoting;
            if (!promoting)
                return;
            return (this.withGround(g => this.renderPromotion(promoting.dest, antichess ? PROMOTABLE_ROLES.concat('king') : PROMOTABLE_ROLES, cgUtil.opposite(g.state.turnColor), g.state.orientation)) || null);
        };
    }
    finish(role) {
        const promoting = this.promoting;
        if (promoting) {
            this.promoting = undefined;
            if (promoting.pre)
                this.setPrePromotion(promoting.dest, role);
            else
                this.doPromote(promoting, role);
            this.redraw();
        }
    }
    doPromote(promoting, role) {
        this.withGround(g => promote(g, promoting.dest, role));
        promoting.callback(promoting.orig, promoting.dest, role);
    }
    setPrePromotion(dest, role) {
        this.prePromotionRole = role;
        this.withGround(g => g.setAutoShapes([
            {
                orig: dest,
                piece: {
                    color: cgUtil.opposite(g.state.turnColor),
                    role,
                    opacity: 0.8,
                },
                brush: '',
            },
        ]));
    }
    renderPromotion(dest, pieces, color, orientation) {
        let left = (7 - cgUtil.key2pos(dest)[0]) * 12.5;
        if (orientation === 'white')
            left = 87.5 - left;
        const vertical = color === orientation ? 'top' : 'bottom';
        return h('div#promotion-choice.' + vertical, {
            hook: onInsert(el => {
                el.addEventListener('click', this.cancel);
                el.oncontextmenu = () => false;
            }),
        }, pieces.map((serverRole, i) => {
            const top = (color === orientation ? i : 7 - i) * 12.5;
            return h('square', {
                attrs: {
                    style: 'top: ' + top + '%;left: ' + left + '%',
                },
                hook: bind('click', e => {
                    e.stopPropagation();
                    this.finish(serverRole);
                }),
            }, [h('piece.' + serverRole + '.' + color)]);
        }));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvbW90aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3Byb21vdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsQ0FBQyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQzdCLE9BQU8sS0FBSyxLQUFLLE1BQU0sY0FBYyxDQUFDO0FBQ3RDLE9BQU8sRUFBYyxJQUFJLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFHN0QsT0FBTyxLQUFLLE1BQU0sTUFBTSxrQkFBa0IsQ0FBQztBQVkzQyxNQUFNLGdCQUFnQixHQUFjLENBQUMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUM7QUFFMUUsTUFBTSxVQUFVLE9BQU8sQ0FBQyxDQUFRLEVBQUUsR0FBUSxFQUFFLElBQWE7SUFDdkQsTUFBTSxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3RDLElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxJQUFJLElBQUksTUFBTSxFQUFFO1FBQ2pDLENBQUMsQ0FBQyxTQUFTLENBQ1QsSUFBSSxHQUFHLENBQUM7WUFDTjtnQkFDRSxHQUFHO2dCQUNIO29CQUNFLEtBQUssRUFBRSxLQUFLLENBQUMsS0FBSztvQkFDbEIsSUFBSTtvQkFDSixRQUFRLEVBQUUsSUFBSTtpQkFDZjthQUNGO1NBQ0YsQ0FBQyxDQUNILENBQUM7S0FDSDtBQUNILENBQUM7QUFFRCxNQUFNLE9BQU8sYUFBYTtJQUl4QixZQUNVLFVBQTZELEVBQzdELFFBQW9CLEVBQ3BCLE1BQWtCLEVBQ2xCLGdCQUFpQyxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUs7UUFIdEQsZUFBVSxHQUFWLFVBQVUsQ0FBbUQ7UUFDN0QsYUFBUSxHQUFSLFFBQVEsQ0FBWTtRQUNwQixXQUFNLEdBQU4sTUFBTSxDQUFZO1FBQ2xCLGtCQUFhLEdBQWIsYUFBYSxD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SyxDQUFDO1lBQ2pDLENBQUMsQ0FBQztTQUNILEVBQ0QsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFVBQVUsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUMzQixNQUFNLEdBQUcsR0FBRyxDQUFDLEtBQUssS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQztZQUN2RCxPQUFPLENBQUMsQ0FDTixRQUFRLEVBQ1I7Z0JBQ0UsS0FBSyxFQUFFO29CQUNMLEtBQUssRUFBRSxPQUFPLEdBQUcsR0FBRyxHQUFHLFVBQVUsR0FBRyxJQUFJLEdBQUcsR0FBRztpQkFDL0M7Z0JBQ0QsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLEVBQUU7b0JBQ3RCLENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQztvQkFDcEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFDMUIsQ0FBQyxDQUFDO2FBQ0gsRUFDRCxDQUFDLENBQUMsQ0FBQyxRQUFRLEdBQUcsVUFBVSxHQUFHLEdBQUcsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUN6QyxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGggfSBmcm9tICdzbmFiYmRvbSc7XG5pbXBvcnQgKiBhcyBQcmVmcyBmcm9tICdjb21tb24vcHJlZnMnO1xuaW1wb3J0IHsgTWF5YmVWTm9kZSwgYmluZCwgb25JbnNlcnQgfSBmcm9tICdjb21tb24vc25hYmJkb20nO1xuaW1wb3J0IHsgQXBpIGFzIENnQXBpIH0gZnJvbSAnY2hlc3Nncm91bmQvYXBpJztcbmltcG9ydCB7IERyYXdTaGFwZSB9IGZyb20gJ2NoZXNzZ3JvdW5kL2RyYXcnO1xuaW1wb3J0ICogYXMgY2dVdGlsIGZyb20gJ2NoZXNzZ3JvdW5kL3V0aWwnO1xuaW1wb3J0ICogYXMgY2cgZnJvbSAnY2hlc3Nncm91bmQvdHlwZXMnO1xuXG5leHBvcnQgdHlwZSBDYWxsYmFjayA9IChvcmlnOiBLZXksIGRlc3Q6IEtleSwgcm9sZTogY2cuUm9sZSkgPT4gdm9pZDtcblxuaW50ZXJmYWNlIFByb21vdGluZyB7XG4gIG9yaWc6IEtleTtcbiAgZGVzdDogS2V5O1xuICBwcmU6IGJvb2xlYW47XG4gIGNhbGxiYWNrOiBDYWxsYmFjaztcbn1cblxuY29uc3QgUFJPTU9UQUJMRV9ST0xFUzogY2cuUm9sZVtdID0gWydxdWVlbicsICdrbmlnaHQnLCAncm9vaycsICdiaXNob3AnXTtcblxuZXhwb3J0IGZ1bmN0aW9uIHByb21vdGUoZzogQ2dBcGksIGtleTogS2V5LCByb2xlOiBjZy5Sb2xlKTogdm9pZCB7XG4gIGNvbnN0IHBpZWNlID0gZy5zdGF0ZS5waWVjZXMuZ2V0KGtleSk7XG4gIGlmIChwaWVjZSAmJiBwaWVjZS5yb2xlID09ICdwYXduJykge1xuICAgIGcuc2V0UGllY2VzKFxuICAgICAgbmV3IE1hcChbXG4gICAgICAgIFtcbiAgICAgICAgICBrZXksXG4gICAgICAgICAge1xuICAgICAgICAgICAgY29sb3I6IHBpZWNlLmNvbG9yLFxuICAgICAgICAgICAgcm9sZSxcbiAgICAgICAgICAgIHByb21vdGVkOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICBdKVxuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFByb21vdGlvbkN0cmwge1xuICBwcml2YXRlIHByb21vdGluZz86IFByb21vdGluZztcbiAgcHJpdmF0ZSBwcmVQcm9tb3Rpb25Sb2xlPzogY2cuUm9sZTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHdpdGhHcm91bmQ6IDxBPihmOiAoY2c6IENnQXBpKSA9PiBBKSA9PiBBIHwgZmFsc2UgfCB1bmRlZmluZWQsXG4gICAgcHJpdmF0ZSBvbkNhbmNlbDogKCkgPT4gdm9pZCxcbiAgICBwcml2YXRlIHJlZHJhdzogKCkgPT4gdm9pZCxcbiAgICBwcml2YXRlIGF1dG9RdWVlblByZWY6IFByZWZzLkF1dG9RdWVlbiA9IFByZWZzLkF1dG9RdWVlbi5OZXZlclxuICApIHt9XG5cbiAgc3RhcnQgPSAob3JpZzogS2V5LCBkZXN0OiBLZXksIGNhbGxiYWNrOiBDYWxsYmFjaywgbWV0YT86IGNnLk1vdmVNZXRhZGF0YSwgZm9yY2VBdXRvUXVlZW4gPSBmYWxzZSk6IGJvb2xlYW4gPT5cbiAgICB0aGlzLndpdGhHcm91bmQoZyA9PiB7XG4gICAgICBjb25zdCBwcmVtb3ZlUGllY2UgPSBnLnN0YXRlLnBpZWNlcy5nZXQob3JpZyk7XG4gICAgICBjb25zdCBwaWVjZSA9IHByZW1vdmVQaWVjZSB8fCBnLnN0YXRlLnBpZWNlcy5nZXQoZGVzdCk7XG4gICAgICBpZiAoXG4gICAgICAgIHBpZWNlPy5yb2xlID09ICdwYXduJyAmJlxuICAgICAgICAoKGRlc3RbMV0gPT0gJzgnICYmIGcuc3RhdGUudHVybkNvbG9yID09ICdibGFjaycpIHx8IChkZXN0WzFdID09ICcxJyAmJiBnLnN0YXRlLnR1cm5Db2xvciA9PSAnd2hpdGUnKSlcbiAgICAgICkge1xuICAgICAgICBpZiAodGhpcy5wcmVQcm9tb3Rpb25Sb2xlICYmIG1ldGE/LnByZW1vdmUpIHtcbiAgICAgICAgICB0aGlzLmRvUHJvbW90ZSh7IG9yaWcsIGRlc3QsIGNhbGxiYWNrIH0sIHRoaXMucHJlUHJvbW90aW9uUm9sZSk7XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFxuICAgICAgICAgICFtZXRhPy5jdHJsS2V5ICYmXG4gICAgICAgICAgIXRoaXMucHJvbW90aW5nICYmXG4gICAgICAgICAgKHRoaXMuYXV0b1F1ZWVuUHJlZiA9PT0gUHJlZnMuQXV0b1F1ZWVuLkFsd2F5cyB8fFxuICAgICAgICAgICAgKHRoaXMuYXV0b1F1ZWVuUHJlZiA9PT0gUHJlZnMuQXV0b1F1ZWVuLk9uUHJlbW92ZSAmJiBwcmVtb3ZlUGllY2UpIHx8XG4gICAgICAgICAgICBmb3JjZUF1dG9RdWVlbilcbiAgICAgICAgKSB7XG4gICAgICAgICAgaWYgKHByZW1vdmVQaWVjZSkgdGhpcy5zZXRQcmVQcm9tb3Rpb24oZGVzdCwgJ3F1ZWVuJyk7XG4gICAgICAgICAgZWxzZSB0aGlzLmRvUHJvbW90ZSh7IG9yaWcsIGRlc3QsIGNhbGxiYWNrIH0sICdxdWVlbicpO1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucHJvbW90aW5nID0geyBvcmlnLCBkZXN0LCBwcmU6ICEhcHJlbW92ZVBpZWNlLCBjYWxsYmFjayB9O1xuICAgICAgICB0aGlzLnJlZHJhdygpO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9KSB8fCBmYWxzZTtcblxuICBjYW5jZWwgPSAoKTogdm9pZCA9PiB7XG4gICAgdGhpcy5jYW5jZWxQcmVQcm9tb3Rpb24oKTtcbiAgICBpZiAodGhpcy5wcm9tb3RpbmcpIHtcbiAgICAgIHRoaXMucHJvbW90aW5nID0gdW5kZWZpbmVkO1xuICAgICAgdGhpcy5vbkNhbmNlbCgpO1xuICAgICAgdGhpcy5yZWRyYXcoKTtcbiAgICB9XG4gIH07XG5cbiAgY2FuY2VsUHJlUHJvbW90aW9uID0gKCk6IHZvaWQgPT4ge1xuICAgIGlmICh0aGlzLnByZVByb21vdGlvblJvbGUpIHtcbiAgICAgIHRoaXMud2l0aEdyb3VuZChnID0+IGcuc2V0QXV0b1NoYXBlcyhbXSkpO1xuICAgICAgdGhpcy5wcmVQcm9tb3Rpb25Sb2xlID0gdW5kZWZpbmVkO1xuICAgICAgdGhpcy5yZWRyYXcoKTtcbiAgICB9XG4gIH07XG5cbiAgdmlldyA9IChhbnRpY2hlc3M/OiBib29sZWFuKTogTWF5YmVWTm9kZSA9PiB7XG4gICAgY29uc3QgcHJvbW90aW5nID0gdGhpcy5wcm9tb3Rpbmc7XG4gICAgaWYgKCFwcm9tb3RpbmcpIHJldHVybjtcbiAgICByZXR1cm4gKFxuICAgICAgdGhpcy53aXRoR3JvdW5kKGcgPT5cbiAgICAgICAgdGhpcy5yZW5kZXJQcm9tb3Rpb24oXG4gICAgICAgICAgcHJvbW90aW5nLmRlc3QsXG4gICAgICAgICAgYW50aWNoZXNzID8gUFJPTU9UQUJMRV9ST0xFUy5jb25jYXQoJ2tpbmcnKSA6IFBST01PVEFCTEVfUk9MRVMsXG4gICAgICAgICAgY2dVdGlsLm9wcG9zaXRlKGcuc3RhdGUudHVybkNvbG9yKSxcbiAgICAgICAgICBnLnN0YXRlLm9yaWVudGF0aW9uXG4gICAgICAgIClcbiAgICAgICkgfHwgbnVsbFxuICAgICk7XG4gIH07XG5cbiAgcHJpdmF0ZSBmaW5pc2gocm9sZTogY2cuUm9sZSk6IHZvaWQge1xuICAgIGNvbnN0IHByb21vdGluZyA9IHRoaXMucHJvbW90aW5nO1xuICAgIGlmIChwcm9tb3RpbmcpIHtcbiAgICAgIHRoaXMucHJvbW90aW5nID0gdW5kZWZpbmVkO1xuICAgICAgaWYgKHByb21vdGluZy5wcmUpIHRoaXMuc2V0UHJlUHJvbW90aW9uKHByb21vdGluZy5kZXN0LCByb2xlKTtcbiAgICAgIGVsc2UgdGhpcy5kb1Byb21vdGUocHJvbW90aW5nLCByb2xlKTtcbiAgICAgIHRoaXMucmVkcmF3KCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBkb1Byb21vdGUocHJvbW90aW5nOiBPbWl0PFByb21vdGluZywgJ3ByZSc+LCByb2xlOiBjZy5Sb2xlKTogdm9pZCB7XG4gICAgdGhpcy53aXRoR3JvdW5kKGcgPT4gcHJvbW90ZShnLCBwcm9tb3RpbmcuZGVzdCwgcm9sZSkpO1xuICAgIHByb21vdGluZy5jYWxsYmFjayhwcm9tb3Rpbmcub3JpZywgcHJvbW90aW5nLmRlc3QsIHJvbGUpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRQcmVQcm9tb3Rpb24oZGVzdDogY2cuS2V5LCByb2xlOiBjZy5Sb2xlKTogdm9pZCB7XG4gICAgdGhpcy5wcmVQcm9tb3Rpb25Sb2xlID0gcm9sZTtcbiAgICB0aGlzLndpdGhHcm91bmQoZyA9PlxuICAgICAgZy5zZXRBdXRvU2hhcGVzKFtcbiAgICAgICAge1xuICAgICAgICAgIG9yaWc6IGRlc3QsXG4gICAgICAgICAgcGllY2U6IHtcbiAgICAgICAgICAgIGNvbG9yOiBjZ1V0aWwub3Bwb3NpdGUoZy5zdGF0ZS50dXJuQ29sb3IpLFxuICAgICAgICAgICAgcm9sZSxcbiAgICAgICAgICAgIG9wYWNpdHk6IDAuOCxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGJydXNoOiAnJyxcbiAgICAgICAgfSBhcyBEcmF3U2hhcGUsXG4gICAgICBdKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHJlbmRlclByb21vdGlvbihkZXN0OiBLZXksIHBpZWNlczogY2cuUm9sZVtdLCBjb2xvcjogQ29sb3IsIG9yaWVudGF0aW9uOiBDb2xvcik6IE1heWJlVk5vZGUge1xuICAgIGxldCBsZWZ0ID0gKDcgLSBjZ1V0aWwua2V5MnBvcyhkZXN0KVswXSkgKiAxMi41O1xuICAgIGlmIChvcmllbnRhdGlvbiA9PT0gJ3doaXRlJykgbGVmdCA9IDg3LjUgLSBsZWZ0O1xuXG4gICAgY29uc3QgdmVydGljYWwgPSBjb2xvciA9PT0gb3JpZW50YXRpb24gPyAndG9wJyA6ICdib3R0b20nO1xuXG4gICAgcmV0dXJuIGgoXG4gICAgICAnZGl2I3Byb21vdGlvbi1jaG9pY2UuJyArIHZlcnRpY2FsLFxuICAgICAge1xuICAgICAgICBob29rOiBvbkluc2VydChlbCA9PiB7XG4gICAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGlzLmNhbmNlbCk7XG4gICAgICAgICAgZWwub25jb250ZXh0bWVudSA9ICgpID0+IGZhbHNlO1xuICAgICAgICB9KSxcbiAgICAgIH0sXG4gICAgICBwaWVjZXMubWFwKChzZXJ2ZXJSb2xlLCBpKSA9PiB7XG4gICAgICAgIGNvbnN0IHRvcCA9IChjb2xvciA9PT0gb3JpZW50YXRpb24gPyBpIDogNyAtIGkpICogMTIuNTtcbiAgICAgICAgcmV0dXJuIGgoXG4gICAgICAgICAgJ3NxdWFyZScsXG4gICAgICAgICAge1xuICAgICAgICAgICAgYXR0cnM6IHtcbiAgICAgICAgICAgICAgc3R5bGU6ICd0b3A6ICcgKyB0b3AgKyAnJTtsZWZ0OiAnICsgbGVmdCArICclJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBob29rOiBiaW5kKCdjbGljaycsIGUgPT4ge1xuICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICB0aGlzLmZpbmlzaChzZXJ2ZXJSb2xlKTtcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgW2goJ3BpZWNlLicgKyBzZXJ2ZXJSb2xlICsgJy4nICsgY29sb3IpXVxuICAgICAgICApO1xuICAgICAgfSlcbiAgICApO1xuICB9XG59XG4iXX0=