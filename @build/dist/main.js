"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.errorMark = exports.codes = exports.env = exports.colors = exports.lines = exports.init = exports.main = void 0;
const ps = __importStar(require("node:process"));
const path = __importStar(require("node:path"));
const fs = __importStar(require("node:fs"));
const build_1 = require("./build");
function main() {
    const configPath = path.resolve(__dirname, '../build-config.json');
    const config = fs.existsSync(configPath) ? JSON.parse(fs.readFileSync(configPath, 'utf8')) : {};
    if (ps.argv.includes('--tsc') || ps.argv.includes('--sass') || ps.argv.includes('--esbuild')) {
        // cli args override json
        config.sass = ps.argv.includes('--sass');
        config.tsc = ps.argv.includes('--tsc');
        config.esbuild = ps.argv.includes('--esbuild');
    }
    if (ps.argv.includes('--no-color'))
        config.color = false;
    if (ps.argv.includes('--no-time'))
        config.time = false;
    if (ps.argv.includes('--no-context'))
        config.ctx = false;
    init(path.resolve(__dirname, '../../..'), config);
    if (ps.argv.includes('--help') || ps.argv.includes('-h')) {
        console.log(fs.readFileSync(path.resolve(__dirname, '../readme'), 'utf8'));
        return;
    }
    exports.env.watch = ps.argv.includes('--watch') || ps.argv.includes('-w');
    exports.env.prod = ps.argv.includes('--prod') || ps.argv.includes('-p');
    if (exports.env.prod && exports.env.watch) {
        exports.env.error('You cannot watch prod builds! Think of the children');
        return;
    }
    (0, build_1.build)(ps.argv.slice(2).filter(x => !x.startsWith('-')));
}
exports.main = main;
function init(root, opts) {
    exports.env.rootDir = root;
    exports.env.opts = opts;
    if (exports.env.opts.color === undefined) {
        exports.env.opts.color = {
            build: 'green',
            sass: 'magenta',
            tsc: 'yellow',
            esbuild: 'blue',
        };
    }
    if (exports.env.opts.sass === false)
        exports.env.exitCode.set('sass', false);
    if (exports.env.opts.tsc === false)
        exports.env.exitCode.set('tsc', false);
    if (exports.env.opts.esbuild === false)
        exports.env.exitCode.set('esbuild', false);
}
exports.init = init;
const lines = (s) => s.split(/[\n\r\f]+/).filter(x => x.trim());
exports.lines = lines;
const colorLines = (text, code) => (0, exports.lines)(text)
    .map(t => { var _a; return (((_a = exports.env.opts) === null || _a === void 0 ? void 0 : _a.color) !== false ? escape(t, code) : t); })
    .join('\n');
exports.colors = {
    red: (text) => colorLines(text, exports.codes.red),
    green: (text) => colorLines(text, exports.codes.green),
    yellow: (text) => colorLines(text, exports.codes.yellow),
    blue: (text) => colorLines(text, exports.codes.blue),
    magenta: (text) => colorLines(text, exports.codes.magenta),
    cyan: (text) => colorLines(text, exports.codes.cyan),
    grey: (text) => colorLines(text, exports.codes.grey),
    black: (text) => colorLines(text, exports.codes.black),
    error: (text) => colorLines(text, exports.codes.error),
    warn: (text) => colorLines(text, exports.codes.warn),
    good: (text) => colorLines(text, exports.codes.green + ';1'),
    cyanBold: (text) => colorLines(text, exports.codes.cyan + ';1'),
};
class Env {
    constructor() {
        this.watch = false;
        this.prod = false;
        this.exitCode = new Map();
        this.startTime = Date.now();
    }
    get sass() {
        return this.exitCode.get('sass') !== false;
    }
    get tsc() {
        return this.exitCode.get('tsc') !== false;
    }
    get esbuild() {
        return this.exitCode.get('esbuild') !== false;
    }
    get uiDir() {
        return path.join(this.rootDir, 'ui');
    }
    get outDir() {
        return path.join(this.rootDir, 'public');
    }
    get cssDir() {
        return path.join(this.outDir, 'css');
    }
    get jsDir() {
        return path.join(this.outDir, 'compiled');
    }
    get buildDir() {
        return path.join(this.uiDir, '@build');
    }
    warn(d, ctx = 'build') {
        this.log(d, { ctx: ctx, warn: true });
    }
    error(d, ctx = 'build') {
        this.log(d, { ctx: ctx, error: true });
    }
    good(ctx = 'build') {
        this.log(exports.colors.good('No errors') + exports.env.watch ? ` - ${exports.colors.grey('Watching')}...` : '', { ctx: ctx });
    }
    log(d, { ctx = 'build', error = false, warn = false } = {}) {
        let text = typeof d === 'string'
            ? d
            : d instanceof Buffer
                ? d.toString('utf8')
                : Array.isArray(d)
                    ? d.join('\n')
                    : JSON.stringify(d, undefined, 2);
        const esc = this.opts.color !== false ? escape : (text, _) => text;
        if (this.opts.color === false)
            text = stripColorEscapes(text);
        const prefix = ((this.opts.time === false ? '' : prettyTime()) +
            (!ctx || this.opts.ctx === false ? '' : `[${esc(ctx, colorForCtx(ctx, this.opts.color))}] `)).trim();
        (0, exports.lines)(text).forEach(line => console.log(`${prefix ? prefix + ' - ' : ''}${error ? esc(line, exports.codes.error) : warn ? esc(line, exports.codes.warn) : line}`));
    }
    done(code, ctx) {
        this.exitCode.set(ctx, code);
        const err = [...this.exitCode.values()].find(x => x);
        const allDone = this.exitCode.size === 3;
        this.log(`${code === 0 ? 'Done' : exports.colors.red('Failed')}` + (this.watch ? ` - ${exports.colors.grey('Watching')}...` : ''), {
            ctx: ctx,
        });
        if (allDone) {
            if (!err)
                (0, build_1.postBuild)();
            if (this.startTime && !err)
                this.log(`Done in ${exports.colors.green((Date.now() - this.startTime) / 1000 + '')}s`);
            this.startTime = undefined; // it's pointless to time subsequent builds, they are too fast
            if (!exports.env.watch) {
                process.exitCode = err || 0;
            }
        }
    }
}
exports.env = new Env();
exports.codes = {
    black: '30',
    red: '31',
    green: '32',
    yellow: '33',
    blue: '34',
    magenta: '35',
    cyan: '36',
    grey: '90',
    error: '31;41',
    warn: '33;43',
};
const colorForCtx = (ctx, color) => color && ctx in color && color[ctx] in exports.codes ? exports.codes[color[ctx]] : exports.codes.grey;
const escape = (text, code) => `\x1b[${code}m${stripColorEscapes(text)}\x1b[0m`;
const pad2 = (n) => (n < 10 ? `0${n}` : `${n}`);
function stripColorEscapes(text) {
    // eslint-disable-next-line no-control-regex
    return text.replace(/\x1b\[[0-9;]*m/, '');
}
exports.errorMark = exports.colors.red('âœ˜ ') + exports.colors.error('[ERROR]');
function prettyTime() {
    const now = new Date();
    return `${pad2(now.getHours())}:${pad2(now.getMinutes())}:${pad2(now.getSeconds())} `;
}
main();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsaURBQW1DO0FBQ25DLGdEQUFrQztBQUNsQyw0Q0FBOEI7QUFFOUIsbUNBQTJDO0FBRTNDLFNBQWdCLElBQUk7SUFDbEIsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsc0JBQXNCLENBQUMsQ0FBQztJQUNuRSxNQUFNLE1BQU0sR0FBYyxFQUFFLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUUzRyxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxFQUFFO1FBQzVGLHlCQUF5QjtRQUN6QixNQUFNLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3pDLE1BQU0sQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDdkMsTUFBTSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQztLQUNoRDtJQUNELElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDO1FBQUUsTUFBTSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7SUFDekQsSUFBSSxFQUFFLENBQUMs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QUFFLEVBQUUsQ0FDaEQsSUFBQSxhQUFLLEVBQUMsSUFBSSxDQUFDO0tBQ1IsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLFdBQUMsT0FBQSxDQUFDLENBQUEsTUFBQSxXQUFHLENBQUMsSUFBSSwwQ0FBRSxLQUFLLE1BQUssS0FBSyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQSxFQUFBLENBQUM7S0FDM0QsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBRUgsUUFBQSxNQUFNLEdBQUc7SUFDcEIsR0FBRyxFQUFFLENBQUMsSUFBWSxFQUFVLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLGFBQUssQ0FBQyxHQUFHLENBQUM7SUFDMUQsS0FBSyxFQUFFLENBQUMsSUFBWSxFQUFVLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLGFBQUssQ0FBQyxLQUFLLENBQUM7SUFDOUQsTUFBTSxFQUFFLENBQUMsSUFBWSxFQUFVLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLGFBQUssQ0FBQyxNQUFNLENBQUM7SUFDaEUsSUFBSSxFQUFFLENBQUMsSUFBWSxFQUFVLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLGFBQUssQ0FBQyxJQUFJLENBQUM7SUFDNUQsT0FBTyxFQUFFLENBQUMsSUFBWSxFQUFVLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLGFBQUssQ0FBQyxPQUFPLENBQUM7SUFDbEUsSUFBSSxFQUFFLENBQUMsSUFBWSxFQUFVLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLGFBQUssQ0FBQyxJQUFJLENBQUM7SUFDNUQsSUFBSSxFQUFFLENBQUMsSUFBWSxFQUFVLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLGFBQUssQ0FBQyxJQUFJLENBQUM7SUFDNUQsS0FBSyxFQUFFLENBQUMsSUFBWSxFQUFVLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLGFBQUss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QUMsSUFBWSxFQUFFLElBQVksRUFBVSxFQUFFLENBQUMsUUFBUSxJQUFJLElBQUksaUJBQWlCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztBQUV4RyxNQUFNLElBQUksR0FBRyxDQUFDLENBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7QUFFeEQsU0FBUyxpQkFBaUIsQ0FBQyxJQUFZO0lBQ3JDLDRDQUE0QztJQUM1QyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDNUMsQ0FBQztBQUVZLFFBQUEsU0FBUyxHQUFHLGNBQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsY0FBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUVwRSxTQUFTLFVBQVU7SUFDakIsTUFBTSxHQUFHLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUN2QixPQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUMsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxDQUFDLEdBQUcsQ0FBQztBQUN4RixDQUFDO0FBRUQsSUFBSSxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwcyBmcm9tICdub2RlOnByb2Nlc3MnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdub2RlOnBhdGgnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnbm9kZTpmcyc7XG5cbmltcG9ydCB7IGJ1aWxkLCBwb3N0QnVpbGQgfSBmcm9tICcuL2J1aWxkJztcblxuZXhwb3J0IGZ1bmN0aW9uIG1haW4oKSB7XG4gIGNvbnN0IGNvbmZpZ1BhdGggPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vYnVpbGQtY29uZmlnLmpzb24nKTtcbiAgY29uc3QgY29uZmlnOiBCdWlsZE9wdHMgPSBmcy5leGlzdHNTeW5jKGNvbmZpZ1BhdGgpID8gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMoY29uZmlnUGF0aCwgJ3V0ZjgnKSkgOiB7fTtcblxuICBpZiAocHMuYXJndi5pbmNsdWRlcygnLS10c2MnKSB8fCBwcy5hcmd2LmluY2x1ZGVzKCctLXNhc3MnKSB8fCBwcy5hcmd2LmluY2x1ZGVzKCctLWVzYnVpbGQnKSkge1xuICAgIC8vIGNsaSBhcmdzIG92ZXJyaWRlIGpzb25cbiAgICBjb25maWcuc2FzcyA9IHBzLmFyZ3YuaW5jbHVkZXMoJy0tc2FzcycpO1xuICAgIGNvbmZpZy50c2MgPSBwcy5hcmd2LmluY2x1ZGVzKCctLXRzYycpO1xuICAgIGNvbmZpZy5lc2J1aWxkID0gcHMuYXJndi5pbmNsdWRlcygnLS1lc2J1aWxkJyk7XG4gIH1cbiAgaWYgKHBzLmFyZ3YuaW5jbHVkZXMoJy0tbm8tY29sb3InKSkgY29uZmlnLmNvbG9yID0gZmFsc2U7XG4gIGlmIChwcy5hcmd2LmluY2x1ZGVzKCctLW5vLXRpbWUnKSkgY29uZmlnLnRpbWUgPSBmYWxzZTtcbiAgaWYgKHBzLmFyZ3YuaW5jbHVkZXMoJy0tbm8tY29udGV4dCcpKSBjb25maWcuY3R4ID0gZmFsc2U7XG5cbiAgaW5pdChwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vLi4vLi4nKSwgY29uZmlnKTtcblxuICBpZiAocHMuYXJndi5pbmNsdWRlcygnLS1oZWxwJykgfHwgcHMuYXJndi5pbmNsdWRlcygnLWgnKSkge1xuICAgIGNvbnNvbGUubG9nKGZzLnJlYWRGaWxlU3luYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vcmVhZG1lJyksICd1dGY4JykpO1xuICAgIHJldHVybjtcbiAgfVxuICBlbnYud2F0Y2ggPSBwcy5hcmd2LmluY2x1ZGVzKCctLXdhdGNoJykgfHwgcHMuYXJndi5pbmNsdWRlcygnLXcnKTtcbiAgZW52LnByb2QgPSBwcy5hcmd2LmluY2x1ZGVzKCctLXByb2QnKSB8fCBwcy5hcmd2LmluY2x1ZGVzKCctcCcpO1xuICBpZiAoZW52LnByb2QgJiYgZW52LndhdGNoKSB7XG4gICAgZW52LmVycm9yKCdZb3UgY2Fubm90IHdhdGNoIHByb2QgYnVpbGRzISBUaGluayBvZiB0aGUgY2hpbGRyZW4nKTtcbiAgICByZXR1cm47XG4gIH1cbiAgYnVpbGQocHMuYXJndi5zbGljZSgyKS5maWx0ZXIoeCA9PiAheC5zdGFydHNXaXRoKCctJykpKTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBCdWlsZE9wdHMge1xuICBzYXNzPzogYm9vbGVhbjsgLy8gY29tcGlsZSBzY3NzLCBkZWZhdWx0ID0gdHJ1ZVxuICBlc2J1aWxkPzogYm9vbGVhbjsgLy8gYnVuZGxlIHdpdGggZXNidWlsZCwgZGVmYXVsdCA9IHRydWVcbiAgdHNjPzogYm9vbGVhbjsgLy8gdXNlIHRzYyBmb3IgdHlwZSBjaGVja2luZywgZGVmYXVsdCA9IHRydWVcbiAgdGltZT86IGJvb2xlYW47IC8vIHNob3cgdGltZSBpbiBsb2cgc3RhdGVtZW50cywgZGVmYXVsdCA9IHRydWVcbiAgY3R4PzogYm9vbGVhbjsgLy8gc2hvdyBjb250ZXh0ICh0c2MsIHJvbGx1cCwgZXRjKSwgZGVmYXVsdCA9IHRydWVcbiAgY29sb3I/OiBhbnk7IC8vIHNldCBmYWxzZSB0byBkaXNhYmxlIGNvbG9ycywgb3RoZXJ3aXNlIGxlYXZlIHVuZGVmaW5lZFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIExpY2hlc3NNb2R1bGUge1xuICByb290OiBzdHJpbmc7IC8vIGFic29sdXRlIHBhdGggdG8gcGFja2FnZS5qc29uIHBhcmVudGRpciAobW9kdWxlIHJvb3QpXG4gIG5hbWU6IHN0cmluZzsgLy8gZGlybmFtZSBvZiBtb2R1bGUgcm9vdFxuICBwa2c6IGFueTsgLy8gdGhlIGVudGlyZSBwYWNrYWdlLmpzb24gb2JqZWN0XG4gIHByZTogc3RyaW5nW11bXTsgLy8gcHJlLWJ1bmRsZSBidWlsZCBzdGVwcyBmcm9tIHBhY2thZ2UuanNvbiBzY3JpcHRzXG4gIHBvc3Q6IHN0cmluZ1tdW107IC8vIHBvc3QtYnVuZGxlIGJ1aWxkIHN0ZXBzIGZyb20gcGFja2FnZS5qc29uIHNjcmlwdHNcbiAgaGFzVHNjb25maWc/OiBib29sZWFuOyAvLyBmaWxlRXhpc3RzKCd0c2NvbmZpZy5qc29uJylcbiAgYnVuZGxlPzogTGljaGVzc0J1bmRsZVtdOyAvLyBidW5kbGUgdGFyZ2V0cyBmcm9tIHBhY2thZ2UganNvblxuICBjb3B5PzogQ29weVtdOyAvLyBwcmUtYnVuZGxlIGZpbGVzeXN0ZW0gY29waWVzIGZyb20gcGFja2FnZSBqc29uXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29weSB7XG4gIC8vIHNhbWUgYXMgY29weSAtcmYgbGlsYS9ub2RlX21vZHVsZXMvJHtzcmN9IGxpbGEvcHVibGljLyR7ZGVzdH1cbiAgc3JjOiBzdHJpbmcgfCBzdHJpbmdbXTtcbiAgZGVzdDogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIExpY2hlc3NCdW5kbGUge1xuICBpbnB1dDogc3RyaW5nOyAvLyBhYnMgcGF0aCB0byBzb3VyY2VcbiAgb3V0cHV0OiBzdHJpbmc7IC8vIGFicyBwYXRoIHRvIGJ1bmRsZSBkZXN0aW5hdGlvblxufVxuXG5leHBvcnQgZnVuY3Rpb24gaW5pdChyb290OiBzdHJpbmcsIG9wdHM6IEJ1aWxkT3B0cykge1xuICBlbnYucm9vdERpciA9IHJvb3Q7XG4gIGVudi5vcHRzID0gb3B0cztcbiAgaWYgKGVudi5vcHRzLmNvbG9yID09PSB1bmRlZmluZWQpIHtcbiAgICBlbnYub3B0cy5jb2xvciA9IHtcbiAgICAgIGJ1aWxkOiAnZ3JlZW4nLFxuICAgICAgc2FzczogJ21hZ2VudGEnLFxuICAgICAgdHNjOiAneWVsbG93JyxcbiAgICAgIGVzYnVpbGQ6ICdibHVlJyxcbiAgICB9O1xuICB9XG4gIGlmIChlbnYub3B0cy5zYXNzID09PSBmYWxzZSkgZW52LmV4aXRDb2RlLnNldCgnc2FzcycsIGZhbHNlKTtcbiAgaWYgKGVudi5vcHRzLnRzYyA9PT0gZmFsc2UpIGVudi5leGl0Q29kZS5zZXQoJ3RzYycsIGZhbHNlKTtcbiAgaWYgKGVudi5vcHRzLmVzYnVpbGQgPT09IGZhbHNlKSBlbnYuZXhpdENvZGUuc2V0KCdlc2J1aWxkJywgZmFsc2UpO1xufVxuXG5leHBvcnQgY29uc3QgbGluZXMgPSAoczogc3RyaW5nKTogc3RyaW5nW10gPT4gcy5zcGxpdCgvW1xcblxcclxcZl0rLykuZmlsdGVyKHggPT4geC50cmltKCkpO1xuXG5jb25zdCBjb2xvckxpbmVzID0gKHRleHQ6IHN0cmluZywgY29kZTogc3RyaW5nKSA9PlxuICBsaW5lcyh0ZXh0KVxuICAgIC5tYXAodCA9PiAoZW52Lm9wdHM/LmNvbG9yICE9PSBmYWxzZSA/IGVzY2FwZSh0LCBjb2RlKSA6IHQpKVxuICAgIC5qb2luKCdcXG4nKTtcblxuZXhwb3J0IGNvbnN0IGNvbG9ycyA9IHtcbiAgcmVkOiAodGV4dDogc3RyaW5nKTogc3RyaW5nID0+IGNvbG9yTGluZXModGV4dCwgY29kZXMucmVkKSxcbiAgZ3JlZW46ICh0ZXh0OiBzdHJpbmcpOiBzdHJpbmcgPT4gY29sb3JMaW5lcyh0ZXh0LCBjb2Rlcy5ncmVlbiksXG4gIHllbGxvdzogKHRleHQ6IHN0cmluZyk6IHN0cmluZyA9PiBjb2xvckxpbmVzKHRleHQsIGNvZGVzLnllbGxvdyksXG4gIGJsdWU6ICh0ZXh0OiBzdHJpbmcpOiBzdHJpbmcgPT4gY29sb3JMaW5lcyh0ZXh0LCBjb2Rlcy5ibHVlKSxcbiAgbWFnZW50YTogKHRleHQ6IHN0cmluZyk6IHN0cmluZyA9PiBjb2xvckxpbmVzKHRleHQsIGNvZGVzLm1hZ2VudGEpLFxuICBjeWFuOiAodGV4dDogc3RyaW5nKTogc3RyaW5nID0+IGNvbG9yTGluZXModGV4dCwgY29kZXMuY3lhbiksXG4gIGdyZXk6ICh0ZXh0OiBzdHJpbmcpOiBzdHJpbmcgPT4gY29sb3JMaW5lcyh0ZXh0LCBjb2Rlcy5ncmV5KSxcbiAgYmxhY2s6ICh0ZXh0OiBzdHJpbmcpOiBzdHJpbmcgPT4gY29sb3JMaW5lcyh0ZXh0LCBjb2Rlcy5ibGFjayksXG4gIGVycm9yOiAodGV4dDogc3RyaW5nKTogc3RyaW5nID0+IGNvbG9yTGluZXModGV4dCwgY29kZXMuZXJyb3IpLFxuICB3YXJuOiAodGV4dDogc3RyaW5nKTogc3RyaW5nID0+IGNvbG9yTGluZXModGV4dCwgY29kZXMud2FybiksXG4gIGdvb2Q6ICh0ZXh0OiBzdHJpbmcpOiBzdHJpbmcgPT4gY29sb3JMaW5lcyh0ZXh0LCBjb2Rlcy5ncmVlbiArICc7MScpLFxuICBjeWFuQm9sZDogKHRleHQ6IHN0cmluZyk6IHN0cmluZyA9PiBjb2xvckxpbmVzKHRleHQsIGNvZGVzLmN5YW4gKyAnOzEnKSxcbn07XG5cbmNsYXNzIEVudiB7XG4gIHJvb3REaXI6IHN0cmluZzsgLy8gYWJzb2x1dGUgcGF0aCB0byBsaWxhIHByb2plY3Qgcm9vdFxuICBvcHRzOiBCdWlsZE9wdHM7IC8vIGNvbmZpZ3VyZSBsb2dnaW5nIG1vc3RseVxuICB3YXRjaCA9IGZhbHNlO1xuICBwcm9kID0gZmFsc2U7XG4gIGV4aXRDb2RlID0gbmV3IE1hcDwnc2FzcycgfCAndHNjJyB8ICdlc2J1aWxkJywgbnVtYmVyIHwgZmFsc2U+KCk7XG4gIHN0YXJ0VGltZTogbnVtYmVyIHwgdW5kZWZpbmVkID0gRGF0ZS5ub3coKTtcblxuICBnZXQgc2FzcygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5leGl0Q29kZS5nZXQoJ3Nhc3MnKSAhPT0gZmFsc2U7XG4gIH1cbiAgZ2V0IHRzYygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5leGl0Q29kZS5nZXQoJ3RzYycpICE9PSBmYWxzZTtcbiAgfVxuICBnZXQgZXNidWlsZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5leGl0Q29kZS5nZXQoJ2VzYnVpbGQnKSAhPT0gZmFsc2U7XG4gIH1cbiAgZ2V0IHVpRGlyKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHBhdGguam9pbih0aGlzLnJvb3REaXIsICd1aScpO1xuICB9XG4gIGdldCBvdXREaXIoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gcGF0aC5qb2luKHRoaXMucm9vdERpciwgJ3B1YmxpYycpO1xuICB9XG4gIGdldCBjc3NEaXIoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gcGF0aC5qb2luKHRoaXMub3V0RGlyLCAnY3NzJyk7XG4gIH1cbiAgZ2V0IGpzRGlyKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHBhdGguam9pbih0aGlzLm91dERpciwgJ2NvbXBpbGVkJyk7XG4gIH1cbiAgZ2V0IGJ1aWxkRGlyKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHBhdGguam9pbih0aGlzLnVpRGlyLCAnQGJ1aWxkJyk7XG4gIH1cbiAgd2FybihkOiBhbnksIGN0eCA9ICdidWlsZCcpIHtcbiAgICB0aGlzLmxvZyhkLCB7IGN0eDogY3R4LCB3YXJuOiB0cnVlIH0pO1xuICB9XG4gIGVycm9yKGQ6IGFueSwgY3R4ID0gJ2J1aWxkJykge1xuICAgIHRoaXMubG9nKGQsIHsgY3R4OiBjdHgsIGVycm9yOiB0cnVlIH0pO1xuICB9XG4gIGdvb2QoY3R4ID0gJ2J1aWxkJykge1xuICAgIHRoaXMubG9nKGNvbG9ycy5nb29kKCdObyBlcnJvcnMnKSArIGVudi53YXRjaCA/IGAgLSAke2NvbG9ycy5ncmV5KCdXYXRjaGluZycpfS4uLmAgOiAnJywgeyBjdHg6IGN0eCB9KTtcbiAgfVxuICBsb2coZDogYW55LCB7IGN0eCA9ICdidWlsZCcsIGVycm9yID0gZmFsc2UsIHdhcm4gPSBmYWxzZSB9ID0ge30pIHtcbiAgICBsZXQgdGV4dDogc3RyaW5nID1cbiAgICAgIHR5cGVvZiBkID09PSAnc3RyaW5nJ1xuICAgICAgICA/IGRcbiAgICAgICAgOiBkIGluc3RhbmNlb2YgQnVmZmVyXG4gICAgICAgID8gZC50b1N0cmluZygndXRmOCcpXG4gICAgICAgIDogQXJyYXkuaXNBcnJheShkKVxuICAgICAgICA/IGQuam9pbignXFxuJylcbiAgICAgICAgOiBKU09OLnN0cmluZ2lmeShkLCB1bmRlZmluZWQsIDIpO1xuXG4gICAgY29uc3QgZXNjID0gdGhpcy5vcHRzLmNvbG9yICE9PSBmYWxzZSA/IGVzY2FwZSA6ICh0ZXh0OiBzdHJpbmcsIF86IGFueSkgPT4gdGV4dDtcblxuICAgIGlmICh0aGlzLm9wdHMuY29sb3IgPT09IGZhbHNlKSB0ZXh0ID0gc3RyaXBDb2xvckVzY2FwZXModGV4dCk7XG5cbiAgICBjb25zdCBwcmVmaXggPSAoXG4gICAgICAodGhpcy5vcHRzLnRpbWUgPT09IGZhbHNlID8gJycgOiBwcmV0dHlUaW1lKCkpICtcbiAgICAgICghY3R4IHx8IHRoaXMub3B0cy5jdHggPT09IGZhbHNlID8gJycgOiBgWyR7ZXNjKGN0eCwgY29sb3JGb3JDdHgoY3R4LCB0aGlzLm9wdHMuY29sb3IpKX1dIGApXG4gICAgKS50cmltKCk7XG5cbiAgICBsaW5lcyh0ZXh0KS5mb3JFYWNoKGxpbmUgPT5cbiAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICBgJHtwcmVmaXggPyBwcmVmaXggKyAnIC0gJyA6ICcnfSR7ZXJyb3IgPyBlc2MobGluZSwgY29kZXMuZXJyb3IpIDogd2FybiA/IGVzYyhsaW5lLCBjb2Rlcy53YXJuKSA6IGxpbmV9YFxuICAgICAgKVxuICAgICk7XG4gIH1cbiAgZG9uZShjb2RlOiBudW1iZXIsIGN0eDogJ3Nhc3MnIHwgJ3RzYycgfCAnZXNidWlsZCcpOiB2b2lkIHtcbiAgICB0aGlzLmV4aXRDb2RlLnNldChjdHgsIGNvZGUpO1xuICAgIGNvbnN0IGVyciA9IFsuLi50aGlzLmV4aXRDb2RlLnZhbHVlcygpXS5maW5kKHggPT4geCk7XG4gICAgY29uc3QgYWxsRG9uZSA9IHRoaXMuZXhpdENvZGUuc2l6ZSA9PT0gMztcblxuICAgIHRoaXMubG9nKGAke2NvZGUgPT09IDAgPyAnRG9uZScgOiBjb2xvcnMucmVkKCdGYWlsZWQnKX1gICsgKHRoaXMud2F0Y2ggPyBgIC0gJHtjb2xvcnMuZ3JleSgnV2F0Y2hpbmcnKX0uLi5gIDogJycpLCB7XG4gICAgICBjdHg6IGN0eCxcbiAgICB9KTtcblxuICAgIGlmIChhbGxEb25lKSB7XG4gICAgICBpZiAoIWVycikgcG9zdEJ1aWxkKCk7XG4gICAgICBpZiAodGhpcy5zdGFydFRpbWUgJiYgIWVycikgdGhpcy5sb2coYERvbmUgaW4gJHtjb2xvcnMuZ3JlZW4oKERhdGUubm93KCkgLSB0aGlzLnN0YXJ0VGltZSkgLyAxMDAwICsgJycpfXNgKTtcbiAgICAgIHRoaXMuc3RhcnRUaW1lID0gdW5kZWZpbmVkOyAvLyBpdCdzIHBvaW50bGVzcyB0byB0aW1lIHN1YnNlcXVlbnQgYnVpbGRzLCB0aGV5IGFyZSB0b28gZmFzdFxuICAgICAgaWYgKCFlbnYud2F0Y2gpIHtcbiAgICAgICAgcHJvY2Vzcy5leGl0Q29kZSA9IGVyciB8fCAwO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgY29uc3QgZW52ID0gbmV3IEVudigpO1xuXG5leHBvcnQgY29uc3QgY29kZXM6IGFueSA9IHtcbiAgYmxhY2s6ICczMCcsXG4gIHJlZDogJzMxJyxcbiAgZ3JlZW46ICczMicsXG4gIHllbGxvdzogJzMzJyxcbiAgYmx1ZTogJzM0JyxcbiAgbWFnZW50YTogJzM1JyxcbiAgY3lhbjogJzM2JyxcbiAgZ3JleTogJzkwJyxcbiAgZXJyb3I6ICczMTs0MScsXG4gIHdhcm46ICczMzs0MycsXG59O1xuXG5jb25zdCBjb2xvckZvckN0eCA9IChjdHg6IHN0cmluZywgY29sb3I6IGFueSk6IHN0cmluZyA9PlxuICBjb2xvciAmJiBjdHggaW4gY29sb3IgJiYgY29sb3JbY3R4XSBpbiBjb2RlcyA/IGNvZGVzW2NvbG9yW2N0eF1dIDogY29kZXMuZ3JleTtcblxuY29uc3QgZXNjYXBlID0gKHRleHQ6IHN0cmluZywgY29kZTogc3RyaW5nKTogc3RyaW5nID0+IGBcXHgxYlske2NvZGV9bSR7c3RyaXBDb2xvckVzY2FwZXModGV4dCl9XFx4MWJbMG1gO1xuXG5jb25zdCBwYWQyID0gKG46IG51bWJlcikgPT4gKG4gPCAxMCA/IGAwJHtufWAgOiBgJHtufWApO1xuXG5mdW5jdGlvbiBzdHJpcENvbG9yRXNjYXBlcyh0ZXh0OiBzdHJpbmcpIHtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnRyb2wtcmVnZXhcbiAgcmV0dXJuIHRleHQucmVwbGFjZSgvXFx4MWJcXFtbMC05O10qbS8sICcnKTtcbn1cblxuZXhwb3J0IGNvbnN0IGVycm9yTWFyayA9IGNvbG9ycy5yZWQoJ+KcmCAnKSArIGNvbG9ycy5lcnJvcignW0VSUk9SXScpO1xuXG5mdW5jdGlvbiBwcmV0dHlUaW1lKCkge1xuICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICByZXR1cm4gYCR7cGFkMihub3cuZ2V0SG91cnMoKSl9OiR7cGFkMihub3cuZ2V0TWludXRlcygpKX06JHtwYWQyKG5vdy5nZXRTZWNvbmRzKCkpfSBgO1xufVxuXG5tYWluKCk7XG4iXX0=