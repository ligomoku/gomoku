import * as winningChances from './winningChances';
import stepwiseScroll from 'common/wheel';
import { bind } from 'common/snabbdom';
import { defined, notNull } from 'common';
import { h } from 'snabbdom';
import { lichessRules } from 'chessops/compat';
import { makeSanAndPlay } from 'chessops/san';
import { opposite, parseUci } from 'chessops/util';
import { parseFen, makeBoardFen } from 'chessops/fen';
import { renderEval } from './util';
import { setupPosition } from 'chessops/variant';
import { uciToMove } from 'chessground/util';
import { CevalState } from './worker';
let gaugeLast = 0;
const gaugeTicks = [...Array(8).keys()].map(i => h(i === 3 ? 'tick.zero' : 'tick', { attrs: { style: `height: ${(i + 1) * 12.5}%` } }));
function localEvalInfo(ctrl, evs) {
    const ceval = ctrl.getCeval(), state = ceval.getState(), trans = ctrl.trans;
    if (!evs.client) {
        if (!ceval.analysable)
            return ['Engine cannot analyze this position'];
        if (state == CevalState.Failed)
            return [trans.noarg('engineFailed')];
        const mb = ceval.downloadProgress() / 1024 / 1024;
        const localEvalText = state == CevalState.Loading
            ? trans.noarg('loadingEngine') + (mb >= 1 ? ` (${mb.toFixed(1)} MiB)` : '')
            : trans.noarg('calculatingMoves');
        return [evs.server && ctrl.nextNodeBest() ? trans.noarg('usingServerAnalysis') : localEvalText];
    }
    const depth = evs.client.depth || 0;
    const t = evs.client.cloud
        ? [trans('depthX', depth), h('span.cloud', { attrs: { title: trans.noarg('cloudAnalysis') } }, 'Cloud')]
        : [trans('depthX', depth + '/' + Math.max(depth, evs.client.maxDepth))];
    if (ceval.canGoDeeper())
        t.push(h('a.deeper', {
            attrs: {
                title: trans.noarg('goDeeper'),
                'data-icon': '',
            },
            hook: bind('click', ceval.goDeeper),
        }));
    else if (!evs.client.cloud && evs.client.knps)
        t.push(', ' + Math.round(evs.client.knps) + 'k nodes/s');
    return t;
}
function threatInfo(ctrl, threat) {
    if (!threat)
        return ctrl.trans.noarg('calculatingMoves');
    let t = ctrl.trans('depthX', (threat.depth || 0) + '/' + threat.maxDepth);
    if (threat.knps)
        t += ', ' + Math.round(threat.knps) + 'k nodes/s';
    return t;
}
function threatButton(ctrl) {
    if (ctrl.disableThreatMode && ctrl.disableThreatMode())
        return null;
    return h('a.show-threat', {
        class: {
            active: ctrl.threatMode(),
            hidden: !!ctrl.getNode().check,
        },
        attrs: {
            'data-icon': '',
            title: ctrl.trans.noarg('showThreat') + ' (x)',
        },
        hook: bind('click', ctrl.toggleThreatMode),
    });
}
function engineName(ctrl) {
    return [
        h('span', { attrs: { title: ctrl.longEngineName() || '' } }, ctrl.shortEngineName()),
        ctrl.technology == 'external'
            ? h('span.technology.good', {
                attrs: {
                    title: 'Engine running outside of the browser',
                },
            }, 'EXTERNAL')
            : ctrl.technology == 'nnue'
                ? h('span.technology.good', {
                    attrs: {
                        title: 'Multi-threaded WebAssembly with SIMD (efficiently updatable neural network, using 4x smaller net by Sopel97)',
                    },
                }, 'NNUE')
                : ctrl.technology == 'hce'
                    ? h('span.technology.good', { attrs: { title: 'Multi-threaded WebAssembly (classical hand crafted evaluation)' } }, 'HCE')
                    : ctrl.technology == 'wasm'
                        ? h('span.technology', { attrs: { title: 'Single-threaded WebAssembly fallback (slow)' } }, 'WASM')
                        : h('span.technology', { attrs: { title: 'Single-threaded JavaScript fallback (very slow)' } }, 'ASMJS'),
    ];
}
const serverNodes = 4e6;
export function getBestEval(evs) {
    const serverEv = evs.server, localEv = evs.client;
    if (!serverEv)
        return localEv;
    if (!localEv)
        return serverEv;
    // Prefer localEv if it exceeds fishnet node limit or finds a better mate.
    if (localEv.nodes > serverNodes ||
        (typeof localEv.mate !== 'undefined' &&
            (typeof serverEv.mate === 'undefined' || Math.abs(localEv.mate) < Math.abs(serverEv.mate))))
        return localEv;
    return serverEv;
}
export function renderGauge(ctrl) {
    if (ctrl.ongoing || !ctrl.showEvalGauge())
        return;
    const bestEv = getBestEval(ctrl.currentEvals());
    let ev;
    if (bestEv) {
        ev = winningChances.povChances('white', bestEv);
        gaugeLast = ev;
    }
    else
        ev = gaugeLast;
    return h('div.eval-gauge', {
        class: {
            empty: ev === null,
            reverse: ctrl.getOrientation() === 'black',
        },
    }, [h('div.black', { attrs: { style: `height: ${100 - (ev + 1) * 50}%` } }), ...gaugeTicks]);
}
export function renderCeval(ctrl) {
    const instance = ctrl.getCeval(), trans = ctrl.trans;
    if (!instance.allowed() || !instance.possible || !ctrl.showComputer())
        return;
    const enabled = instance.enabled(), evs = ctrl.currentEvals(), threatMode = ctrl.threatMode(), threat = threatMode && ctrl.getNode().threat, bestEv = threat || getBestEval(evs);
    let pearl, percent;
    if (bestEv && typeof bestEv.cp !== 'undefined') {
        pearl = renderEval(bestEv.cp);
        percent = evs.client
            ? evs.client.cloud
                ? 100
                : Math.min(100, Math.round((100 * evs.client.depth) / evs.client.maxDepth))
            : 0;
    }
    else if (bestEv && defined(bestEv.mate)) {
        pearl = '#' + bestEv.mate;
        percent = 100;
    }
    else {
        if (!enabled)
            pearl = h('i');
        else if (ctrl.outcome() || ctrl.getNode().threefold)
            pearl = '-';
        else if (instance.getState() === CevalState.Failed)
            pearl = h('i.is-red', { attrs: { 'data-icon': '\ue05d' } });
        else
            pearl = h('i.ddloader');
        percent = 0;
    }
    if (threatMode) {
        if (threat)
            percent = Math.min(100, Math.round((100 * threat.depth) / threat.maxDepth));
        else
            percent = 0;
    }
    const progressBar = enabled
        ? h('div.bar', h('span', {
            class: { threat: threatMode },
            attrs: { style: `width: ${percent}%` },
            hook: {
                postpatch: (old, vnode) => {
                    if (old.data.percent > percent || !!old.data.threatMode != threatMode) {
                        const el = vnode.elm;
                        const p = el.parentNode;
                        p.removeChild(el);
                        p.appendChild(el);
                    }
                    vnode.data.percent = percent;
                    vnode.data.threatMode = threatMode;
                },
            },
        }))
        : null;
    const body = enabled
        ? [
            h('pearl', [pearl]),
            h('div.engine', [
                ...(threatMode ? [trans.noarg('showThreat')] : engineName(instance)),
                h('span.info', ctrl.outcome()
                    ? [trans.noarg('gameOver')]
                    : ctrl.getNode().threefold
                        ? [trans.noarg('threefoldRepetition')]
                        : threatMode
                            ? [threatInfo(ctrl, threat)]
                            : localEvalInfo(ctrl, evs)),
            ]),
        ]
        : [
            pearl ? h('pearl', [pearl]) : null,
            h('help', [
                ...engineName(instance),
                h('br'),
                instance.analysable ? trans.noarg('inLocalBrowser') : 'Engine cannot analyse this game',
            ]),
        ];
    const switchButton = ctrl.mandatoryCeval && ctrl.mandatoryCeval()
        ? null
        : h('div.switch', {
            attrs: { title: trans.noarg('toggleLocalEvaluation') + ' (L)' },
        }, [
            h('input#analyse-toggle-ceval.cmn-toggle.cmn-toggle--subtle', {
                attrs: {
                    type: 'checkbox',
                    checked: enabled,
                    disabled: !instance.analysable,
                },
                hook: bind('change', ctrl.toggleCeval),
            }),
            h('label', { attrs: { for: 'analyse-toggle-ceval' } }),
        ]);
    return h('div.ceval' + (enabled ? '.enabled' : ''), {
        class: {
            computing: percent < 100 && instance.getState() === CevalState.Computing,
        },
    }, [progressBar, ...body, threatButton(ctrl), switchButton]);
}
function getElFen(el) {
    return el.getAttribute('data-fen');
}
function getElUci(e) {
    return ($(e.target)
        .closest('div.pv')
        .attr('data-uci') || undefined);
}
function getElUciList(e) {
    return getElPvMoves(e)
        .filter(notNull)
        .map(move => move.split('|')[1]);
}
function getElPvMoves(e) {
    const pvMoves = [];
    $(e.target)
        .closest('div.pv')
        .children()
        .filter('span.pv-san')
        .each(function () {
        pvMoves.push($(this).attr('data-board'));
    });
    return pvMoves;
}
function checkHover(el, instance) {
    lichess.requestIdleCallback(() => instance.setHovering(getElFen(el), $(el).find('div.pv:hover').attr('data-uci') || undefined), 500);
}
export function renderPvs(ctrl) {
    const instance = ctrl.getCeval();
    if (!instance.allowed() || !instance.possible || !instance.enabled())
        return;
    const multiPv = instance.multiPv(), node = ctrl.getNode(), setup = parseFen(node.fen).unwrap();
    let pvs, threat = false, pvMoves, pvIndex;
    if (ctrl.threatMode() && node.threat) {
        pvs = node.threat.pvs;
        threat = true;
    }
    else if (node.ceval)
        pvs = node.ceval.pvs;
    else
        pvs = [];
    if (threat) {
        setup.turn = opposite(setup.turn);
        if (setup.turn == 'white')
            setup.fullmoves += 1;
    }
    const pos = setupPosition(lichessRules(instance.opts.variant.key), setup);
    return h('div.pv_box', {
        attrs: { 'data-fen': node.fen },
        hook: {
            insert: vnode => {
                const el = vnode.elm;
                el.addEventListener('mouseover', (e) => {
                    const instance = ctrl.getCeval();
                    instance.setHovering(getElFen(el), getElUci(e));
                    const pvBoard = e.target.dataset.board;
                    if (pvBoard) {
                        pvIndex = Number(e.target.dataset.moveIndex);
                        pvMoves = getElPvMoves(e);
                        const [fen, uci] = pvBoard.split('|');
                        instance.setPvBoard({ fen, uci });
                    }
                });
                el.addEventListener('wheel', stepwiseScroll((e, scroll) => {
                    e.preventDefault();
                    if (pvIndex != null && pvMoves != null) {
                        if (e.deltaY < 0 && pvIndex > 0 && scroll)
                            pvIndex -= 1;
                        else if (e.deltaY > 0 && pvIndex < pvMoves.length - 1 && scroll)
                            pvIndex += 1;
                        const pvBoard = pvMoves[pvIndex];
                        if (pvBoard) {
                            const [fen, uci] = pvBoard.split('|');
                            ctrl.getCeval().setPvBoard({ fen, uci });
                        }
                    }
                }));
                el.addEventListener('mouseout', () => ctrl.getCeval().setHovering(getElFen(el)));
                for (const event of ['touchstart', 'mousedown']) {
                    el.addEventListener(event, (e) => {
                        const uciList = getElUciList(e);
                        if (uciList.length > (pvIndex !== null && pvIndex !== void 0 ? pvIndex : 0) && !ctrl.threatMode()) {
                            ctrl.playUciList(uciList.slice(0, (pvIndex !== null && pvIndex !== void 0 ? pvIndex : 0) + 1));
                            e.preventDefault();
                        }
                    });
                }
                el.addEventListener('mouseleave', () => {
                    ctrl.getCeval().setPvBoard(null);
                    pvIndex = null;
                });
                checkHover(el, instance);
            },
            postpatch: (_, vnode) => checkHover(vnode.elm, instance),
        },
    }, [
        ...[...Array(multiPv).keys()].map(i => renderPv(threat, multiPv, pvs[i], pos.isOk ? pos.value : undefined)),
        renderPvBoard(ctrl),
    ]);
}
const MAX_NUM_MOVES = 16;
function renderPv(threat, multiPv, pv, pos) {
    const data = {};
    const children = [renderPvWrapToggle()];
    if (pv) {
        if (!threat) {
            data.attrs = { 'data-uci': pv.moves[0] };
        }
        if (multiPv > 1) {
            children.push(h('strong', defined(pv.mate) ? '#' + pv.mate : renderEval(pv.cp)));
        }
        if (pos) {
            children.push(...renderPvMoves(pos.clone(), pv.moves.slice(0, MAX_NUM_MOVES)));
        }
    }
    return h('div.pv.pv--nowrap', data, children);
}
function renderPvWrapToggle() {
    return h('span.pv-wrap-toggle', {
        hook: {
            insert: (vnode) => {
                const el = vnode.elm;
                for (const event of ['touchstart', 'mousedown']) {
                    el.addEventListener(event, (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        $(el).closest('.pv').toggleClass('pv--nowrap');
                    });
                }
            },
        },
    });
}
function renderPvMoves(pos, pv) {
    const vnodes = [];
    let key = makeBoardFen(pos.board);
    for (let i = 0; i < pv.length; i++) {
        let text;
        if (pos.turn === 'white') {
            text = `${pos.fullmoves}.`;
        }
        else if (i === 0) {
            text = `${pos.fullmoves}...`;
        }
        if (text) {
            vnodes.push(h('span', { key: text }, text));
        }
        const uci = pv[i];
        const san = makeSanAndPlay(pos, parseUci(uci));
        const fen = makeBoardFen(pos.board); // Chessground uses only board fen
        if (san === '--') {
            break;
        }
        key += '|' + uci;
        vnodes.push(h('span.pv-san', {
            key,
            attrs: {
                'data-move-index': i,
                'data-board': `${fen}|${uci}`,
            },
        }, san));
    }
    return vnodes;
}
function renderPvBoard(ctrl) {
    const instance = ctrl.getCeval();
    const pvBoard = instance.pvBoard();
    if (!pvBoard) {
        return;
    }
    const { fen, uci } = pvBoard;
    const orientation = ctrl.getOrientation();
    const cgConfig = {
        fen,
        lastMove: uciToMove(uci),
        orientation,
        coordinates: false,
        viewOnly: true,
        drawable: {
            enabled: false,
            visible: false,
        },
    };
    const cgVNode = h('div.cg-wrap.is2d', {
        hook: {
            insert: (vnode) => (vnode.elm._cg = window.Chessground(vnode.elm, cgConfig)),
            update: (vnode) => vnode.elm._cg.set(cgConfig),
            destroy: (vnode) => vnode.elm._cg.destroy(),
        },
    });
    return h('div.pv-board', h('div.pv-board-square', cgVNode));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlldy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy92aWV3LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxjQUFjLE1BQU0sa0JBQWtCLENBQUM7QUFDbkQsT0FBTyxjQUFjLE1BQU0sY0FBYyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN2QyxPQUFPLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUUxQyxPQUFPLEVBQUUsQ0FBQyxFQUFTLE1BQU0sVUFBVSxDQUFDO0FBRXBDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQzlDLE9BQU8sRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxRQUFRLEVBQUUsWUFBWSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ3RELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDcEMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUM3QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBR3RDLElBQUksU0FBUyxHQUFHLENBQUMsQ0FBQztBQUNsQixNQUFNLFVBQVUsR0FBWSxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQ3ZELENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFLEtBQUssRUFBRSxXQUFXLENB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V0FBVyxFQUFFLEtBQUs7UUFDbEIsUUFBUSxFQUFFLElBQUk7UUFDZCxRQUFRLEVBQUU7WUFDUixPQUFPLEVBQUUsS0FBSztZQUNkLE9BQU8sRUFBRSxLQUFLO1NBQ2Y7S0FDRixDQUFDO0lBQ0YsTUFBTSxPQUFPLEdBQUcsQ0FBQyxDQUFDLGtCQUFrQixFQUFFO1FBQ3BDLElBQUksRUFBRTtZQUNKLE1BQU0sRUFBRSxDQUFDLEtBQVUsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFDakYsTUFBTSxFQUFFLENBQUMsS0FBVSxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDO1lBQ25ELE9BQU8sRUFBRSxDQUFDLEtBQVUsRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFO1NBQ2pEO0tBQ0YsQ0FBQyxDQUFDO0lBQ0gsT0FBTyxDQUFDLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQyxxQkFBcUIsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO0FBQzlELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB3aW5uaW5nQ2hhbmNlcyBmcm9tICcuL3dpbm5pbmdDaGFuY2VzJztcbmltcG9ydCBzdGVwd2lzZVNjcm9sbCBmcm9tICdjb21tb24vd2hlZWwnO1xuaW1wb3J0IHsgYmluZCB9IGZyb20gJ2NvbW1vbi9zbmFiYmRvbSc7XG5pbXBvcnQgeyBkZWZpbmVkLCBub3ROdWxsIH0gZnJvbSAnY29tbW9uJztcbmltcG9ydCB7IEV2YWwsIFBhcmVudEN0cmwsIE5vZGVFdmFscyB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgaCwgVk5vZGUgfSBmcm9tICdzbmFiYmRvbSc7XG5pbXBvcnQgeyBQb3NpdGlvbiB9IGZyb20gJ2NoZXNzb3BzL2NoZXNzJztcbmltcG9ydCB7IGxpY2hlc3NSdWxlcyB9IGZyb20gJ2NoZXNzb3BzL2NvbXBhdCc7XG5pbXBvcnQgeyBtYWtlU2FuQW5kUGxheSB9IGZyb20gJ2NoZXNzb3BzL3Nhbic7XG5pbXBvcnQgeyBvcHBvc2l0ZSwgcGFyc2VVY2kgfSBmcm9tICdjaGVzc29wcy91dGlsJztcbmltcG9ydCB7IHBhcnNlRmVuLCBtYWtlQm9hcmRGZW4gfSBmcm9tICdjaGVzc29wcy9mZW4nO1xuaW1wb3J0IHsgcmVuZGVyRXZhbCB9IGZyb20gJy4vdXRpbCc7XG5pbXBvcnQgeyBzZXR1cFBvc2l0aW9uIH0gZnJvbSAnY2hlc3NvcHMvdmFyaWFudCc7XG5pbXBvcnQgeyB1Y2lUb01vdmUgfSBmcm9tICdjaGVzc2dyb3VuZC91dGlsJztcbmltcG9ydCB7IENldmFsU3RhdGUgfSBmcm9tICcuL3dvcmtlcic7XG5pbXBvcnQgQ2V2YWxDdHJsIGZyb20gJy4vY3RybCc7XG5cbmxldCBnYXVnZUxhc3QgPSAwO1xuY29uc3QgZ2F1Z2VUaWNrczogVk5vZGVbXSA9IFsuLi5BcnJheSg4KS5rZXlzKCldLm1hcChpID0+XG4gIGgoaSA9PT0gMyA/ICd0aWNrLnplcm8nIDogJ3RpY2snLCB7IGF0dHJzOiB7IHN0eWxlOiBgaGVpZ2h0OiAkeyhpICsgMSkgKiAxMi41fSVgIH0gfSlcbik7XG5cbmZ1bmN0aW9uIGxvY2FsRXZhbEluZm8oY3RybDogUGFyZW50Q3RybCwgZXZzOiBOb2RlRXZhbHMpOiBBcnJheTxWTm9kZSB8IHN0cmluZz4ge1xuICBjb25zdCBjZXZhbCA9IGN0cmwuZ2V0Q2V2YWwoKSxcbiAgICBzdGF0ZSA9IGNldmFsLmdldFN0YXRlKCksXG4gICAgdHJhbnMgPSBjdHJsLnRyYW5zO1xuICBpZiAoIWV2cy5jbGllbnQpIHtcbiAgICBpZiAoIWNldmFsLmFuYWx5c2FibGUpIHJldHVybiBbJ0VuZ2luZSBjYW5ub3QgYW5hbHl6ZSB0aGlzIHBvc2l0aW9uJ107XG4gICAgaWYgKHN0YXRlID09IENldmFsU3RhdGUuRmFpbGVkKSByZXR1cm4gW3RyYW5zLm5vYXJnKCdlbmdpbmVGYWlsZWQnKV07XG4gICAgY29uc3QgbWIgPSBjZXZhbC5kb3dubG9hZFByb2dyZXNzKCkgLyAxMDI0IC8gMTAyNDtcbiAgICBjb25zdCBsb2NhbEV2YWxUZXh0ID1cbiAgICAgIHN0YXRlID09IENldmFsU3RhdGUuTG9hZGluZ1xuICAgICAgICA/IHRyYW5zLm5vYXJnKCdsb2FkaW5nRW5naW5lJykgKyAobWIgPj0gMSA/IGAgKCR7bWIudG9GaXhlZCgxKX0gTWlCKWAgOiAnJylcbiAgICAgICAgOiB0cmFucy5ub2FyZygnY2FsY3VsYXRpbmdNb3ZlcycpO1xuICAgIHJldHVybiBbZXZzLnNlcnZlciAmJiBjdHJsLm5leHROb2RlQmVzdCgpID8gdHJhbnMubm9hcmcoJ3VzaW5nU2VydmVyQW5hbHlzaXMnKSA6IGxvY2FsRXZhbFRleHRdO1xuICB9XG5cbiAgY29uc3QgZGVwdGggPSBldnMuY2xpZW50LmRlcHRoIHx8IDA7XG4gIGNvbnN0IHQ6IEFycmF5PFZOb2RlIHwgc3RyaW5nPiA9IGV2cy5jbGllbnQuY2xvdWRcbiAgICA/IFt0cmFucygnZGVwdGhYJywgZGVwdGgpLCBoKCdzcGFuLmNsb3VkJywgeyBhdHRyczogeyB0aXRsZTogdHJhbnMubm9hcmcoJ2Nsb3VkQW5hbHlzaXMnKSB9IH0sICdDbG91ZCcpXVxuICAgIDogW3RyYW5zKCdkZXB0aFgnLCBkZXB0aCArICcvJyArIE1hdGgubWF4KGRlcHRoLCBldnMuY2xpZW50Lm1heERlcHRoKSldO1xuICBpZiAoY2V2YWwuY2FuR29EZWVwZXIoKSlcbiAgICB0LnB1c2goXG4gICAgICBoKCdhLmRlZXBlcicsIHtcbiAgICAgICAgYXR0cnM6IHtcbiAgICAgICAgICB0aXRsZTogdHJhbnMubm9hcmcoJ2dvRGVlcGVyJyksXG4gICAgICAgICAgJ2RhdGEtaWNvbic6ICfugYInLFxuICAgICAgICB9LFxuICAgICAgICBob29rOiBiaW5kKCdjbGljaycsIGNldmFsLmdvRGVlcGVyKSxcbiAgICAgIH0pXG4gICAgKTtcbiAgZWxzZSBpZiAoIWV2cy5jbGllbnQuY2xvdWQgJiYgZXZzLmNsaWVudC5rbnBzKSB0LnB1c2goJywgJyArIE1hdGgucm91bmQoZXZzLmNsaWVudC5rbnBzKSArICdrIG5vZGVzL3MnKTtcbiAgcmV0dXJuIHQ7XG59XG5cbmZ1bmN0aW9uIHRocmVhdEluZm8oY3RybDogUGFyZW50Q3RybCwgdGhyZWF0PzogVHJlZS5Mb2NhbEV2YWwgfCBmYWxzZSk6IHN0cmluZyB7XG4gIGlmICghdGhyZWF0KSByZXR1cm4gY3RybC50cmFucy5ub2FyZygnY2FsY3VsYXRpbmdNb3ZlcycpO1xuICBsZXQgdCA9IGN0cmwudHJhbnMoJ2RlcHRoWCcsICh0aHJlYXQuZGVwdGggfHwgMCkgKyAnLycgKyB0aHJlYXQubWF4RGVwdGgpO1xuICBpZiAodGhyZWF0LmtucHMpIHQgKz0gJywgJyArIE1hdGgucm91bmQodGhyZWF0LmtucHMpICsgJ2sgbm9kZXMvcyc7XG4gIHJldHVybiB0O1xufVxuXG5mdW5jdGlvbiB0aHJlYXRCdXR0b24oY3RybDogUGFyZW50Q3RybCk6IFZOb2RlIHwgbnVsbCB7XG4gIGlmIChjdHJsLmRpc2FibGVUaHJlYXRNb2RlICYmIGN0cmwuZGlzYWJsZVRocmVhdE1vZGUoKSkgcmV0dXJuIG51bGw7XG4gIHJldHVybiBoKCdhLnNob3ctdGhyZWF0Jywge1xuICAgIGNsYXNzOiB7XG4gICAgICBhY3RpdmU6IGN0cmwudGhyZWF0TW9kZSgpLFxuICAgICAgaGlkZGVuOiAhIWN0cmwuZ2V0Tm9kZSgpLmNoZWNrLFxuICAgIH0sXG4gICAgYXR0cnM6IHtcbiAgICAgICdkYXRhLWljb24nOiAn7oCqJyxcbiAgICAgIHRpdGxlOiBjdHJsLnRyYW5zLm5vYXJnKCdzaG93VGhyZWF0JykgKyAnICh4KScsXG4gICAgfSxcbiAgICBob29rOiBiaW5kKCdjbGljaycsIGN0cmwudG9nZ2xlVGhyZWF0TW9kZSksXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBlbmdpbmVOYW1lKGN0cmw6IENldmFsQ3RybCk6IFZOb2RlW10ge1xuICByZXR1cm4gW1xuICAgIGgoJ3NwYW4nLCB7IGF0dHJzOiB7IHRpdGxlOiBjdHJsLmxvbmdFbmdpbmVOYW1lKCkgfHwgJycgfSB9LCBjdHJsLnNob3J0RW5naW5lTmFtZSgpKSxcbiAgICBjdHJsLnRlY2hub2xvZ3kgPT0gJ2V4dGVybmFsJ1xuICAgICAgPyBoKFxuICAgICAgICAgICdzcGFuLnRlY2hub2xvZ3kuZ29vZCcsXG4gICAgICAgICAge1xuICAgICAgICAgICAgYXR0cnM6IHtcbiAgICAgICAgICAgICAgdGl0bGU6ICdFbmdpbmUgcnVubmluZyBvdXRzaWRlIG9mIHRoZSBicm93c2VyJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICAnRVhURVJOQUwnXG4gICAgICAgIClcbiAgICAgIDogY3RybC50ZWNobm9sb2d5ID09ICdubnVlJ1xuICAgICAgPyBoKFxuICAgICAgICAgICdzcGFuLnRlY2hub2xvZ3kuZ29vZCcsXG4gICAgICAgICAge1xuICAgICAgICAgICAgYXR0cnM6IHtcbiAgICAgICAgICAgICAgdGl0bGU6XG4gICAgICAgICAgICAgICAgJ011bHRpLXRocmVhZGVkIFdlYkFzc2VtYmx5IHdpdGggU0lNRCAoZWZmaWNpZW50bHkgdXBkYXRhYmxlIG5ldXJhbCBuZXR3b3JrLCB1c2luZyA0eCBzbWFsbGVyIG5ldCBieSBTb3BlbDk3KScsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgJ05OVUUnXG4gICAgICAgIClcbiAgICAgIDogY3RybC50ZWNobm9sb2d5ID09ICdoY2UnXG4gICAgICA/IGgoXG4gICAgICAgICAgJ3NwYW4udGVjaG5vbG9neS5nb29kJyxcbiAgICAgICAgICB7IGF0dHJzOiB7IHRpdGxlOiAnTXVsdGktdGhyZWFkZWQgV2ViQXNzZW1ibHkgKGNsYXNzaWNhbCBoYW5kIGNyYWZ0ZWQgZXZhbHVhdGlvbiknIH0gfSxcbiAgICAgICAgICAnSENFJ1xuICAgICAgICApXG4gICAgICA6IGN0cmwudGVjaG5vbG9neSA9PSAnd2FzbSdcbiAgICAgID8gaCgnc3Bhbi50ZWNobm9sb2d5JywgeyBhdHRyczogeyB0aXRsZTogJ1NpbmdsZS10aHJlYWRlZCBXZWJBc3NlbWJseSBmYWxsYmFjayAoc2xvdyknIH0gfSwgJ1dBU00nKVxuICAgICAgOiBoKCdzcGFuLnRlY2hub2xvZ3knLCB7IGF0dHJzOiB7IHRpdGxlOiAnU2luZ2xlLXRocmVhZGVkIEphdmFTY3JpcHQgZmFsbGJhY2sgKHZlcnkgc2xvdyknIH0gfSwgJ0FTTUpTJyksXG4gIF07XG59XG5cbmNvbnN0IHNlcnZlck5vZGVzID0gNGU2O1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0QmVzdEV2YWwoZXZzOiBOb2RlRXZhbHMpOiBFdmFsIHwgdW5kZWZpbmVkIHtcbiAgY29uc3Qgc2VydmVyRXYgPSBldnMuc2VydmVyLFxuICAgIGxvY2FsRXYgPSBldnMuY2xpZW50O1xuXG4gIGlmICghc2VydmVyRXYpIHJldHVybiBsb2NhbEV2O1xuICBpZiAoIWxvY2FsRXYpIHJldHVybiBzZXJ2ZXJFdjtcblxuICAvLyBQcmVmZXIgbG9jYWxFdiBpZiBpdCBleGNlZWRzIGZpc2huZXQgbm9kZSBsaW1pdCBvciBmaW5kcyBhIGJldHRlciBtYXRlLlxuICBpZiAoXG4gICAgbG9jYWxFdi5ub2RlcyA+IHNlcnZlck5vZGVzIHx8XG4gICAgKHR5cGVvZiBsb2NhbEV2Lm1hdGUgIT09ICd1bmRlZmluZWQnICYmXG4gICAgICAodHlwZW9mIHNlcnZlckV2Lm1hdGUgPT09ICd1bmRlZmluZWQnIHx8IE1hdGguYWJzKGxvY2FsRXYubWF0ZSkgPCBNYXRoLmFicyhzZXJ2ZXJFdi5tYXRlKSkpXG4gIClcbiAgICByZXR1cm4gbG9jYWxFdjtcblxuICByZXR1cm4gc2VydmVyRXY7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZW5kZXJHYXVnZShjdHJsOiBQYXJlbnRDdHJsKTogVk5vZGUgfCB1bmRlZmluZWQge1xuICBpZiAoY3RybC5vbmdvaW5nIHx8ICFjdHJsLnNob3dFdmFsR2F1Z2UoKSkgcmV0dXJuO1xuICBjb25zdCBiZXN0RXYgPSBnZXRCZXN0RXZhbChjdHJsLmN1cnJlbnRFdmFscygpKTtcbiAgbGV0IGV2O1xuICBpZiAoYmVzdEV2KSB7XG4gICAgZXYgPSB3aW5uaW5nQ2hhbmNlcy5wb3ZDaGFuY2VzKCd3aGl0ZScsIGJlc3RFdik7XG4gICAgZ2F1Z2VMYXN0ID0gZXY7XG4gIH0gZWxzZSBldiA9IGdhdWdlTGFzdDtcbiAgcmV0dXJuIGgoXG4gICAgJ2Rpdi5ldmFsLWdhdWdlJyxcbiAgICB7XG4gICAgICBjbGFzczoge1xuICAgICAgICBlbXB0eTogZXYgPT09IG51bGwsXG4gICAgICAgIHJldmVyc2U6IGN0cmwuZ2V0T3JpZW50YXRpb24oKSA9PT0gJ2JsYWNrJyxcbiAgICAgIH0sXG4gICAgfSxcbiAgICBbaCgnZGl2LmJsYWNrJywgeyBhdHRyczogeyBzdHlsZTogYGhlaWdodDogJHsxMDAgLSAoZXYgKyAxKSAqIDUwfSVgIH0gfSksIC4uLmdhdWdlVGlja3NdXG4gICk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZW5kZXJDZXZhbChjdHJsOiBQYXJlbnRDdHJsKTogVk5vZGUgfCB1bmRlZmluZWQge1xuICBjb25zdCBpbnN0YW5jZSA9IGN0cmwuZ2V0Q2V2YWwoKSxcbiAgICB0cmFucyA9IGN0cmwudHJhbnM7XG4gIGlmICghaW5zdGFuY2UuYWxsb3dlZCgpIHx8ICFpbnN0YW5jZS5wb3NzaWJsZSB8fCAhY3RybC5zaG93Q29tcHV0ZXIoKSkgcmV0dXJuO1xuICBjb25zdCBlbmFibGVkID0gaW5zdGFuY2UuZW5hYmxlZCgpLFxuICAgIGV2cyA9IGN0cmwuY3VycmVudEV2YWxzKCksXG4gICAgdGhyZWF0TW9kZSA9IGN0cmwudGhyZWF0TW9kZSgpLFxuICAgIHRocmVhdCA9IHRocmVhdE1vZGUgJiYgY3RybC5nZXROb2RlKCkudGhyZWF0LFxuICAgIGJlc3RFdiA9IHRocmVhdCB8fCBnZXRCZXN0RXZhbChldnMpO1xuICBsZXQgcGVhcmw6IFZOb2RlIHwgc3RyaW5nLCBwZXJjZW50OiBudW1iZXI7XG4gIGlmIChiZXN0RXYgJiYgdHlwZW9mIGJlc3RFdi5jcCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICBwZWFybCA9IHJlbmRlckV2YWwoYmVzdEV2LmNwKTtcbiAgICBwZXJjZW50ID0gZXZzLmNsaWVudFxuICAgICAgPyBldnMuY2xpZW50LmNsb3VkXG4gICAgICAgID8gMTAwXG4gICAgICAgIDogTWF0aC5taW4oMTAwLCBNYXRoLnJvdW5kKCgxMDAgKiBldnMuY2xpZW50LmRlcHRoKSAvIGV2cy5jbGllbnQubWF4RGVwdGgpKVxuICAgICAgOiAwO1xuICB9IGVsc2UgaWYgKGJlc3RFdiAmJiBkZWZpbmVkKGJlc3RFdi5tYXRlKSkge1xuICAgIHBlYXJsID0gJyMnICsgYmVzdEV2Lm1hdGU7XG4gICAgcGVyY2VudCA9IDEwMDtcbiAgfSBlbHNlIHtcbiAgICBpZiAoIWVuYWJsZWQpIHBlYXJsID0gaCgnaScpO1xuICAgIGVsc2UgaWYgKGN0cmwub3V0Y29tZSgpIHx8IGN0cmwuZ2V0Tm9kZSgpLnRocmVlZm9sZCkgcGVhcmwgPSAnLSc7XG4gICAgZWxzZSBpZiAoaW5zdGFuY2UuZ2V0U3RhdGUoKSA9PT0gQ2V2YWxTdGF0ZS5GYWlsZWQpIHBlYXJsID0gaCgnaS5pcy1yZWQnLCB7IGF0dHJzOiB7ICdkYXRhLWljb24nOiAnXFx1ZTA1ZCcgfSB9KTtcbiAgICBlbHNlIHBlYXJsID0gaCgnaS5kZGxvYWRlcicpO1xuICAgIHBlcmNlbnQgPSAwO1xuICB9XG4gIGlmICh0aHJlYXRNb2RlKSB7XG4gICAgaWYgKHRocmVhdCkgcGVyY2VudCA9IE1hdGgubWluKDEwMCwgTWF0aC5yb3VuZCgoMTAwICogdGhyZWF0LmRlcHRoKSAvIHRocmVhdC5tYXhEZXB0aCkpO1xuICAgIGVsc2UgcGVyY2VudCA9IDA7XG4gIH1cblxuICBjb25zdCBwcm9ncmVzc0JhcjogVk5vZGUgfCBudWxsID0gZW5hYmxlZFxuICAgID8gaChcbiAgICAgICAgJ2Rpdi5iYXInLFxuICAgICAgICBoKCdzcGFuJywge1xuICAgICAgICAgIGNsYXNzOiB7IHRocmVhdDogdGhyZWF0TW9kZSB9LFxuICAgICAgICAgIGF0dHJzOiB7IHN0eWxlOiBgd2lkdGg6ICR7cGVyY2VudH0lYCB9LFxuICAgICAgICAgIGhvb2s6IHtcbiAgICAgICAgICAgIHBvc3RwYXRjaDogKG9sZCwgdm5vZGUpID0+IHtcbiAgICAgICAgICAgICAgaWYgKG9sZC5kYXRhIS5wZXJjZW50ID4gcGVyY2VudCB8fCAhIW9sZC5kYXRhIS50aHJlYXRNb2RlICE9IHRocmVhdE1vZGUpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBlbCA9IHZub2RlLmVsbSBhcyBIVE1MRWxlbWVudDtcbiAgICAgICAgICAgICAgICBjb25zdCBwID0gZWwucGFyZW50Tm9kZSBhcyBIVE1MRWxlbWVudDtcbiAgICAgICAgICAgICAgICBwLnJlbW92ZUNoaWxkKGVsKTtcbiAgICAgICAgICAgICAgICBwLmFwcGVuZENoaWxkKGVsKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB2bm9kZS5kYXRhIS5wZXJjZW50ID0gcGVyY2VudDtcbiAgICAgICAgICAgICAgdm5vZGUuZGF0YSEudGhyZWF0TW9kZSA9IHRocmVhdE1vZGU7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pXG4gICAgICApXG4gICAgOiBudWxsO1xuXG4gIGNvbnN0IGJvZHk6IEFycmF5PFZOb2RlIHwgbnVsbD4gPSBlbmFibGVkXG4gICAgPyBbXG4gICAgICAgIGgoJ3BlYXJsJywgW3BlYXJsXSksXG4gICAgICAgIGgoJ2Rpdi5lbmdpbmUnLCBbXG4gICAgICAgICAgLi4uKHRocmVhdE1vZGUgPyBbdHJhbnMubm9hcmcoJ3Nob3dUaHJlYXQnKV0gOiBlbmdpbmVOYW1lKGluc3RhbmNlKSksXG4gICAgICAgICAgaChcbiAgICAgICAgICAgICdzcGFuLmluZm8nLFxuICAgICAgICAgICAgY3RybC5vdXRjb21lKClcbiAgICAgICAgICAgICAgPyBbdHJhbnMubm9hcmcoJ2dhbWVPdmVyJyldXG4gICAgICAgICAgICAgIDogY3RybC5nZXROb2RlKCkudGhyZWVmb2xkXG4gICAgICAgICAgICAgID8gW3RyYW5zLm5vYXJnKCd0aHJlZWZvbGRSZXBldGl0aW9uJyldXG4gICAgICAgICAgICAgIDogdGhyZWF0TW9kZVxuICAgICAgICAgICAgICA/IFt0aHJlYXRJbmZvKGN0cmwsIHRocmVhdCldXG4gICAgICAgICAgICAgIDogbG9jYWxFdmFsSW5mbyhjdHJsLCBldnMpXG4gICAgICAgICAgKSxcbiAgICAgICAgXSksXG4gICAgICBdXG4gICAgOiBbXG4gICAgICAgIHBlYXJsID8gaCgncGVhcmwnLCBbcGVhcmxdKSA6IG51bGwsXG4gICAgICAgIGgoJ2hlbHAnLCBbXG4gICAgICAgICAgLi4uZW5naW5lTmFtZShpbnN0YW5jZSksXG4gICAgICAgICAgaCgnYnInKSxcbiAgICAgICAgICBpbnN0YW5jZS5hbmFseXNhYmxlID8gdHJhbnMubm9hcmcoJ2luTG9jYWxCcm93c2VyJykgOiAnRW5naW5lIGNhbm5vdCBhbmFseXNlIHRoaXMgZ2FtZScsXG4gICAgICAgIF0pLFxuICAgICAgXTtcblxuICBjb25zdCBzd2l0Y2hCdXR0b246IFZOb2RlIHwgbnVsbCA9XG4gICAgY3RybC5tYW5kYXRvcnlDZXZhbCAmJiBjdHJsLm1hbmRhdG9yeUNldmFsKClcbiAgICAgID8gbnVsbFxuICAgICAgOiBoKFxuICAgICAgICAgICdkaXYuc3dpdGNoJyxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBhdHRyczogeyB0aXRsZTogdHJhbnMubm9hcmcoJ3RvZ2dsZUxvY2FsRXZhbHVhdGlvbicpICsgJyAoTCknIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBbXG4gICAgICAgICAgICBoKCdpbnB1dCNhbmFseXNlLXRvZ2dsZS1jZXZhbC5jbW4tdG9nZ2xlLmNtbi10b2dnbGUtLXN1YnRsZScsIHtcbiAgICAgICAgICAgICAgYXR0cnM6IHtcbiAgICAgICAgICAgICAgICB0eXBlOiAnY2hlY2tib3gnLFxuICAgICAgICAgICAgICAgIGNoZWNrZWQ6IGVuYWJsZWQsXG4gICAgICAgICAgICAgICAgZGlzYWJsZWQ6ICFpbnN0YW5jZS5hbmFseXNhYmxlLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBob29rOiBiaW5kKCdjaGFuZ2UnLCBjdHJsLnRvZ2dsZUNldmFsKSxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgaCgnbGFiZWwnLCB7IGF0dHJzOiB7IGZvcjogJ2FuYWx5c2UtdG9nZ2xlLWNldmFsJyB9IH0pLFxuICAgICAgICAgIF1cbiAgICAgICAgKTtcblxuICByZXR1cm4gaChcbiAgICAnZGl2LmNldmFsJyArIChlbmFibGVkID8gJy5lbmFibGVkJyA6ICcnKSxcbiAgICB7XG4gICAgICBjbGFzczoge1xuICAgICAgICBjb21wdXRpbmc6IHBlcmNlbnQgPCAxMDAgJiYgaW5zdGFuY2UuZ2V0U3RhdGUoKSA9PT0gQ2V2YWxTdGF0ZS5Db21wdXRpbmcsXG4gICAgICB9LFxuICAgIH0sXG4gICAgW3Byb2dyZXNzQmFyLCAuLi5ib2R5LCB0aHJlYXRCdXR0b24oY3RybCksIHN3aXRjaEJ1dHRvbl1cbiAgKTtcbn1cblxuZnVuY3Rpb24gZ2V0RWxGZW4oZWw6IEhUTUxFbGVtZW50KTogc3RyaW5nIHtcbiAgcmV0dXJuIGVsLmdldEF0dHJpYnV0ZSgnZGF0YS1mZW4nKSE7XG59XG5cbmZ1bmN0aW9uIGdldEVsVWNpKGU6IFRvdWNoRXZlbnQgfCBNb3VzZUV2ZW50KTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgcmV0dXJuIChcbiAgICAkKGUudGFyZ2V0IGFzIEhUTUxFbGVtZW50KVxuICAgICAgLmNsb3Nlc3QoJ2Rpdi5wdicpXG4gICAgICAuYXR0cignZGF0YS11Y2knKSB8fCB1bmRlZmluZWRcbiAgKTtcbn1cblxuZnVuY3Rpb24gZ2V0RWxVY2lMaXN0KGU6IFRvdWNoRXZlbnQgfCBNb3VzZUV2ZW50KTogc3RyaW5nW10ge1xuICByZXR1cm4gZ2V0RWxQdk1vdmVzKGUpXG4gICAgLmZpbHRlcihub3ROdWxsKVxuICAgIC5tYXAobW92ZSA9PiBtb3ZlLnNwbGl0KCd8JylbMV0pO1xufVxuXG5mdW5jdGlvbiBnZXRFbFB2TW92ZXMoZTogVG91Y2hFdmVudCB8IE1vdXNlRXZlbnQpOiAoc3RyaW5nIHwgbnVsbClbXSB7XG4gIGNvbnN0IHB2TW92ZXM6IChzdHJpbmcgfCBudWxsKVtdID0gW107XG5cbiAgJChlLnRhcmdldCBhcyBIVE1MRWxlbWVudClcbiAgICAuY2xvc2VzdCgnZGl2LnB2JylcbiAgICAuY2hpbGRyZW4oKVxuICAgIC5maWx0ZXIoJ3NwYW4ucHYtc2FuJylcbiAgICAuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICBwdk1vdmVzLnB1c2goJCh0aGlzKS5hdHRyKCdkYXRhLWJvYXJkJykpO1xuICAgIH0pO1xuXG4gIHJldHVybiBwdk1vdmVzO1xufVxuXG5mdW5jdGlvbiBjaGVja0hvdmVyKGVsOiBIVE1MRWxlbWVudCwgaW5zdGFuY2U6IENldmFsQ3RybCk6IHZvaWQge1xuICBsaWNoZXNzLnJlcXVlc3RJZGxlQ2FsbGJhY2soXG4gICAgKCkgPT4gaW5zdGFuY2Uuc2V0SG92ZXJpbmcoZ2V0RWxGZW4oZWwpLCAkKGVsKS5maW5kKCdkaXYucHY6aG92ZXInKS5hdHRyKCdkYXRhLXVjaScpIHx8IHVuZGVmaW5lZCksXG4gICAgNTAwXG4gICk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZW5kZXJQdnMoY3RybDogUGFyZW50Q3RybCk6IFZOb2RlIHwgdW5kZWZpbmVkIHtcbiAgY29uc3QgaW5zdGFuY2UgPSBjdHJsLmdldENldmFsKCk7XG4gIGlmICghaW5zdGFuY2UuYWxsb3dlZCgpIHx8ICFpbnN0YW5jZS5wb3NzaWJsZSB8fCAhaW5zdGFuY2UuZW5hYmxlZCgpKSByZXR1cm47XG4gIGNvbnN0IG11bHRpUHYgPSBpbnN0YW5jZS5tdWx0aVB2KCksXG4gICAgbm9kZSA9IGN0cmwuZ2V0Tm9kZSgpLFxuICAgIHNldHVwID0gcGFyc2VGZW4obm9kZS5mZW4pLnVud3JhcCgpO1xuICBsZXQgcHZzOiBUcmVlLlB2RGF0YVtdLFxuICAgIHRocmVhdCA9IGZhbHNlLFxuICAgIHB2TW92ZXM6IChzdHJpbmcgfCBudWxsKVtdLFxuICAgIHB2SW5kZXg6IG51bWJlciB8IG51bGw7XG4gIGlmIChjdHJsLnRocmVhdE1vZGUoKSAmJiBub2RlLnRocmVhdCkge1xuICAgIHB2cyA9IG5vZGUudGhyZWF0LnB2cztcbiAgICB0aHJlYXQgPSB0cnVlO1xuICB9IGVsc2UgaWYgKG5vZGUuY2V2YWwpIHB2cyA9IG5vZGUuY2V2YWwucHZzO1xuICBlbHNlIHB2cyA9IFtdO1xuICBpZiAodGhyZWF0KSB7XG4gICAgc2V0dXAudHVybiA9IG9wcG9zaXRlKHNldHVwLnR1cm4pO1xuICAgIGlmIChzZXR1cC50dXJuID09ICd3aGl0ZScpIHNldHVwLmZ1bGxtb3ZlcyArPSAxO1xuICB9XG4gIGNvbnN0IHBvcyA9IHNldHVwUG9zaXRpb24obGljaGVzc1J1bGVzKGluc3RhbmNlLm9wdHMudmFyaWFudC5rZXkpLCBzZXR1cCk7XG5cbiAgcmV0dXJuIGgoXG4gICAgJ2Rpdi5wdl9ib3gnLFxuICAgIHtcbiAgICAgIGF0dHJzOiB7ICdkYXRhLWZlbic6IG5vZGUuZmVuIH0sXG4gICAgICBob29rOiB7XG4gICAgICAgIGluc2VydDogdm5vZGUgPT4ge1xuICAgICAgICAgIGNvbnN0IGVsID0gdm5vZGUuZWxtIGFzIEhUTUxFbGVtZW50O1xuICAgICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlb3ZlcicsIChlOiBNb3VzZUV2ZW50KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IGN0cmwuZ2V0Q2V2YWwoKTtcbiAgICAgICAgICAgIGluc3RhbmNlLnNldEhvdmVyaW5nKGdldEVsRmVuKGVsKSwgZ2V0RWxVY2koZSkpO1xuICAgICAgICAgICAgY29uc3QgcHZCb2FyZCA9IChlLnRhcmdldCBhcyBIVE1MRWxlbWVudCkuZGF0YXNldC5ib2FyZDtcbiAgICAgICAgICAgIGlmIChwdkJvYXJkKSB7XG4gICAgICAgICAgICAgIHB2SW5kZXggPSBOdW1iZXIoKGUudGFyZ2V0IGFzIEhUTUxFbGVtZW50KS5kYXRhc2V0Lm1vdmVJbmRleCk7XG4gICAgICAgICAgICAgIHB2TW92ZXMgPSBnZXRFbFB2TW92ZXMoZSk7XG4gICAgICAgICAgICAgIGNvbnN0IFtmZW4sIHVjaV0gPSBwdkJvYXJkLnNwbGl0KCd8Jyk7XG4gICAgICAgICAgICAgIGluc3RhbmNlLnNldFB2Qm9hcmQoeyBmZW4sIHVjaSB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKFxuICAgICAgICAgICAgJ3doZWVsJyxcbiAgICAgICAgICAgIHN0ZXB3aXNlU2Nyb2xsKChlOiBXaGVlbEV2ZW50LCBzY3JvbGw6IGJvb2xlYW4pID0+IHtcbiAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICBpZiAocHZJbmRleCAhPSBudWxsICYmIHB2TW92ZXMgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGlmIChlLmRlbHRhWSA8IDAgJiYgcHZJbmRleCA+IDAgJiYgc2Nyb2xsKSBwdkluZGV4IC09IDE7XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoZS5kZWx0YVkgPiAwICYmIHB2SW5kZXggPCBwdk1vdmVzLmxlbmd0aCAtIDEgJiYgc2Nyb2xsKSBwdkluZGV4ICs9IDE7XG4gICAgICAgICAgICAgICAgY29uc3QgcHZCb2FyZCA9IHB2TW92ZXNbcHZJbmRleF07XG4gICAgICAgICAgICAgICAgaWYgKHB2Qm9hcmQpIHtcbiAgICAgICAgICAgICAgICAgIGNvbnN0IFtmZW4sIHVjaV0gPSBwdkJvYXJkLnNwbGl0KCd8Jyk7XG4gICAgICAgICAgICAgICAgICBjdHJsLmdldENldmFsKCkuc2V0UHZCb2FyZCh7IGZlbiwgdWNpIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICApO1xuICAgICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlb3V0JywgKCkgPT4gY3RybC5nZXRDZXZhbCgpLnNldEhvdmVyaW5nKGdldEVsRmVuKGVsKSkpO1xuICAgICAgICAgIGZvciAoY29uc3QgZXZlbnQgb2YgWyd0b3VjaHN0YXJ0JywgJ21vdXNlZG93biddKSB7XG4gICAgICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKGV2ZW50LCAoZTogVG91Y2hFdmVudCB8IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgY29uc3QgdWNpTGlzdCA9IGdldEVsVWNpTGlzdChlKTtcbiAgICAgICAgICAgICAgaWYgKHVjaUxpc3QubGVuZ3RoID4gKHB2SW5kZXggPz8gMCkgJiYgIWN0cmwudGhyZWF0TW9kZSgpKSB7XG4gICAgICAgICAgICAgICAgY3RybC5wbGF5VWNpTGlzdCh1Y2lMaXN0LnNsaWNlKDAsIChwdkluZGV4ID8/IDApICsgMSkpO1xuICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCAoKSA9PiB7XG4gICAgICAgICAgICBjdHJsLmdldENldmFsKCkuc2V0UHZCb2FyZChudWxsKTtcbiAgICAgICAgICAgIHB2SW5kZXggPSBudWxsO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIGNoZWNrSG92ZXIoZWwsIGluc3RhbmNlKTtcbiAgICAgICAgfSxcbiAgICAgICAgcG9zdHBhdGNoOiAoXywgdm5vZGUpID0+IGNoZWNrSG92ZXIodm5vZGUuZWxtIGFzIEhUTUxFbGVtZW50LCBpbnN0YW5jZSksXG4gICAgICB9LFxuICAgIH0sXG4gICAgW1xuICAgICAgLi4uWy4uLkFycmF5KG11bHRpUHYpLmtleXMoKV0ubWFwKGkgPT4gcmVuZGVyUHYodGhyZWF0LCBtdWx0aVB2LCBwdnNbaV0sIHBvcy5pc09rID8gcG9zLnZhbHVlIDogdW5kZWZpbmVkKSksXG4gICAgICByZW5kZXJQdkJvYXJkKGN0cmwpLFxuICAgIF1cbiAgKTtcbn1cblxuY29uc3QgTUFYX05VTV9NT1ZFUyA9IDE2O1xuXG5mdW5jdGlvbiByZW5kZXJQdih0aHJlYXQ6IGJvb2xlYW4sIG11bHRpUHY6IG51bWJlciwgcHY/OiBUcmVlLlB2RGF0YSwgcG9zPzogUG9zaXRpb24pOiBWTm9kZSB7XG4gIGNvbnN0IGRhdGE6IGFueSA9IHt9O1xuICBjb25zdCBjaGlsZHJlbjogVk5vZGVbXSA9IFtyZW5kZXJQdldyYXBUb2dnbGUoKV07XG4gIGlmIChwdikge1xuICAgIGlmICghdGhyZWF0KSB7XG4gICAgICBkYXRhLmF0dHJzID0geyAnZGF0YS11Y2knOiBwdi5tb3Zlc1swXSB9O1xuICAgIH1cbiAgICBpZiAobXVsdGlQdiA+IDEpIHtcbiAgICAgIGNoaWxkcmVuLnB1c2goaCgnc3Ryb25nJywgZGVmaW5lZChwdi5tYXRlKSA/ICcjJyArIHB2Lm1hdGUgOiByZW5kZXJFdmFsKHB2LmNwISkpKTtcbiAgICB9XG4gICAgaWYgKHBvcykge1xuICAgICAgY2hpbGRyZW4ucHVzaCguLi5yZW5kZXJQdk1vdmVzKHBvcy5jbG9uZSgpLCBwdi5tb3Zlcy5zbGljZSgwLCBNQVhfTlVNX01PVkVTKSkpO1xuICAgIH1cbiAgfVxuICByZXR1cm4gaCgnZGl2LnB2LnB2LS1ub3dyYXAnLCBkYXRhLCBjaGlsZHJlbik7XG59XG5cbmZ1bmN0aW9uIHJlbmRlclB2V3JhcFRvZ2dsZSgpOiBWTm9kZSB7XG4gIHJldHVybiBoKCdzcGFuLnB2LXdyYXAtdG9nZ2xlJywge1xuICAgIGhvb2s6IHtcbiAgICAgIGluc2VydDogKHZub2RlOiBWTm9kZSkgPT4ge1xuICAgICAgICBjb25zdCBlbCA9IHZub2RlLmVsbSBhcyBIVE1MRWxlbWVudDtcbiAgICAgICAgZm9yIChjb25zdCBldmVudCBvZiBbJ3RvdWNoc3RhcnQnLCAnbW91c2Vkb3duJ10pIHtcbiAgICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKGV2ZW50LCAoZTogRXZlbnQpID0+IHtcbiAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAkKGVsKS5jbG9zZXN0KCcucHYnKS50b2dnbGVDbGFzcygncHYtLW5vd3JhcCcpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgIH0sXG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZW5kZXJQdk1vdmVzKHBvczogUG9zaXRpb24sIHB2OiBVY2lbXSk6IFZOb2RlW10ge1xuICBjb25zdCB2bm9kZXM6IFZOb2RlW10gPSBbXTtcbiAgbGV0IGtleSA9IG1ha2VCb2FyZEZlbihwb3MuYm9hcmQpO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHB2Lmxlbmd0aDsgaSsrKSB7XG4gICAgbGV0IHRleHQ7XG4gICAgaWYgKHBvcy50dXJuID09PSAnd2hpdGUnKSB7XG4gICAgICB0ZXh0ID0gYCR7cG9zLmZ1bGxtb3Zlc30uYDtcbiAgICB9IGVsc2UgaWYgKGkgPT09IDApIHtcbiAgICAgIHRleHQgPSBgJHtwb3MuZnVsbG1vdmVzfS4uLmA7XG4gICAgfVxuICAgIGlmICh0ZXh0KSB7XG4gICAgICB2bm9kZXMucHVzaChoKCdzcGFuJywgeyBrZXk6IHRleHQgfSwgdGV4dCkpO1xuICAgIH1cbiAgICBjb25zdCB1Y2kgPSBwdltpXTtcbiAgICBjb25zdCBzYW4gPSBtYWtlU2FuQW5kUGxheShwb3MsIHBhcnNlVWNpKHVjaSkhKTtcbiAgICBjb25zdCBmZW4gPSBtYWtlQm9hcmRGZW4ocG9zLmJvYXJkKTsgLy8gQ2hlc3Nncm91bmQgdXNlcyBvbmx5IGJvYXJkIGZlblxuICAgIGlmIChzYW4gPT09ICctLScpIHtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBrZXkgKz0gJ3wnICsgdWNpO1xuICAgIHZub2Rlcy5wdXNoKFxuICAgICAgaChcbiAgICAgICAgJ3NwYW4ucHYtc2FuJyxcbiAgICAgICAge1xuICAgICAgICAgIGtleSxcbiAgICAgICAgICBhdHRyczoge1xuICAgICAgICAgICAgJ2RhdGEtbW92ZS1pbmRleCc6IGksXG4gICAgICAgICAgICAnZGF0YS1ib2FyZCc6IGAke2Zlbn18JHt1Y2l9YCxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBzYW5cbiAgICAgIClcbiAgICApO1xuICB9XG4gIHJldHVybiB2bm9kZXM7XG59XG5cbmZ1bmN0aW9uIHJlbmRlclB2Qm9hcmQoY3RybDogUGFyZW50Q3RybCk6IFZOb2RlIHwgdW5kZWZpbmVkIHtcbiAgY29uc3QgaW5zdGFuY2UgPSBjdHJsLmdldENldmFsKCk7XG4gIGNvbnN0IHB2Qm9hcmQgPSBpbnN0YW5jZS5wdkJvYXJkKCk7XG4gIGlmICghcHZCb2FyZCkge1xuICAgIHJldHVybjtcbiAgfVxuICBjb25zdCB7IGZlbiwgdWNpIH0gPSBwdkJvYXJkO1xuICBjb25zdCBvcmllbnRhdGlvbiA9IGN0cmwuZ2V0T3JpZW50YXRpb24oKTtcbiAgY29uc3QgY2dDb25maWcgPSB7XG4gICAgZmVuLFxuICAgIGxhc3RNb3ZlOiB1Y2lUb01vdmUodWNpKSxcbiAgICBvcmllbnRhdGlvbixcbiAgICBjb29yZGluYXRlczogZmFsc2UsXG4gICAgdmlld09ubHk6IHRydWUsXG4gICAgZHJhd2FibGU6IHtcbiAgICAgIGVuYWJsZWQ6IGZhbHNlLFxuICAgICAgdmlzaWJsZTogZmFsc2UsXG4gICAgfSxcbiAgfTtcbiAgY29uc3QgY2dWTm9kZSA9IGgoJ2Rpdi5jZy13cmFwLmlzMmQnLCB7XG4gICAgaG9vazoge1xuICAgICAgaW5zZXJ0OiAodm5vZGU6IGFueSkgPT4gKHZub2RlLmVsbS5fY2cgPSB3aW5kb3cuQ2hlc3Nncm91bmQodm5vZGUuZWxtLCBjZ0NvbmZpZykpLFxuICAgICAgdXBkYXRlOiAodm5vZGU6IGFueSkgPT4gdm5vZGUuZWxtLl9jZy5zZXQoY2dDb25maWcpLFxuICAgICAgZGVzdHJveTogKHZub2RlOiBhbnkpID0+IHZub2RlLmVsbS5fY2cuZGVzdHJveSgpLFxuICAgIH0sXG4gIH0pO1xuICByZXR1cm4gaCgnZGl2LnB2LWJvYXJkJywgaCgnZGl2LnB2LWJvYXJkLXNxdWFyZScsIGNnVk5vZGUpKTtcbn1cbiJdfQ==