import { isAndroid, isIOS, isIPad } from 'common/mobile';
import { pow2floor, sharedWasmMemory } from './util';
// select external > nnue > hce > wasm > asmjs
export function detectPlatform(officialStockfish, enableNnue, externalEngine) {
    let technology = 'asmjs', growableSharedMem = false, supportsNnue = false;
    if (externalEngine)
        technology = 'external';
    else if (typeof WebAssembly === 'object' &&
        typeof WebAssembly.validate === 'function' &&
        WebAssembly.validate(Uint8Array.from([0, 97, 115, 109, 1, 0, 0, 0]))) {
        technology = 'wasm'; // WebAssembly 1.0
        const sharedMem = sendableSharedWasmMemory(1, 2);
        if (sharedMem === null || sharedMem === void 0 ? void 0 : sharedMem.buffer) {
            technology = 'hce';
            try {
                sharedMem.grow(1);
                growableSharedMem = true;
            }
            catch (e) {
                // memory growth not supported
            }
            // i32x4.dot_i16x8_s, i32x4.trunc_sat_f64x2_u_zero
            const sourceWithSimd = Uint8Array.from([0, 97, 115, 109, 1, 0, 0, 0, 1, 12, 2, 96, 2, 123, 123, 1, 123, 96, 1, 123, 1, 123, 3, 3, 2, 0, 1, 7, 9, 2, 1, 97, 0, 0, 1, 98, 0, 1, 10, 19, 2, 9, 0, 32, 0, 32, 1, 253, 186, 1, 11, 7, 0, 32, 0, 253, 253, 1, 11]); // prettier-ignore
            supportsNnue = WebAssembly.validate(sourceWithSimd);
            if (supportsNnue && officialStockfish && enableNnue)
                technology = 'nnue';
        }
    }
    const maxThreads = externalEngine
        ? externalEngine.maxThreads
        : technology == 'nnue' || technology == 'hce'
            ? Math.min(Math.max((navigator.hardwareConcurrency || 1) - 1, 1), growableSharedMem ? 32 : officialStockfish ? 2 : 1)
            : 1;
    // the numbers returned by maxHashMB seem small, but who knows if wasm stockfish performance even
    // scales like native stockfish with increasing hash. prefer smaller, non-crashing values
    // steer the high performance crowd towards external engine as it gets better
    const maxHashMB = () => {
        let maxHash = 256; // this is conservative but safe, mostly desktop firefox / mac safari users here
        if (navigator.deviceMemory)
            maxHash = pow2floor(navigator.deviceMemory * 128); // chrome/edge/opera
        else if (isAndroid())
            maxHash = 64; // budget androids are easy to crash @ 128
        else if (isIPad())
            maxHash = 64; // iPadOS safari pretends to be desktop but acts more like iphone
        else if (isIOS())
            maxHash = 32;
        return maxHash;
    };
    return {
        technology,
        growableSharedMem,
        supportsNnue,
        maxThreads,
        maxWasmPages: (minPages) => {
            if (!growableSharedMem)
                return minPages;
            let maxPages = 32768; // hopefully desktop browser, 2 GB max shared
            if (isAndroid())
                maxPages = 8192; // 512 MB max shared
            else if (isIPad())
                maxPages = 8192; // 512 MB max shared
            else if (isIOS())
                maxPages = 4096; // 256 MB max shared
            return Math.max(minPages, maxPages);
        },
        maxHashSize: () => (technology == 'external' ? (externalEngine === null || externalEngine === void 0 ? void 0 : externalEngine.maxHash) || 16 : maxHashMB()),
    };
}
function sendableSharedWasmMemory(initial, maximum) {
    // Atomics
    if (typeof Atomics !== 'object')
        return;
    // SharedArrayBuffer
    if (typeof SharedArrayBuffer !== 'function')
        return;
    // Shared memory
    const mem = sharedWasmMemory(initial, maximum);
    if (!(mem.buffer instanceof SharedArrayBuffer))
        return;
    // Structured cloning
    try {
        window.postMessage(mem.buffer, '*');
    }
    catch (e) {
        return undefined;
    }
    return mem;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGxhdGZvcm0uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcGxhdGZvcm0udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pELE9BQU8sRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFjckQsOENBQThDO0FBQzlDLE1BQU0sVUFBVSxjQUFjLENBQzVCLGlCQUEwQixFQUMxQixVQUFtQixFQUNuQixjQUErQjtJQUUvQixJQUFJLFVBQVUsR0FBb0IsT0FBTyxFQUN2QyxpQkFBaUIsR0FBRyxLQUFLLEVBQ3pCLFlBQVksR0FBRyxLQUFLLENBQUM7SUFFdkIsSUFBSSxjQUFjO1FBQUUsVUFBVSxHQUFHLFVBQVUsQ0FBQztTQUN2QyxJQUNILE9BQU8sV0FBVyxLQUFLLFFBQVE7UUFDL0IsT0FBTyxXQUFXLENBQUMsUUFBUSxLQUFLLFVBQVU7UUFDMUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFDcEU7UUFDQSxVQUFVLEdBQUcsTUFBTSxDQUFDLENBQUMsa0JBQWtCO1FBQ3ZDLE1BQU0sU0FBUyxHQUFHLHdCQUF3QixDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNqRCxJQUFJLFNBQVMsYUFBVCxTQUFTLHVCQUFULFNBQVMsQ0FBRSxNQUFNLEVBQUU7WUFDckIsVUFBVSxHQUFHLEtBQUssQ0FBQztZQUNuQixJQUFJO2dCQUNGLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2xCLGlCQUFpQixHQUFHLElBQUksQ0FBQzthQUMxQjtZQUFDLE9BQU8sQ0FBQyxFQUFF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QUFDLG9CQUFvQjtpQkFDakQsSUFBSSxNQUFNLEVBQUU7Z0JBQUUsUUFBUSxHQUFHLElBQUksQ0FBQyxDQUFDLG9CQUFvQjtpQkFDbkQsSUFBSSxLQUFLLEVBQUU7Z0JBQUUsUUFBUSxHQUFHLElBQUksQ0FBQyxDQUFDLG9CQUFvQjtZQUN2RCxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3RDLENBQUM7UUFDRCxXQUFXLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxVQUFVLElBQUksVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFBLGNBQWMsYUFBZCxjQUFjLHVCQUFkLGNBQWMsQ0FBRSxPQUFPLEtBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztLQUM1RixDQUFDO0FBQ0osQ0FBQztBQUVELFNBQVMsd0JBQXdCLENBQUMsT0FBZSxFQUFFLE9BQWU7SUFDaEUsVUFBVTtJQUNWLElBQUksT0FBTyxPQUFPLEtBQUssUUFBUTtRQUFFLE9BQU87SUFFeEMsb0JBQW9CO0lBQ3BCLElBQUksT0FBTyxpQkFBaUIsS0FBSyxVQUFVO1FBQUUsT0FBTztJQUVwRCxnQkFBZ0I7SUFDaEIsTUFBTSxHQUFHLEdBQUcsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQy9DLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLFlBQVksaUJBQWlCLENBQUM7UUFBRSxPQUFPO0lBRXZELHFCQUFxQjtJQUNyQixJQUFJO1FBQ0YsTUFBTSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0tBQ3JDO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDVixPQUFPLFNBQVMsQ0FBQztLQUNsQjtJQUNELE9BQU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlzQW5kcm9pZCwgaXNJT1MsIGlzSVBhZCB9IGZyb20gJ2NvbW1vbi9tb2JpbGUnO1xuaW1wb3J0IHsgcG93MmZsb29yLCBzaGFyZWRXYXNtTWVtb3J5IH0gZnJvbSAnLi91dGlsJztcbmltcG9ydCB7IEV4dGVybmFsRW5naW5lIH0gZnJvbSAnLi93b3JrZXInO1xuXG5leHBvcnQgdHlwZSBDZXZhbFRlY2hub2xvZ3kgPSAnYXNtanMnIHwgJ3dhc20nIHwgJ2hjZScgfCAnbm51ZScgfCAnZXh0ZXJuYWwnO1xuXG5leHBvcnQgaW50ZXJmYWNlIENldmFsUGxhdGZvcm0ge1xuICB0ZWNobm9sb2d5OiBDZXZhbFRlY2hub2xvZ3k7XG4gIGdyb3dhYmxlU2hhcmVkTWVtOiBib29sZWFuO1xuICBzdXBwb3J0c05udWU6IGJvb2xlYW47XG4gIG1heFRocmVhZHM6IG51bWJlcjtcbiAgbWF4V2FzbVBhZ2VzOiAobWluUGFnZXM6IG51bWJlcikgPT4gbnVtYmVyO1xuICBtYXhIYXNoU2l6ZTogKCkgPT4gbnVtYmVyO1xufVxuXG4vLyBzZWxlY3QgZXh0ZXJuYWwgPiBubnVlID4gaGNlID4gd2FzbSA+IGFzbWpzXG5leHBvcnQgZnVuY3Rpb24gZGV0ZWN0UGxhdGZvcm0oXG4gIG9mZmljaWFsU3RvY2tmaXNoOiBib29sZWFuLFxuICBlbmFibGVObnVlOiBib29sZWFuLFxuICBleHRlcm5hbEVuZ2luZT86IEV4dGVybmFsRW5naW5lXG4pOiBDZXZhbFBsYXRmb3JtIHtcbiAgbGV0IHRlY2hub2xvZ3k6IENldmFsVGVjaG5vbG9neSA9ICdhc21qcycsXG4gICAgZ3Jvd2FibGVTaGFyZWRNZW0gPSBmYWxzZSxcbiAgICBzdXBwb3J0c05udWUgPSBmYWxzZTtcblxuICBpZiAoZXh0ZXJuYWxFbmdpbmUpIHRlY2hub2xvZ3kgPSAnZXh0ZXJuYWwnO1xuICBlbHNlIGlmIChcbiAgICB0eXBlb2YgV2ViQXNzZW1ibHkgPT09ICdvYmplY3QnICYmXG4gICAgdHlwZW9mIFdlYkFzc2VtYmx5LnZhbGlkYXRlID09PSAnZnVuY3Rpb24nICYmXG4gICAgV2ViQXNzZW1ibHkudmFsaWRhdGUoVWludDhBcnJheS5mcm9tKFswLCA5NywgMTE1LCAxMDksIDEsIDAsIDAsIDBdKSlcbiAgKSB7XG4gICAgdGVjaG5vbG9neSA9ICd3YXNtJzsgLy8gV2ViQXNzZW1ibHkgMS4wXG4gICAgY29uc3Qgc2hhcmVkTWVtID0gc2VuZGFibGVTaGFyZWRXYXNtTWVtb3J5KDEsIDIpO1xuICAgIGlmIChzaGFyZWRNZW0/LmJ1ZmZlcikge1xuICAgICAgdGVjaG5vbG9neSA9ICdoY2UnO1xuICAgICAgdHJ5IHtcbiAgICAgICAgc2hhcmVkTWVtLmdyb3coMSk7XG4gICAgICAgIGdyb3dhYmxlU2hhcmVkTWVtID0gdHJ1ZTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgLy8gbWVtb3J5IGdyb3d0aCBub3Qgc3VwcG9ydGVkXG4gICAgICB9XG4gICAgICAvLyBpMzJ4NC5kb3RfaTE2eDhfcywgaTMyeDQudHJ1bmNfc2F0X2Y2NHgyX3VfemVyb1xuICAgICAgY29uc3Qgc291cmNlV2l0aFNpbWQgPSBVaW50OEFycmF5LmZyb20oWzAsIDk3LCAxMTUsIDEwOSwgMSwgMCwgMCwgMCwgMSwgMTIsIDIsIDk2LCAyLCAxMjMsIDEyMywgMSwgMTIzLCA5NiwgMSwgMTIzLCAxLCAxMjMsIDMsIDMsIDIsIDAsIDEsIDcsIDksIDIsIDEsIDk3LCAwLCAwLCAxLCA5OCwgMCwgMSwgMTAsIDE5LCAyLCA5LCAwLCAzMiwgMCwgMzIsIDEsIDI1MywgMTg2LCAxLCAxMSwgNywgMCwgMzIsIDAsIDI1MywgMjUzLCAxLCAxMV0pOyAvLyBwcmV0dGllci1pZ25vcmVcbiAgICAgIHN1cHBvcnRzTm51ZSA9IFdlYkFzc2VtYmx5LnZhbGlkYXRlKHNvdXJjZVdpdGhTaW1kKTtcbiAgICAgIGlmIChzdXBwb3J0c05udWUgJiYgb2ZmaWNpYWxTdG9ja2Zpc2ggJiYgZW5hYmxlTm51ZSkgdGVjaG5vbG9neSA9ICdubnVlJztcbiAgICB9XG4gIH1cblxuICBjb25zdCBtYXhUaHJlYWRzID0gZXh0ZXJuYWxFbmdpbmVcbiAgICA/IGV4dGVybmFsRW5naW5lLm1heFRocmVhZHNcbiAgICA6IHRlY2hub2xvZ3kgPT0gJ25udWUnIHx8IHRlY2hub2xvZ3kgPT0gJ2hjZSdcbiAgICA/IE1hdGgubWluKFxuICAgICAgICBNYXRoLm1heCgobmF2aWdhdG9yLmhhcmR3YXJlQ29uY3VycmVuY3kgfHwgMSkgLSAxLCAxKSxcbiAgICAgICAgZ3Jvd2FibGVTaGFyZWRNZW0gPyAzMiA6IG9mZmljaWFsU3RvY2tmaXNoID8gMiA6IDFcbiAgICAgIClcbiAgICA6IDE7XG5cbiAgLy8gdGhlIG51bWJlcnMgcmV0dXJuZWQgYnkgbWF4SGFzaE1CIHNlZW0gc21hbGwsIGJ1dCB3aG8ga25vd3MgaWYgd2FzbSBzdG9ja2Zpc2ggcGVyZm9ybWFuY2UgZXZlblxuICAvLyBzY2FsZXMgbGlrZSBuYXRpdmUgc3RvY2tmaXNoIHdpdGggaW5jcmVhc2luZyBoYXNoLiBwcmVmZXIgc21hbGxlciwgbm9uLWNyYXNoaW5nIHZhbHVlc1xuICAvLyBzdGVlciB0aGUgaGlnaCBwZXJmb3JtYW5jZSBjcm93ZCB0b3dhcmRzIGV4dGVybmFsIGVuZ2luZSBhcyBpdCBnZXRzIGJldHRlclxuICBjb25zdCBtYXhIYXNoTUIgPSAoKTogbnVtYmVyID0+IHtcbiAgICBsZXQgbWF4SGFzaCA9IDI1NjsgLy8gdGhpcyBpcyBjb25zZXJ2YXRpdmUgYnV0IHNhZmUsIG1vc3RseSBkZXNrdG9wIGZpcmVmb3ggLyBtYWMgc2FmYXJpIHVzZXJzIGhlcmVcbiAgICBpZiAobmF2aWdhdG9yLmRldmljZU1lbW9yeSkgbWF4SGFzaCA9IHBvdzJmbG9vcihuYXZpZ2F0b3IuZGV2aWNlTWVtb3J5ICogMTI4KTsgLy8gY2hyb21lL2VkZ2Uvb3BlcmFcbiAgICBlbHNlIGlmIChpc0FuZHJvaWQoKSkgbWF4SGFzaCA9IDY0OyAvLyBidWRnZXQgYW5kcm9pZHMgYXJlIGVhc3kgdG8gY3Jhc2ggQCAxMjhcbiAgICBlbHNlIGlmIChpc0lQYWQoKSkgbWF4SGFzaCA9IDY0OyAvLyBpUGFkT1Mgc2FmYXJpIHByZXRlbmRzIHRvIGJlIGRlc2t0b3AgYnV0IGFjdHMgbW9yZSBsaWtlIGlwaG9uZVxuICAgIGVsc2UgaWYgKGlzSU9TKCkpIG1heEhhc2ggPSAzMjtcbiAgICByZXR1cm4gbWF4SGFzaDtcbiAgfTtcblxuICByZXR1cm4ge1xuICAgIHRlY2hub2xvZ3ksXG4gICAgZ3Jvd2FibGVTaGFyZWRNZW0sXG4gICAgc3VwcG9ydHNObnVlLFxuICAgIG1heFRocmVhZHMsXG4gICAgbWF4V2FzbVBhZ2VzOiAobWluUGFnZXM6IG51bWJlcik6IG51bWJlciA9PiB7XG4gICAgICBpZiAoIWdyb3dhYmxlU2hhcmVkTWVtKSByZXR1cm4gbWluUGFnZXM7XG4gICAgICBsZXQgbWF4UGFnZXMgPSAzMjc2ODsgLy8gaG9wZWZ1bGx5IGRlc2t0b3AgYnJvd3NlciwgMiBHQiBtYXggc2hhcmVkXG4gICAgICBpZiAoaXNBbmRyb2lkKCkpIG1heFBhZ2VzID0gODE5MjsgLy8gNTEyIE1CIG1heCBzaGFyZWRcbiAgICAgIGVsc2UgaWYgKGlzSVBhZCgpKSBtYXhQYWdlcyA9IDgxOTI7IC8vIDUxMiBNQiBtYXggc2hhcmVkXG4gICAgICBlbHNlIGlmIChpc0lPUygpKSBtYXhQYWdlcyA9IDQwOTY7IC8vIDI1NiBNQiBtYXggc2hhcmVkXG4gICAgICByZXR1cm4gTWF0aC5tYXgobWluUGFnZXMsIG1heFBhZ2VzKTtcbiAgICB9LFxuICAgIG1heEhhc2hTaXplOiAoKSA9PiAodGVjaG5vbG9neSA9PSAnZXh0ZXJuYWwnID8gZXh0ZXJuYWxFbmdpbmU/Lm1heEhhc2ggfHwgMTYgOiBtYXhIYXNoTUIoKSksXG4gIH07XG59XG5cbmZ1bmN0aW9uIHNlbmRhYmxlU2hhcmVkV2FzbU1lbW9yeShpbml0aWFsOiBudW1iZXIsIG1heGltdW06IG51bWJlcik6IFdlYkFzc2VtYmx5Lk1lbW9yeSB8IHVuZGVmaW5lZCB7XG4gIC8vIEF0b21pY3NcbiAgaWYgKHR5cGVvZiBBdG9taWNzICE9PSAnb2JqZWN0JykgcmV0dXJuO1xuXG4gIC8vIFNoYXJlZEFycmF5QnVmZmVyXG4gIGlmICh0eXBlb2YgU2hhcmVkQXJyYXlCdWZmZXIgIT09ICdmdW5jdGlvbicpIHJldHVybjtcblxuICAvLyBTaGFyZWQgbWVtb3J5XG4gIGNvbnN0IG1lbSA9IHNoYXJlZFdhc21NZW1vcnkoaW5pdGlhbCwgbWF4aW11bSk7XG4gIGlmICghKG1lbS5idWZmZXIgaW5zdGFuY2VvZiBTaGFyZWRBcnJheUJ1ZmZlcikpIHJldHVybjtcblxuICAvLyBTdHJ1Y3R1cmVkIGNsb25pbmdcbiAgdHJ5IHtcbiAgICB3aW5kb3cucG9zdE1lc3NhZ2UobWVtLmJ1ZmZlciwgJyonKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbiAgcmV0dXJuIG1lbTtcbn1cbiJdfQ==