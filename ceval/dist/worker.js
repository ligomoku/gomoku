import { Protocol } from './protocol';
import { randomToken } from 'common/random';
import { readNdJson } from 'common/ndjson';
export var CevalState;
(function (CevalState) {
    CevalState[CevalState["Initial"] = 0] = "Initial";
    CevalState[CevalState["Loading"] = 1] = "Loading";
    CevalState[CevalState["Idle"] = 2] = "Idle";
    CevalState[CevalState["Computing"] = 3] = "Computing";
    CevalState[CevalState["Failed"] = 4] = "Failed";
})(CevalState || (CevalState = {}));
export class WebWorker {
    constructor(opts, redraw) {
        this.opts = opts;
        this.redraw = redraw;
        this.failed = false;
        this.protocol = new Protocol();
    }
    getState() {
        return !this.worker
            ? CevalState.Initial
            : this.failed
                ? CevalState.Failed
                : !this.protocol.engineName
                    ? CevalState.Loading
                    : this.protocol.isComputing()
                        ? CevalState.Computing
                        : CevalState.Idle;
    }
    start(work) {
        this.protocol.compute(work);
        if (!this.worker) {
            this.worker = new Worker(lichess.assetUrl(this.opts.url, { sameDomain: true }));
            this.worker.addEventListener('message', e => this.protocol.received(e.data), true);
            this.worker.addEventListener('error', err => {
                console.error(err);
                this.failed = true;
                this.redraw();
            }, true);
            this.protocol.connected(cmd => { var _a; return (_a = this.worker) === null || _a === void 0 ? void 0 : _a.postMessage(cmd); });
        }
    }
    stop() {
        this.protocol.compute(undefined);
    }
    engineName() {
        return this.protocol.engineName;
    }
    destroy() {
        var _a;
        (_a = this.worker) === null || _a === void 0 ? void 0 : _a.terminate();
    }
}
export class ThreadedWasmWorker {
    constructor(opts, redraw) {
        this.opts = opts;
        this.redraw = redraw;
    }
    getState() {
        return !ThreadedWasmWorker.sf[this.opts.module]
            ? CevalState.Initial
            : ThreadedWasmWorker.failed[this.opts.module]
                ? CevalState.Failed
                : !this.getProtocol().engineName
                    ? CevalState.Loading
                    : this.getProtocol().isComputing()
                        ? CevalState.Computing
                        : CevalState.Idle;
    }
    getProtocol() {
        return ThreadedWasmWorker.protocols[this.opts.module];
    }
    async boot() {
        const version = this.opts.version;
        const cache = this.opts.cache;
        // Fetch WASM file ourselves, for caching and progress indication.
        let wasmBinary;
        if (cache) {
            const wasmPath = this.opts.baseUrl + 'stockfish.wasm';
            try {
                const [found, data] = await cache.get(wasmPath, version);
                if (found)
                    wasmBinary = data;
            }
            catch (e) {
                console.log('ceval: idb cache load failed:', e);
            }
            if (!wasmBinary) {
                wasmBinary = await new Promise((resolve, reject) => {
                    const req = new XMLHttpRequest();
                    req.open('GET', lichess.assetUrl(wasmPath, { version }), true);
                    req.responseType = 'arraybuffer';
                    req.onerror = event => reject(event);
                    req.onprogress = event => { var _a, _b; return (_b = (_a = this.opts).downloadProgress) === null || _b === void 0 ? void 0 : _b.call(_a, event.loaded); };
                    req.onload = _ => {
                        var _a, _b;
                        (_b = (_a = this.opts).downloadProgress) === null || _b === void 0 ? void 0 : _b.call(_a, 0);
                        resolve(req.response);
                    };
                    req.send();
                });
            }
            try {
                await cache.set(wasmPath, version, wasmBinary);
            }
            catch (e) {
                console.log('ceval: idb cache store failed:', e);
            }
        }
        // Load Emscripten module.
        await lichess.loadScript(this.opts.baseUrl + 'stockfish.js', { version });
        const sf = await window[this.opts.module]({
            wasmBinary,
            locateFile: (path) => lichess.assetUrl(this.opts.baseUrl + path, { version, sameDomain: path.endsWith('.worker.js') }),
            wasmMemory: this.opts.wasmMemory,
        });
        const protocol = this.getProtocol();
        sf.addMessageListener(protocol.received.bind(protocol));
        protocol.connected(msg => sf.postMessage(msg));
        return sf;
    }
    start(work) {
        this.getProtocol().compute(work);
        if (!ThreadedWasmWorker.sf[this.opts.module]) {
            ThreadedWasmWorker.sf[this.opts.module] = this.boot().then(() => { }, err => {
                console.error(err);
                ThreadedWasmWorker.failed[this.opts.module] = true;
                this.redraw();
            });
        }
    }
    stop() {
        this.getProtocol().compute(undefined);
    }
    engineName() {
        return this.getProtocol().engineName;
    }
    destroy() {
        // Terminated instances to not get freed reliably
        // (https://github.com/lichess-org/lila/issues/7334). So instead of
        // destroying, just stop instances and keep them around for reuse.
        this.stop();
    }
}
ThreadedWasmWorker.failed = { Stockfish: false, StockfishMv: false };
ThreadedWasmWorker.protocols = { Stockfish: new Protocol(), StockfishMv: new Protocol() };
ThreadedWasmWorker.sf = {};
export class ExternalWorker {
    constructor(opts, redraw) {
        this.opts = opts;
        this.redraw = redraw;
        this.state = CevalState.Initial;
        this.sessionId = randomToken();
    }
    getState() {
        return this.state;
    }
    start(work) {
        this.stop();
        this.state = CevalState.Loading;
        this.req = new AbortController();
        this.analyse(work, this.req.signal);
    }
    async analyse(work, signal) {
        try {
            const url = new URL(`${this.opts.endpoint}/api/external-engine/${this.opts.id}/analyse`);
            const infinite = work.maxDepth >= 99;
            const res = await fetch(url.href, {
                signal,
                method: 'post',
                cache: 'default',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'omit',
                body: JSON.stringify({
                    clientSecret: this.opts.clientSecret,
                    work: {
                        sessionId: this.sessionId,
                        threads: work.threads,
                        hash: work.hashSize || 16,
                        infinite,
                        multiPv: work.multiPv,
                        variant: work.variant,
                        initialFen: work.initialFen,
                        moves: work.moves,
                    },
                }),
            });
            await readNdJson(res, line => {
                var _a, _b, _c;
                this.state = CevalState.Computing;
                work.emit({
                    fen: work.currentFen,
                    maxDepth: infinite ? 99 : this.opts.defaultDepth,
                    depth: ((_a = line.pvs[0]) === null || _a === void 0 ? void 0 : _a.depth) || 0,
                    knps: line.nodes / Math.max(line.time, 1),
                    nodes: line.nodes,
                    cp: (_b = line.pvs[0]) === null || _b === void 0 ? void 0 : _b.cp,
                    mate: (_c = line.pvs[0]) === null || _c === void 0 ? void 0 : _c.mate,
                    millis: line.time,
                    pvs: line.pvs,
                });
            });
            this.state = CevalState.Initial;
        }
        catch (err) {
            if (err.name !== 'AbortError') {
                this.state = CevalState.Failed;
            }
            else {
                this.state = CevalState.Initial;
            }
        }
        this.redraw();
    }
    stop() {
        var _a;
        (_a = this.req) === null || _a === void 0 ? void 0 : _a.abort();
    }
    engineName() {
        return this.opts.name;
    }
    destroy() {
        this.stop();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid29ya2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3dvcmtlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBRXRDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDNUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxNQUFNLENBQU4sSUFBWSxVQU1YO0FBTkQsV0FBWSxVQUFVO0lBQ3BCLGlEQUFPLENBQUE7SUFDUCxpREFBTyxDQUFBO0lBQ1AsMkNBQUksQ0FBQTtJQUNKLHFEQUFTLENBQUE7SUFDVCwrQ0FBTSxDQUFBO0FBQ1IsQ0FBQyxFQU5XLFVBQVUsS0FBVixVQUFVLFFBTXJCO0FBY0QsTUFBTSxPQUFPLFNBQVM7SUFLcEIsWUFBb0IsSUFBbUIsRUFBVSxNQUFjO1FBQTNDLFNBQUksR0FBSixJQUFJLENBQWU7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBSnZELFdBQU0sR0FBRyxLQUFLLENBQUM7UUFDZixhQUFRLEdBQUcsSUFBSSxRQUFRLEVBQUUsQ0FBQztJQUdnQyxDQUFDO0lBRW5FLFFBQVE7UUFDTixPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU07WUFDakIsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxPQUFPO1lBQ3BCLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTTtnQkFDYixDQUFDLENBQUMsVUFBVSxDQUFDLE1BQU07Z0JBQ25CLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVTtvQkFDM0IsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxPQUFPO29CQUNwQixDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLEVBQUU7d0JBQzdCLENBQUMsQ0FBQyxVQUFVLENBQUMsU0FBUzt3QkFDdEIsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUM7SUFDdEIsQ0FBQztJQUVELEtB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O1lBRUgsSUFBSSxDQUFDLEtBQUssR0FBRyxVQUFVLENBQUMsT0FBTyxDQUFDO1NBQ2pDO1FBQUMsT0FBTyxHQUFZLEVBQUU7WUFDckIsSUFBSyxHQUFhLENBQUMsSUFBSSxLQUFLLFlBQVksRUFBRTtnQkFDeEMsSUFBSSxDQUFDLEtBQUssR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDO2FBQ2hDO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxLQUFLLEdBQUcsVUFBVSxDQUFDLE9BQU8sQ0FBQzthQUNqQztTQUNGO1FBRUQsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQ2hCLENBQUM7SUFFRCxJQUFJOztRQUNGLE1BQUEsSUFBSSxDQUFDLEdBQUcsMENBQUUsS0FBSyxFQUFFLENBQUM7SUFDcEIsQ0FBQztJQUVELFVBQVU7UUFDUixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ3hCLENBQUM7SUFFRCxPQUFPO1FBQ0wsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2QsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgV29yaywgUmVkcmF3IH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgeyBQcm90b2NvbCB9IGZyb20gJy4vcHJvdG9jb2wnO1xuaW1wb3J0IHsgQ2FjaGUgfSBmcm9tICcuL2NhY2hlJztcbmltcG9ydCB7IHJhbmRvbVRva2VuIH0gZnJvbSAnY29tbW9uL3JhbmRvbSc7XG5pbXBvcnQgeyByZWFkTmRKc29uIH0gZnJvbSAnY29tbW9uL25kanNvbic7XG5cbmV4cG9ydCBlbnVtIENldmFsU3RhdGUge1xuICBJbml0aWFsLFxuICBMb2FkaW5nLFxuICBJZGxlLFxuICBDb21wdXRpbmcsXG4gIEZhaWxlZCxcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDZXZhbFdvcmtlciB7XG4gIGdldFN0YXRlKCk6IENldmFsU3RhdGU7XG4gIHN0YXJ0KHdvcms6IFdvcmspOiB2b2lkO1xuICBzdG9wKCk6IHZvaWQ7XG4gIGVuZ2luZU5hbWUoKTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBkZXN0cm95KCk6IHZvaWQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgV2ViV29ya2VyT3B0cyB7XG4gIHVybDogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgV2ViV29ya2VyIGltcGxlbWVudHMgQ2V2YWxXb3JrZXIge1xuICBwcml2YXRlIGZhaWxlZCA9IGZhbHNlO1xuICBwcml2YXRlIHByb3RvY29sID0gbmV3IFByb3RvY29sKCk7XG4gIHByaXZhdGUgd29ya2VyOiBXb3JrZXIgfCB1bmRlZmluZWQ7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBvcHRzOiBXZWJXb3JrZXJPcHRzLCBwcml2YXRlIHJlZHJhdzogUmVkcmF3KSB7fVxuXG4gIGdldFN0YXRlKCkge1xuICAgIHJldHVybiAhdGhpcy53b3JrZXJcbiAgICAgID8gQ2V2YWxTdGF0ZS5Jbml0aWFsXG4gICAgICA6IHRoaXMuZmFpbGVkXG4gICAgICA/IENldmFsU3RhdGUuRmFpbGVkXG4gICAgICA6ICF0aGlzLnByb3RvY29sLmVuZ2luZU5hbWVcbiAgICAgID8gQ2V2YWxTdGF0ZS5Mb2FkaW5nXG4gICAgICA6IHRoaXMucHJvdG9jb2wuaXNDb21wdXRpbmcoKVxuICAgICAgPyBDZXZhbFN0YXRlLkNvbXB1dGluZ1xuICAgICAgOiBDZXZhbFN0YXRlLklkbGU7XG4gIH1cblxuICBzdGFydCh3b3JrOiBXb3JrKSB7XG4gICAgdGhpcy5wcm90b2NvbC5jb21wdXRlKHdvcmspO1xuXG4gICAgaWYgKCF0aGlzLndvcmtlcikge1xuICAgICAgdGhpcy53b3JrZXIgPSBuZXcgV29ya2VyKGxpY2hlc3MuYXNzZXRVcmwodGhpcy5vcHRzLnVybCwgeyBzYW1lRG9tYWluOiB0cnVlIH0pKTtcbiAgICAgIHRoaXMud29ya2VyLmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBlID0+IHRoaXMucHJvdG9jb2wucmVjZWl2ZWQoZS5kYXRhKSwgdHJ1ZSk7XG4gICAgICB0aGlzLndvcmtlci5hZGRFdmVudExpc3RlbmVyKFxuICAgICAgICAnZXJyb3InLFxuICAgICAgICBlcnIgPT4ge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICAgICAgICB0aGlzLmZhaWxlZCA9IHRydWU7XG4gICAgICAgICAgdGhpcy5yZWRyYXcoKTtcbiAgICAgICAgfSxcbiAgICAgICAgdHJ1ZVxuICAgICAgKTtcbiAgICAgIHRoaXMucHJvdG9jb2wuY29ubmVjdGVkKGNtZCA9PiB0aGlzLndvcmtlcj8ucG9zdE1lc3NhZ2UoY21kKSk7XG4gICAgfVxuICB9XG5cbiAgc3RvcCgpIHtcbiAgICB0aGlzLnByb3RvY29sLmNvbXB1dGUodW5kZWZpbmVkKTtcbiAgfVxuXG4gIGVuZ2luZU5hbWUoKSB7XG4gICAgcmV0dXJuIHRoaXMucHJvdG9jb2wuZW5naW5lTmFtZTtcbiAgfVxuXG4gIGRlc3Ryb3koKSB7XG4gICAgdGhpcy53b3JrZXI/LnRlcm1pbmF0ZSgpO1xuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVGhyZWFkZWRXYXNtV29ya2VyT3B0cyB7XG4gIGJhc2VVcmw6IHN0cmluZztcbiAgbW9kdWxlOiAnU3RvY2tmaXNoJyB8ICdTdG9ja2Zpc2hNdic7XG4gIHZlcnNpb246IHN0cmluZztcbiAgZG93bmxvYWRQcm9ncmVzcz86IChtYjogbnVtYmVyKSA9PiB2b2lkO1xuICB3YXNtTWVtb3J5OiBXZWJBc3NlbWJseS5NZW1vcnk7XG4gIGNhY2hlPzogQ2FjaGU7XG59XG5cbmludGVyZmFjZSBXYXNtU3RvY2tmaXNoTW9kdWxlIHtcbiAgKG9wdHM6IHtcbiAgICB3YXNtQmluYXJ5PzogQXJyYXlCdWZmZXI7XG4gICAgbG9jYXRlRmlsZShwYXRoOiBzdHJpbmcpOiBzdHJpbmc7XG4gICAgd2FzbU1lbW9yeTogV2ViQXNzZW1ibHkuTWVtb3J5O1xuICB9KTogUHJvbWlzZTxTdG9ja2Zpc2g+O1xufVxuXG5pbnRlcmZhY2UgU3RvY2tmaXNoIHtcbiAgYWRkTWVzc2FnZUxpc3RlbmVyKGNiOiAobXNnOiBzdHJpbmcpID0+IHZvaWQpOiB2b2lkO1xuICBwb3N0TWVzc2FnZShtc2c6IHN0cmluZyk6IHZvaWQ7XG59XG5cbmRlY2xhcmUgZ2xvYmFsIHtcbiAgaW50ZXJmYWNlIFdpbmRvdyB7XG4gICAgU3RvY2tmaXNoPzogV2FzbVN0b2NrZmlzaE1vZHVsZTtcbiAgICBTdG9ja2Zpc2hNdj86IFdhc21TdG9ja2Zpc2hNb2R1bGU7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFRocmVhZGVkV2FzbVdvcmtlciBpbXBsZW1lbnRzIENldmFsV29ya2VyIHtcbiAgcHJpdmF0ZSBzdGF0aWMgZmFpbGVkOiB7IFN0b2NrZmlzaDogYm9vbGVhbjsgU3RvY2tmaXNoTXY6IGJvb2xlYW4gfSA9IHsgU3RvY2tmaXNoOiBmYWxzZSwgU3RvY2tmaXNoTXY6IGZhbHNlIH07XG4gIHByaXZhdGUgc3RhdGljIHByb3RvY29scyA9IHsgU3RvY2tmaXNoOiBuZXcgUHJvdG9jb2woKSwgU3RvY2tmaXNoTXY6IG5ldyBQcm90b2NvbCgpIH07XG4gIHByaXZhdGUgc3RhdGljIHNmOiB7IFN0b2NrZmlzaD86IFByb21pc2U8dm9pZD47IFN0b2NrZmlzaE12PzogUHJvbWlzZTx2b2lkPiB9ID0ge307XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBvcHRzOiBUaHJlYWRlZFdhc21Xb3JrZXJPcHRzLCBwcml2YXRlIHJlZHJhdzogUmVkcmF3KSB7fVxuXG4gIGdldFN0YXRlKCkge1xuICAgIHJldHVybiAhVGhyZWFkZWRXYXNtV29ya2VyLnNmW3RoaXMub3B0cy5tb2R1bGVdXG4gICAgICA/IENldmFsU3RhdGUuSW5pdGlhbFxuICAgICAgOiBUaHJlYWRlZFdhc21Xb3JrZXIuZmFpbGVkW3RoaXMub3B0cy5tb2R1bGVdXG4gICAgICA/IENldmFsU3RhdGUuRmFpbGVkXG4gICAgICA6ICF0aGlzLmdldFByb3RvY29sKCkuZW5naW5lTmFtZVxuICAgICAgPyBDZXZhbFN0YXRlLkxvYWRpbmdcbiAgICAgIDogdGhpcy5nZXRQcm90b2NvbCgpLmlzQ29tcHV0aW5nKClcbiAgICAgID8gQ2V2YWxTdGF0ZS5Db21wdXRpbmdcbiAgICAgIDogQ2V2YWxTdGF0ZS5JZGxlO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRQcm90b2NvbCgpOiBQcm90b2NvbCB7XG4gICAgcmV0dXJuIFRocmVhZGVkV2FzbVdvcmtlci5wcm90b2NvbHNbdGhpcy5vcHRzLm1vZHVsZV07XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGJvb3QoKTogUHJvbWlzZTxTdG9ja2Zpc2g+IHtcbiAgICBjb25zdCB2ZXJzaW9uID0gdGhpcy5vcHRzLnZlcnNpb247XG4gICAgY29uc3QgY2FjaGUgPSB0aGlzLm9wdHMuY2FjaGU7XG5cbiAgICAvLyBGZXRjaCBXQVNNIGZpbGUgb3Vyc2VsdmVzLCBmb3IgY2FjaGluZyBhbmQgcHJvZ3Jlc3MgaW5kaWNhdGlvbi5cbiAgICBsZXQgd2FzbUJpbmFyeTogQXJyYXlCdWZmZXIgfCB1bmRlZmluZWQ7XG4gICAgaWYgKGNhY2hlKSB7XG4gICAgICBjb25zdCB3YXNtUGF0aCA9IHRoaXMub3B0cy5iYXNlVXJsICsgJ3N0b2NrZmlzaC53YXNtJztcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IFtmb3VuZCwgZGF0YV0gPSBhd2FpdCBjYWNoZS5nZXQod2FzbVBhdGgsIHZlcnNpb24pO1xuICAgICAgICBpZiAoZm91bmQpIHdhc21CaW5hcnkgPSBkYXRhO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmxvZygnY2V2YWw6IGlkYiBjYWNoZSBsb2FkIGZhaWxlZDonLCBlKTtcbiAgICAgIH1cbiAgICAgIGlmICghd2FzbUJpbmFyeSkge1xuICAgICAgICB3YXNtQmluYXJ5ID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHJlcSA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgICAgICAgIHJlcS5vcGVuKCdHRVQnLCBsaWNoZXNzLmFzc2V0VXJsKHdhc21QYXRoLCB7IHZlcnNpb24gfSksIHRydWUpO1xuICAgICAgICAgIHJlcS5yZXNwb25zZVR5cGUgPSAnYXJyYXlidWZmZXInO1xuICAgICAgICAgIHJlcS5vbmVycm9yID0gZXZlbnQgPT4gcmVqZWN0KGV2ZW50KTtcbiAgICAgICAgICByZXEub25wcm9ncmVzcyA9IGV2ZW50ID0+IHRoaXMub3B0cy5kb3dubG9hZFByb2dyZXNzPy4oZXZlbnQubG9hZGVkKTtcbiAgICAgICAgICByZXEub25sb2FkID0gXyA9PiB7XG4gICAgICAgICAgICB0aGlzLm9wdHMuZG93bmxvYWRQcm9ncmVzcz8uKDApO1xuICAgICAgICAgICAgcmVzb2x2ZShyZXEucmVzcG9uc2UpO1xuICAgICAgICAgIH07XG4gICAgICAgICAgcmVxLnNlbmQoKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBjYWNoZS5zZXQod2FzbVBhdGgsIHZlcnNpb24sIHdhc21CaW5hcnkpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmxvZygnY2V2YWw6IGlkYiBjYWNoZSBzdG9yZSBmYWlsZWQ6JywgZSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gTG9hZCBFbXNjcmlwdGVuIG1vZHVsZS5cbiAgICBhd2FpdCBsaWNoZXNzLmxvYWRTY3JpcHQodGhpcy5vcHRzLmJhc2VVcmwgKyAnc3RvY2tmaXNoLmpzJywgeyB2ZXJzaW9uIH0pO1xuICAgIGNvbnN0IHNmID0gYXdhaXQgd2luZG93W3RoaXMub3B0cy5tb2R1bGVdISh7XG4gICAgICB3YXNtQmluYXJ5LFxuICAgICAgbG9jYXRlRmlsZTogKHBhdGg6IHN0cmluZykgPT5cbiAgICAgICAgbGljaGVzcy5hc3NldFVybCh0aGlzLm9wdHMuYmFzZVVybCArIHBhdGgsIHsgdmVyc2lvbiwgc2FtZURvbWFpbjogcGF0aC5lbmRzV2l0aCgnLndvcmtlci5qcycpIH0pLFxuICAgICAgd2FzbU1lbW9yeTogdGhpcy5vcHRzLndhc21NZW1vcnksXG4gICAgfSk7XG5cbiAgICBjb25zdCBwcm90b2NvbCA9IHRoaXMuZ2V0UHJvdG9jb2woKTtcbiAgICBzZi5hZGRNZXNzYWdlTGlzdGVuZXIocHJvdG9jb2wucmVjZWl2ZWQuYmluZChwcm90b2NvbCkpO1xuICAgIHByb3RvY29sLmNvbm5lY3RlZChtc2cgPT4gc2YucG9zdE1lc3NhZ2UobXNnKSk7XG4gICAgcmV0dXJuIHNmO1xuICB9XG5cbiAgc3RhcnQod29yazogV29yaykge1xuICAgIHRoaXMuZ2V0UHJvdG9jb2woKS5jb21wdXRlKHdvcmspO1xuXG4gICAgaWYgKCFUaHJlYWRlZFdhc21Xb3JrZXIuc2ZbdGhpcy5vcHRzLm1vZHVsZV0pIHtcbiAgICAgIFRocmVhZGVkV2FzbVdvcmtlci5zZlt0aGlzLm9wdHMubW9kdWxlXSA9IHRoaXMuYm9vdCgpLnRoZW4oXG4gICAgICAgICgpID0+IHt9LFxuICAgICAgICBlcnIgPT4ge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICAgICAgICBUaHJlYWRlZFdhc21Xb3JrZXIuZmFpbGVkW3RoaXMub3B0cy5tb2R1bGVdID0gdHJ1ZTtcbiAgICAgICAgICB0aGlzLnJlZHJhdygpO1xuICAgICAgICB9XG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHN0b3AoKSB7XG4gICAgdGhpcy5nZXRQcm90b2NvbCgpLmNvbXB1dGUodW5kZWZpbmVkKTtcbiAgfVxuXG4gIGVuZ2luZU5hbWUoKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0UHJvdG9jb2woKS5lbmdpbmVOYW1lO1xuICB9XG5cbiAgZGVzdHJveSgpIHtcbiAgICAvLyBUZXJtaW5hdGVkIGluc3RhbmNlcyB0byBub3QgZ2V0IGZyZWVkIHJlbGlhYmx5XG4gICAgLy8gKGh0dHBzOi8vZ2l0aHViLmNvbS9saWNoZXNzLW9yZy9saWxhL2lzc3Vlcy83MzM0KS4gU28gaW5zdGVhZCBvZlxuICAgIC8vIGRlc3Ryb3lpbmcsIGp1c3Qgc3RvcCBpbnN0YW5jZXMgYW5kIGtlZXAgdGhlbSBhcm91bmQgZm9yIHJldXNlLlxuICAgIHRoaXMuc3RvcCgpO1xuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXh0ZXJuYWxFbmdpbmUge1xuICBpZDogc3RyaW5nO1xuICBuYW1lOiBzdHJpbmc7XG4gIHZhcmlhbnRzOiBWYXJpYW50S2V5W107XG4gIG1heFRocmVhZHM6IG51bWJlcjtcbiAgbWF4SGFzaDogbnVtYmVyO1xuICBkZWZhdWx0RGVwdGg6IG51bWJlcjtcbiAgY2xpZW50U2VjcmV0OiBzdHJpbmc7XG4gIG9mZmljaWFsU3RvY2tmaXNoPzogYm9vbGVhbjtcbiAgZW5kcG9pbnQ6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIEV4dGVybmFsRW5naW5lT3V0cHV0IHtcbiAgdGltZTogbnVtYmVyO1xuICBkZXB0aDogbnVtYmVyO1xuICBub2RlczogbnVtYmVyO1xuICBwdnM6IHtcbiAgICBkZXB0aDogbnVtYmVyO1xuICAgIGNwPzogbnVtYmVyO1xuICAgIG1hdGU/OiBudW1iZXI7XG4gICAgbW92ZXM6IFVjaVtdO1xuICB9W107XG59XG5cbmV4cG9ydCBjbGFzcyBFeHRlcm5hbFdvcmtlciBpbXBsZW1lbnRzIENldmFsV29ya2VyIHtcbiAgcHJpdmF0ZSBzdGF0ZSA9IENldmFsU3RhdGUuSW5pdGlhbDtcbiAgcHJpdmF0ZSBzZXNzaW9uSWQgPSByYW5kb21Ub2tlbigpO1xuICBwcml2YXRlIHJlcTogQWJvcnRDb250cm9sbGVyIHwgdW5kZWZpbmVkO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgb3B0czogRXh0ZXJuYWxFbmdpbmUsIHByaXZhdGUgcmVkcmF3OiBSZWRyYXcpIHt9XG5cbiAgZ2V0U3RhdGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhdGU7XG4gIH1cblxuICBzdGFydCh3b3JrOiBXb3JrKSB7XG4gICAgdGhpcy5zdG9wKCk7XG4gICAgdGhpcy5zdGF0ZSA9IENldmFsU3RhdGUuTG9hZGluZztcblxuICAgIHRoaXMucmVxID0gbmV3IEFib3J0Q29udHJvbGxlcigpO1xuICAgIHRoaXMuYW5hbHlzZSh3b3JrLCB0aGlzLnJlcS5zaWduYWwpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBhbmFseXNlKHdvcms6IFdvcmssIHNpZ25hbDogQWJvcnRTaWduYWwpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXJsID0gbmV3IFVSTChgJHt0aGlzLm9wdHMuZW5kcG9pbnR9L2FwaS9leHRlcm5hbC1lbmdpbmUvJHt0aGlzLm9wdHMuaWR9L2FuYWx5c2VgKTtcbiAgICAgIGNvbnN0IGluZmluaXRlID0gd29yay5tYXhEZXB0aCA+PSA5OTtcbiAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKHVybC5ocmVmLCB7XG4gICAgICAgIHNpZ25hbCxcbiAgICAgICAgbWV0aG9kOiAncG9zdCcsXG4gICAgICAgIGNhY2hlOiAnZGVmYXVsdCcsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICB9LFxuICAgICAgICBjcmVkZW50aWFsczogJ29taXQnLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgY2xpZW50U2VjcmV0OiB0aGlzLm9wdHMuY2xpZW50U2VjcmV0LFxuICAgICAgICAgIHdvcms6IHtcbiAgICAgICAgICAgIHNlc3Npb25JZDogdGhpcy5zZXNzaW9uSWQsXG4gICAgICAgICAgICB0aHJlYWRzOiB3b3JrLnRocmVhZHMsXG4gICAgICAgICAgICBoYXNoOiB3b3JrLmhhc2hTaXplIHx8IDE2LFxuICAgICAgICAgICAgaW5maW5pdGUsXG4gICAgICAgICAgICBtdWx0aVB2OiB3b3JrLm11bHRpUHYsXG4gICAgICAgICAgICB2YXJpYW50OiB3b3JrLnZhcmlhbnQsXG4gICAgICAgICAgICBpbml0aWFsRmVuOiB3b3JrLmluaXRpYWxGZW4sXG4gICAgICAgICAgICBtb3Zlczogd29yay5tb3ZlcyxcbiAgICAgICAgICB9LFxuICAgICAgICB9KSxcbiAgICAgIH0pO1xuXG4gICAgICBhd2FpdCByZWFkTmRKc29uPEV4dGVybmFsRW5naW5lT3V0cHV0PihyZXMsIGxpbmUgPT4ge1xuICAgICAgICB0aGlzLnN0YXRlID0gQ2V2YWxTdGF0ZS5Db21wdXRpbmc7XG4gICAgICAgIHdvcmsuZW1pdCh7XG4gICAgICAgICAgZmVuOiB3b3JrLmN1cnJlbnRGZW4sXG4gICAgICAgICAgbWF4RGVwdGg6IGluZmluaXRlID8gOTkgOiB0aGlzLm9wdHMuZGVmYXVsdERlcHRoLFxuICAgICAgICAgIGRlcHRoOiBsaW5lLnB2c1swXT8uZGVwdGggfHwgMCxcbiAgICAgICAgICBrbnBzOiBsaW5lLm5vZGVzIC8gTWF0aC5tYXgobGluZS50aW1lLCAxKSxcbiAgICAgICAgICBub2RlczogbGluZS5ub2RlcyxcbiAgICAgICAgICBjcDogbGluZS5wdnNbMF0/LmNwLFxuICAgICAgICAgIG1hdGU6IGxpbmUucHZzWzBdPy5tYXRlLFxuICAgICAgICAgIG1pbGxpczogbGluZS50aW1lLFxuICAgICAgICAgIHB2czogbGluZS5wdnMsXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuc3RhdGUgPSBDZXZhbFN0YXRlLkluaXRpYWw7XG4gICAgfSBjYXRjaCAoZXJyOiB1bmtub3duKSB7XG4gICAgICBpZiAoKGVyciBhcyBFcnJvcikubmFtZSAhPT0gJ0Fib3J0RXJyb3InKSB7XG4gICAgICAgIHRoaXMuc3RhdGUgPSBDZXZhbFN0YXRlLkZhaWxlZDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuc3RhdGUgPSBDZXZhbFN0YXRlLkluaXRpYWw7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5yZWRyYXcoKTtcbiAgfVxuXG4gIHN0b3AoKSB7XG4gICAgdGhpcy5yZXE/LmFib3J0KCk7XG4gIH1cblxuICBlbmdpbmVOYW1lKCkge1xuICAgIHJldHVybiB0aGlzLm9wdHMubmFtZTtcbiAgfVxuXG4gIGRlc3Ryb3koKSB7XG4gICAgdGhpcy5zdG9wKCk7XG4gIH1cbn1cbiJdfQ==