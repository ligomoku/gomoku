import * as treePath from './path';
import * as ops from './ops';
import { defined } from 'common';
export function build(root) {
    const lastNode = () => ops.findInMainline(root, (node) => !node.children.length);
    const nodeAtPath = (path) => nodeAtPathFrom(root, path);
    function nodeAtPathFrom(node, path) {
        if (path === '')
            return node;
        const child = ops.childById(node, treePath.head(path));
        return child ? nodeAtPathFrom(child, treePath.tail(path)) : node;
    }
    const nodeAtPathOrNull = (path) => nodeAtPathOrNullFrom(root, path);
    function nodeAtPathOrNullFrom(node, path) {
        if (path === '')
            return node;
        const child = ops.childById(node, treePath.head(path));
        return child ? nodeAtPathOrNullFrom(child, treePath.tail(path)) : undefined;
    }
    function longestValidPathFrom(node, path) {
        const id = treePath.head(path);
        const child = ops.childById(node, id);
        return child ? id + longestValidPathFrom(child, treePath.tail(path)) : '';
    }
    function getCurrentNodesAfterPly(nodeList, mainline, ply) {
        const nodes = [];
        for (const i in nodeList) {
            const node = nodeList[i];
            if (node.ply <= ply && mainline[i].id !== node.id)
                break;
            if (node.ply > ply)
                nodes.push(node);
        }
        return nodes;
    }
    const pathIsMainline = (path) => pathIsMainlineFrom(root, path);
    const pathExists = (path) => !!nodeAtPathOrNull(path);
    function pathIsMainlineFrom(node, path) {
        if (path === '')
            return true;
        const pathId = treePath.head(path), child = node.children[0];
        if (!child || child.id !== pathId)
            return false;
        return pathIsMainlineFrom(child, treePath.tail(path));
    }
    const pathIsForcedVariation = (path) => !!getNodeList(path).find(n => n.forceVariation);
    function lastMainlineNodeFrom(node, path) {
        if (path === '')
            return node;
        const pathId = treePath.head(path);
        const child = node.children[0];
        if (!child || child.id !== pathId)
            return node;
        return lastMainlineNodeFrom(child, treePath.tail(path));
    }
    const getNodeList = (path) => ops.collect(root, function (node) {
        const id = treePath.head(path);
        if (id === '')
            return;
        path = treePath.tail(path);
        return ops.childById(node, id);
    });
    function updateAt(path, update) {
        const node = nodeAtPathOrNull(path);
        if (node) {
            update(node);
            return node;
        }
        return;
    }
    // returns new path
    function addNode(node, path) {
        const newPath = path + node.id, existing = nodeAtPathOrNull(newPath);
        if (existing) {
            ['dests', 'drops', 'clock'].forEach(key => {
                if (defined(node[key]) && !defined(existing[key]))
                    existing[key] = node[key];
            });
            return newPath;
        }
        return updateAt(path, function (parent) {
            parent.children.push(node);
        })
            ? newPath
            : undefined;
    }
    function addNodes(nodes, path) {
        const node = nodes[0];
        if (!node)
            return path;
        const newPath = addNode(node, path);
        return newPath ? addNodes(nodes.slice(1), newPath) : undefined;
    }
    function deleteNodeAt(path) {
        ops.removeChild(parentNode(path), treePath.last(path));
    }
    function promoteAt(path, toMainline) {
        const nodes = getNodeList(path);
        for (let i = nodes.length - 2; i >= 0; i--) {
            const node = nodes[i + 1];
            const parent = nodes[i];
            if (parent.children[0].id !== node.id) {
                ops.removeChild(parent, node.id);
                parent.children.unshift(node);
                if (!toMainline)
                    break;
            }
            else if (node.forceVariation) {
                node.forceVariation = false;
                if (!toMainline)
                    break;
            }
        }
    }
    const setCommentAt = (comment, path) => !comment.text
        ? deleteCommentAt(comment.id, path)
        : updateAt(path, function (node) {
            node.comments = node.comments || [];
            const existing = node.comments.find(function (c) {
                return c.id === comment.id;
            });
            if (existing)
                existing.text = comment.text;
            else
                node.comments.push(comment);
        });
    const deleteCommentAt = (id, path) => updateAt(path, function (node) {
        const comments = (node.comments || []).filter(function (c) {
            return c.id !== id;
        });
        node.comments = comments.length ? comments : undefined;
    });
    const setGlyphsAt = (glyphs, path) => updateAt(path, function (node) {
        node.glyphs = glyphs;
    });
    const parentNode = (path) => nodeAtPath(treePath.init(path));
    function getParentClock(node, path) {
        if (!('parentClock' in node)) {
            const par = path && parentNode(path);
            if (!par)
                node.parentClock = node.clock;
            else if (!('clock' in par))
                node.parentClock = undefined;
            else
                node.parentClock = par.clock;
        }
        return node.parentClock;
    }
    return {
        root,
        lastPly() {
            var _a;
            return ((_a = lastNode()) === null || _a === void 0 ? void 0 : _a.ply) || root.ply;
        },
        nodeAtPath,
        getNodeList,
        longestValidPath: (path) => longestValidPathFrom(root, path),
        updateAt,
        addNode,
        addNodes,
        addDests(dests, path) {
            return updateAt(path, function (node) {
                node.dests = dests;
            });
        },
        setShapes(shapes, path) {
            return updateAt(path, function (node) {
                node.shapes = shapes;
            });
        },
        setCommentAt,
        deleteCommentAt,
        setGlyphsAt,
        setClockAt(clock, path) {
            return updateAt(path, function (node) {
                node.clock = clock;
            });
        },
        pathIsMainline,
        pathIsForcedVariation,
        lastMainlineNode(path) {
            return lastMainlineNodeFrom(root, path);
        },
        pathExists,
        deleteNodeAt,
        promoteAt,
        forceVariationAt(path, force) {
            return updateAt(path, function (node) {
                node.forceVariation = force;
            });
        },
        getCurrentNodesAfterPly,
        merge(tree) {
            ops.merge(root, tree);
        },
        removeCeval() {
            ops.updateAll(root, function (n) {
                delete n.ceval;
                delete n.threat;
            });
        },
        removeComputerVariations() {
            ops.mainlineNodeList(root).forEach(function (n) {
                n.children = n.children.filter(function (c) {
                    return !c.comp;
                });
            });
        },
        parentNode,
        getParentClock,
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy90cmVlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxRQUFRLE1BQU0sUUFBUSxDQUFDO0FBQ25DLE9BQU8sS0FBSyxHQUFHLE1BQU0sT0FBTyxDQUFDO0FBQzdCLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFrQ2pDLE1BQU0sVUFBVSxLQUFLLENBQUMsSUFBZTtJQUNuQyxNQUFNLFFBQVEsR0FBRyxHQUFjLEVBQUUsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxDQUFDLElBQWUsRUFBRSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBRXZHLE1BQU0sVUFBVSxHQUFHLENBQUMsSUFBZSxFQUFhLEVBQUUsQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBRTlFLFNBQVMsY0FBYyxDQUFDLElBQWUsRUFBRSxJQUFlO1FBQ3RELElBQUksSUFBSSxLQUFLLEVBQUU7WUFBRSxPQUFPLElBQUksQ0FBQztRQUM3QixNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDdkQsT0FBTyxLQUFLLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDbkUsQ0FBQztJQUVELE1BQU0sZ0JBQWdCLEdBQUcsQ0FBQyxJQUFlLEVBQXlCLEVBQUUsQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFFdEcsU0FBUyxvQkFBb0IsQ0FBQyxJQUFlLEVBQUUsSUFBZTtRQUM1RCxJQUFJLElBQUksS0FBSyxFQUFFO1lB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LGdCQUFnQixDQUFDLElBQWUsRUFBRSxLQUFjO1lBQzlDLE9BQU8sUUFBUSxDQUFDLElBQUksRUFBRSxVQUFVLElBQUk7Z0JBQ2xDLElBQUksQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDO1lBQzlCLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUNELHVCQUF1QjtRQUN2QixLQUFLLENBQUMsSUFBZTtZQUNuQixHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN4QixDQUFDO1FBQ0QsV0FBVztZQUNULEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQztnQkFDN0IsT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFDO2dCQUNmLE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQztZQUNsQixDQUFDLENBQUMsQ0FBQztRQUNMLENBQUM7UUFDRCx3QkFBd0I7WUFDdEIsR0FBRyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUM7Z0JBQzVDLENBQUMsQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDO29CQUN4QyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDakIsQ0FBQyxDQUFDLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUM7UUFDRCxVQUFVO1FBQ1YsY0FBYztLQUNmLENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgdHJlZVBhdGggZnJvbSAnLi9wYXRoJztcbmltcG9ydCAqIGFzIG9wcyBmcm9tICcuL29wcyc7XG5pbXBvcnQgeyBkZWZpbmVkIH0gZnJvbSAnY29tbW9uJztcblxuZXhwb3J0IHR5cGUgTWF5YmVOb2RlID0gVHJlZS5Ob2RlIHwgdW5kZWZpbmVkO1xuXG5leHBvcnQgaW50ZXJmYWNlIFRyZWVXcmFwcGVyIHtcbiAgcm9vdDogVHJlZS5Ob2RlO1xuICBsYXN0UGx5KCk6IG51bWJlcjtcbiAgbm9kZUF0UGF0aChwYXRoOiBUcmVlLlBhdGgpOiBUcmVlLk5vZGU7XG4gIGdldE5vZGVMaXN0KHBhdGg6IFRyZWUuUGF0aCk6IFRyZWUuTm9kZVtdO1xuICBsb25nZXN0VmFsaWRQYXRoKHBhdGg6IHN0cmluZyk6IFRyZWUuUGF0aDtcbiAgdXBkYXRlQXQocGF0aDogVHJlZS5QYXRoLCB1cGRhdGU6IChub2RlOiBUcmVlLk5vZGUpID0+IHZvaWQpOiBNYXliZU5vZGU7XG4gIGFkZE5vZGUobm9kZTogVHJlZS5Ob2RlLCBwYXRoOiBUcmVlLlBhdGgpOiBUcmVlLlBhdGggfCB1bmRlZmluZWQ7XG4gIGFkZE5vZGVzKG5vZGVzOiBUcmVlLk5vZGVbXSwgcGF0aDogVHJlZS5QYXRoKTogVHJlZS5QYXRoIHwgdW5kZWZpbmVkO1xuICBhZGREZXN0cyhkZXN0czogc3RyaW5nLCBwYXRoOiBUcmVlLlBhdGgpOiBNYXliZU5vZGU7XG4gIHNldFNoYXBlcyhzaGFwZXM6IFRyZWUuU2hhcGVbXSwgcGF0aDogVHJlZS5QYXRoKTogTWF5YmVOb2RlO1xuICBzZXRDb21tZW50QXQoY29tbWVudDogVHJlZS5Db21tZW50LCBwYXRoOiBUcmVlLlBhdGgpOiBNYXliZU5vZGU7XG4gIGRlbGV0ZUNvbW1lbnRBdChpZDogc3RyaW5nLCBwYXRoOiBUcmVlLlBhdGgpOiBNYXliZU5vZGU7XG4gIHNldEdseXBoc0F0KGdseXBoczogVHJlZS5HbHlwaFtdLCBwYXRoOiBUcmVlLlBhdGgpOiBNYXliZU5vZGU7XG4gIHNldENsb2NrQXQoY2xvY2s6IFRyZWUuQ2xvY2sgfCB1bmRlZmluZWQsIHBhdGg6IFRyZWUuUGF0aCk6IE1heWJlTm9kZTtcbiAgcGF0aElzTWFpbmxpbmUocGF0aDogVHJlZS5QYXRoKTogYm9vbGVhbjtcbiAgcGF0aElzRm9yY2VkVmFyaWF0aW9uKHBhdGg6IFRyZWUuUGF0aCk6IGJvb2xlYW47XG4gIGxhc3RNYWlubGluZU5vZGUocGF0aDogVHJlZS5QYXRoKTogVHJlZS5Ob2RlO1xuICBwYXRoRXhpc3RzKHBhdGg6IFRyZWUuUGF0aCk6IGJvb2xlYW47XG4gIGRlbGV0ZU5vZGVBdChwYXRoOiBUcmVlLlBhdGgpOiB2b2lkO1xuICBwcm9tb3RlQXQocGF0aDogVHJlZS5QYXRoLCB0b01haW5saW5lOiBib29sZWFuKTogdm9pZDtcbiAgZm9yY2VWYXJpYXRpb25BdChwYXRoOiBUcmVlLlBhdGgsIGZvcmNlOiBib29sZWFuKTogTWF5YmVOb2RlO1xuICBnZXRDdXJyZW50Tm9kZXNBZnRlclBseShub2RlTGlzdDogVHJlZS5Ob2RlW10sIG1haW5saW5lOiBUcmVlLk5vZGVbXSwgcGx5OiBudW1iZXIpOiBUcmVlLk5vZGVbXTtcbiAgbWVyZ2UodHJlZTogVHJlZS5Ob2RlKTogdm9pZDtcbiAgcmVtb3ZlQ2V2YWwoKTogdm9pZDtcbiAgcmVtb3ZlQ29tcHV0ZXJWYXJpYXRpb25zKCk6IHZvaWQ7XG4gIHBhcmVudE5vZGUocGF0aDogVHJlZS5QYXRoKTogVHJlZS5Ob2RlO1xuICBnZXRQYXJlbnRDbG9jayhub2RlOiBUcmVlLk5vZGUsIHBhdGg6IFRyZWUuUGF0aCk6IFRyZWUuQ2xvY2sgfCB1bmRlZmluZWQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBidWlsZChyb290OiBUcmVlLk5vZGUpOiBUcmVlV3JhcHBlciB7XG4gIGNvbnN0IGxhc3ROb2RlID0gKCk6IE1heWJlTm9kZSA9PiBvcHMuZmluZEluTWFpbmxpbmUocm9vdCwgKG5vZGU6IFRyZWUuTm9kZSkgPT4gIW5vZGUuY2hpbGRyZW4ubGVuZ3RoKTtcblxuICBjb25zdCBub2RlQXRQYXRoID0gKHBhdGg6IFRyZWUuUGF0aCk6IFRyZWUuTm9kZSA9PiBub2RlQXRQYXRoRnJvbShyb290LCBwYXRoKTtcblxuICBmdW5jdGlvbiBub2RlQXRQYXRoRnJvbShub2RlOiBUcmVlLk5vZGUsIHBhdGg6IFRyZWUuUGF0aCk6IFRyZWUuTm9kZSB7XG4gICAgaWYgKHBhdGggPT09ICcnKSByZXR1cm4gbm9kZTtcbiAgICBjb25zdCBjaGlsZCA9IG9wcy5jaGlsZEJ5SWQobm9kZSwgdHJlZVBhdGguaGVhZChwYXRoKSk7XG4gICAgcmV0dXJuIGNoaWxkID8gbm9kZUF0UGF0aEZyb20oY2hpbGQsIHRyZWVQYXRoLnRhaWwocGF0aCkpIDogbm9kZTtcbiAgfVxuXG4gIGNvbnN0IG5vZGVBdFBhdGhPck51bGwgPSAocGF0aDogVHJlZS5QYXRoKTogVHJlZS5Ob2RlIHwgdW5kZWZpbmVkID0+IG5vZGVBdFBhdGhPck51bGxGcm9tKHJvb3QsIHBhdGgpO1xuXG4gIGZ1bmN0aW9uIG5vZGVBdFBhdGhPck51bGxGcm9tKG5vZGU6IFRyZWUuTm9kZSwgcGF0aDogVHJlZS5QYXRoKTogVHJlZS5Ob2RlIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAocGF0aCA9PT0gJycpIHJldHVybiBub2RlO1xuICAgIGNvbnN0IGNoaWxkID0gb3BzLmNoaWxkQnlJZChub2RlLCB0cmVlUGF0aC5oZWFkKHBhdGgpKTtcbiAgICByZXR1cm4gY2hpbGQgPyBub2RlQXRQYXRoT3JOdWxsRnJvbShjaGlsZCwgdHJlZVBhdGgudGFpbChwYXRoKSkgOiB1bmRlZmluZWQ7XG4gIH1cblxuICBmdW5jdGlvbiBsb25nZXN0VmFsaWRQYXRoRnJvbShub2RlOiBUcmVlLk5vZGUsIHBhdGg6IFRyZWUuUGF0aCk6IFRyZWUuUGF0aCB7XG4gICAgY29uc3QgaWQgPSB0cmVlUGF0aC5oZWFkKHBhdGgpO1xuICAgIGNvbnN0IGNoaWxkID0gb3BzLmNoaWxkQnlJZChub2RlLCBpZCk7XG4gICAgcmV0dXJuIGNoaWxkID8gaWQgKyBsb25nZXN0VmFsaWRQYXRoRnJvbShjaGlsZCwgdHJlZVBhdGgudGFpbChwYXRoKSkgOiAnJztcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEN1cnJlbnROb2Rlc0FmdGVyUGx5KG5vZGVMaXN0OiBUcmVlLk5vZGVbXSwgbWFpbmxpbmU6IFRyZWUuTm9kZVtdLCBwbHk6IG51bWJlcik6IFRyZWUuTm9kZVtdIHtcbiAgICBjb25zdCBub2RlcyA9IFtdO1xuICAgIGZvciAoY29uc3QgaSBpbiBub2RlTGlzdCkge1xuICAgICAgY29uc3Qgbm9kZSA9IG5vZGVMaXN0W2ldO1xuICAgICAgaWYgKG5vZGUucGx5IDw9IHBseSAmJiBtYWlubGluZVtpXS5pZCAhPT0gbm9kZS5pZCkgYnJlYWs7XG4gICAgICBpZiAobm9kZS5wbHkgPiBwbHkpIG5vZGVzLnB1c2gobm9kZSk7XG4gICAgfVxuICAgIHJldHVybiBub2RlcztcbiAgfVxuXG4gIGNvbnN0IHBhdGhJc01haW5saW5lID0gKHBhdGg6IFRyZWUuUGF0aCk6IGJvb2xlYW4gPT4gcGF0aElzTWFpbmxpbmVGcm9tKHJvb3QsIHBhdGgpO1xuXG4gIGNvbnN0IHBhdGhFeGlzdHMgPSAocGF0aDogVHJlZS5QYXRoKTogYm9vbGVhbiA9PiAhIW5vZGVBdFBhdGhPck51bGwocGF0aCk7XG5cbiAgZnVuY3Rpb24gcGF0aElzTWFpbmxpbmVGcm9tKG5vZGU6IFRyZWUuTm9kZSwgcGF0aDogVHJlZS5QYXRoKTogYm9vbGVhbiB7XG4gICAgaWYgKHBhdGggPT09ICcnKSByZXR1cm4gdHJ1ZTtcbiAgICBjb25zdCBwYXRoSWQgPSB0cmVlUGF0aC5oZWFkKHBhdGgpLFxuICAgICAgY2hpbGQgPSBub2RlLmNoaWxkcmVuWzBdO1xuICAgIGlmICghY2hpbGQgfHwgY2hpbGQuaWQgIT09IHBhdGhJZCkgcmV0dXJuIGZhbHNlO1xuICAgIHJldHVybiBwYXRoSXNNYWlubGluZUZyb20oY2hpbGQsIHRyZWVQYXRoLnRhaWwocGF0aCkpO1xuICB9XG5cbiAgY29uc3QgcGF0aElzRm9yY2VkVmFyaWF0aW9uID0gKHBhdGg6IFRyZWUuUGF0aCk6IGJvb2xlYW4gPT4gISFnZXROb2RlTGlzdChwYXRoKS5maW5kKG4gPT4gbi5mb3JjZVZhcmlhdGlvbik7XG5cbiAgZnVuY3Rpb24gbGFzdE1haW5saW5lTm9kZUZyb20obm9kZTogVHJlZS5Ob2RlLCBwYXRoOiBUcmVlLlBhdGgpOiBUcmVlLk5vZGUge1xuICAgIGlmIChwYXRoID09PSAnJykgcmV0dXJuIG5vZGU7XG4gICAgY29uc3QgcGF0aElkID0gdHJlZVBhdGguaGVhZChwYXRoKTtcbiAgICBjb25zdCBjaGlsZCA9IG5vZGUuY2hpbGRyZW5bMF07XG4gICAgaWYgKCFjaGlsZCB8fCBjaGlsZC5pZCAhPT0gcGF0aElkKSByZXR1cm4gbm9kZTtcbiAgICByZXR1cm4gbGFzdE1haW5saW5lTm9kZUZyb20oY2hpbGQsIHRyZWVQYXRoLnRhaWwocGF0aCkpO1xuICB9XG5cbiAgY29uc3QgZ2V0Tm9kZUxpc3QgPSAocGF0aDogVHJlZS5QYXRoKTogVHJlZS5Ob2RlW10gPT5cbiAgICBvcHMuY29sbGVjdChyb290LCBmdW5jdGlvbiAobm9kZTogVHJlZS5Ob2RlKSB7XG4gICAgICBjb25zdCBpZCA9IHRyZWVQYXRoLmhlYWQocGF0aCk7XG4gICAgICBpZiAoaWQgPT09ICcnKSByZXR1cm47XG4gICAgICBwYXRoID0gdHJlZVBhdGgudGFpbChwYXRoKTtcbiAgICAgIHJldHVybiBvcHMuY2hpbGRCeUlkKG5vZGUsIGlkKTtcbiAgICB9KTtcblxuICBmdW5jdGlvbiB1cGRhdGVBdChwYXRoOiBUcmVlLlBhdGgsIHVwZGF0ZTogKG5vZGU6IFRyZWUuTm9kZSkgPT4gdm9pZCk6IFRyZWUuTm9kZSB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3Qgbm9kZSA9IG5vZGVBdFBhdGhPck51bGwocGF0aCk7XG4gICAgaWYgKG5vZGUpIHtcbiAgICAgIHVwZGF0ZShub2RlKTtcbiAgICAgIHJldHVybiBub2RlO1xuICAgIH1cbiAgICByZXR1cm47XG4gIH1cblxuICAvLyByZXR1cm5zIG5ldyBwYXRoXG4gIGZ1bmN0aW9uIGFkZE5vZGUobm9kZTogVHJlZS5Ob2RlLCBwYXRoOiBUcmVlLlBhdGgpOiBUcmVlLlBhdGggfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IG5ld1BhdGggPSBwYXRoICsgbm9kZS5pZCxcbiAgICAgIGV4aXN0aW5nID0gbm9kZUF0UGF0aE9yTnVsbChuZXdQYXRoKTtcbiAgICBpZiAoZXhpc3RpbmcpIHtcbiAgICAgIChbJ2Rlc3RzJywgJ2Ryb3BzJywgJ2Nsb2NrJ10gYXMgQXJyYXk8a2V5b2YgVHJlZS5Ob2RlPikuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICBpZiAoZGVmaW5lZChub2RlW2tleV0pICYmICFkZWZpbmVkKGV4aXN0aW5nW2tleV0pKSBleGlzdGluZ1trZXldID0gbm9kZVtrZXldIGFzIG5ldmVyO1xuICAgICAgfSk7XG4gICAgICByZXR1cm4gbmV3UGF0aDtcbiAgICB9XG4gICAgcmV0dXJuIHVwZGF0ZUF0KHBhdGgsIGZ1bmN0aW9uIChwYXJlbnQ6IFRyZWUuTm9kZSkge1xuICAgICAgcGFyZW50LmNoaWxkcmVuLnB1c2gobm9kZSk7XG4gICAgfSlcbiAgICAgID8gbmV3UGF0aFxuICAgICAgOiB1bmRlZmluZWQ7XG4gIH1cblxuICBmdW5jdGlvbiBhZGROb2Rlcyhub2RlczogVHJlZS5Ob2RlW10sIHBhdGg6IFRyZWUuUGF0aCk6IFRyZWUuUGF0aCB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3Qgbm9kZSA9IG5vZGVzWzBdO1xuICAgIGlmICghbm9kZSkgcmV0dXJuIHBhdGg7XG4gICAgY29uc3QgbmV3UGF0aCA9IGFkZE5vZGUobm9kZSwgcGF0aCk7XG4gICAgcmV0dXJuIG5ld1BhdGggPyBhZGROb2Rlcyhub2Rlcy5zbGljZSgxKSwgbmV3UGF0aCkgOiB1bmRlZmluZWQ7XG4gIH1cblxuICBmdW5jdGlvbiBkZWxldGVOb2RlQXQocGF0aDogVHJlZS5QYXRoKTogdm9pZCB7XG4gICAgb3BzLnJlbW92ZUNoaWxkKHBhcmVudE5vZGUocGF0aCksIHRyZWVQYXRoLmxhc3QocGF0aCkpO1xuICB9XG5cbiAgZnVuY3Rpb24gcHJvbW90ZUF0KHBhdGg6IFRyZWUuUGF0aCwgdG9NYWlubGluZTogYm9vbGVhbik6IHZvaWQge1xuICAgIGNvbnN0IG5vZGVzID0gZ2V0Tm9kZUxpc3QocGF0aCk7XG4gICAgZm9yIChsZXQgaSA9IG5vZGVzLmxlbmd0aCAtIDI7IGkgPj0gMDsgaS0tKSB7XG4gICAgICBjb25zdCBub2RlID0gbm9kZXNbaSArIDFdO1xuICAgICAgY29uc3QgcGFyZW50ID0gbm9kZXNbaV07XG4gICAgICBpZiAocGFyZW50LmNoaWxkcmVuWzBdLmlkICE9PSBub2RlLmlkKSB7XG4gICAgICAgIG9wcy5yZW1vdmVDaGlsZChwYXJlbnQsIG5vZGUuaWQpO1xuICAgICAgICBwYXJlbnQuY2hpbGRyZW4udW5zaGlmdChub2RlKTtcbiAgICAgICAgaWYgKCF0b01haW5saW5lKSBicmVhaztcbiAgICAgIH0gZWxzZSBpZiAobm9kZS5mb3JjZVZhcmlhdGlvbikge1xuICAgICAgICBub2RlLmZvcmNlVmFyaWF0aW9uID0gZmFsc2U7XG4gICAgICAgIGlmICghdG9NYWlubGluZSkgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgY29uc3Qgc2V0Q29tbWVudEF0ID0gKGNvbW1lbnQ6IFRyZWUuQ29tbWVudCwgcGF0aDogVHJlZS5QYXRoKSA9PlxuICAgICFjb21tZW50LnRleHRcbiAgICAgID8gZGVsZXRlQ29tbWVudEF0KGNvbW1lbnQuaWQsIHBhdGgpXG4gICAgICA6IHVwZGF0ZUF0KHBhdGgsIGZ1bmN0aW9uIChub2RlKSB7XG4gICAgICAgICAgbm9kZS5jb21tZW50cyA9IG5vZGUuY29tbWVudHMgfHwgW107XG4gICAgICAgICAgY29uc3QgZXhpc3RpbmcgPSBub2RlLmNvbW1lbnRzLmZpbmQoZnVuY3Rpb24gKGMpIHtcbiAgICAgICAgICAgIHJldHVybiBjLmlkID09PSBjb21tZW50LmlkO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIGlmIChleGlzdGluZykgZXhpc3RpbmcudGV4dCA9IGNvbW1lbnQudGV4dDtcbiAgICAgICAgICBlbHNlIG5vZGUuY29tbWVudHMucHVzaChjb21tZW50KTtcbiAgICAgICAgfSk7XG5cbiAgY29uc3QgZGVsZXRlQ29tbWVudEF0ID0gKGlkOiBzdHJpbmcsIHBhdGg6IFRyZWUuUGF0aCkgPT5cbiAgICB1cGRhdGVBdChwYXRoLCBmdW5jdGlvbiAobm9kZSkge1xuICAgICAgY29uc3QgY29tbWVudHMgPSAobm9kZS5jb21tZW50cyB8fCBbXSkuZmlsdGVyKGZ1bmN0aW9uIChjKSB7XG4gICAgICAgIHJldHVybiBjLmlkICE9PSBpZDtcbiAgICAgIH0pO1xuICAgICAgbm9kZS5jb21tZW50cyA9IGNvbW1lbnRzLmxlbmd0aCA/IGNvbW1lbnRzIDogdW5kZWZpbmVkO1xuICAgIH0pO1xuXG4gIGNvbnN0IHNldEdseXBoc0F0ID0gKGdseXBoczogVHJlZS5HbHlwaFtdLCBwYXRoOiBUcmVlLlBhdGgpID0+XG4gICAgdXBkYXRlQXQocGF0aCwgZnVuY3Rpb24gKG5vZGUpIHtcbiAgICAgIG5vZGUuZ2x5cGhzID0gZ2x5cGhzO1xuICAgIH0pO1xuXG4gIGNvbnN0IHBhcmVudE5vZGUgPSAocGF0aDogVHJlZS5QYXRoKTogVHJlZS5Ob2RlID0+IG5vZGVBdFBhdGgodHJlZVBhdGguaW5pdChwYXRoKSk7XG5cbiAgZnVuY3Rpb24gZ2V0UGFyZW50Q2xvY2sobm9kZTogVHJlZS5Ob2RlLCBwYXRoOiBUcmVlLlBhdGgpOiBUcmVlLkNsb2NrIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoISgncGFyZW50Q2xvY2snIGluIG5vZGUpKSB7XG4gICAgICBjb25zdCBwYXIgPSBwYXRoICYmIHBhcmVudE5vZGUocGF0aCk7XG4gICAgICBpZiAoIXBhcikgbm9kZS5wYXJlbnRDbG9jayA9IG5vZGUuY2xvY2s7XG4gICAgICBlbHNlIGlmICghKCdjbG9jaycgaW4gcGFyKSkgbm9kZS5wYXJlbnRDbG9jayA9IHVuZGVmaW5lZDtcbiAgICAgIGVsc2Ugbm9kZS5wYXJlbnRDbG9jayA9IHBhci5jbG9jaztcbiAgICB9XG4gICAgcmV0dXJuIG5vZGUucGFyZW50Q2xvY2s7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIHJvb3QsXG4gICAgbGFzdFBseSgpOiBudW1iZXIge1xuICAgICAgcmV0dXJuIGxhc3ROb2RlKCk/LnBseSB8fCByb290LnBseTtcbiAgICB9LFxuICAgIG5vZGVBdFBhdGgsXG4gICAgZ2V0Tm9kZUxpc3QsXG4gICAgbG9uZ2VzdFZhbGlkUGF0aDogKHBhdGg6IHN0cmluZykgPT4gbG9uZ2VzdFZhbGlkUGF0aEZyb20ocm9vdCwgcGF0aCksXG4gICAgdXBkYXRlQXQsXG4gICAgYWRkTm9kZSxcbiAgICBhZGROb2RlcyxcbiAgICBhZGREZXN0cyhkZXN0czogc3RyaW5nLCBwYXRoOiBUcmVlLlBhdGgpIHtcbiAgICAgIHJldHVybiB1cGRhdGVBdChwYXRoLCBmdW5jdGlvbiAobm9kZTogVHJlZS5Ob2RlKSB7XG4gICAgICAgIG5vZGUuZGVzdHMgPSBkZXN0cztcbiAgICAgIH0pO1xuICAgIH0sXG4gICAgc2V0U2hhcGVzKHNoYXBlczogVHJlZS5TaGFwZVtdLCBwYXRoOiBUcmVlLlBhdGgpIHtcbiAgICAgIHJldHVybiB1cGRhdGVBdChwYXRoLCBmdW5jdGlvbiAobm9kZTogVHJlZS5Ob2RlKSB7XG4gICAgICAgIG5vZGUuc2hhcGVzID0gc2hhcGVzO1xuICAgICAgfSk7XG4gICAgfSxcbiAgICBzZXRDb21tZW50QXQsXG4gICAgZGVsZXRlQ29tbWVudEF0LFxuICAgIHNldEdseXBoc0F0LFxuICAgIHNldENsb2NrQXQoY2xvY2s6IFRyZWUuQ2xvY2sgfCB1bmRlZmluZWQsIHBhdGg6IFRyZWUuUGF0aCkge1xuICAgICAgcmV0dXJuIHVwZGF0ZUF0KHBhdGgsIGZ1bmN0aW9uIChub2RlKSB7XG4gICAgICAgIG5vZGUuY2xvY2sgPSBjbG9jaztcbiAgICAgIH0pO1xuICAgIH0sXG4gICAgcGF0aElzTWFpbmxpbmUsXG4gICAgcGF0aElzRm9yY2VkVmFyaWF0aW9uLFxuICAgIGxhc3RNYWlubGluZU5vZGUocGF0aDogVHJlZS5QYXRoKTogVHJlZS5Ob2RlIHtcbiAgICAgIHJldHVybiBsYXN0TWFpbmxpbmVOb2RlRnJvbShyb290LCBwYXRoKTtcbiAgICB9LFxuICAgIHBhdGhFeGlzdHMsXG4gICAgZGVsZXRlTm9kZUF0LFxuICAgIHByb21vdGVBdCxcbiAgICBmb3JjZVZhcmlhdGlvbkF0KHBhdGg6IFRyZWUuUGF0aCwgZm9yY2U6IGJvb2xlYW4pIHtcbiAgICAgIHJldHVybiB1cGRhdGVBdChwYXRoLCBmdW5jdGlvbiAobm9kZSkge1xuICAgICAgICBub2RlLmZvcmNlVmFyaWF0aW9uID0gZm9yY2U7XG4gICAgICB9KTtcbiAgICB9LFxuICAgIGdldEN1cnJlbnROb2Rlc0FmdGVyUGx5LFxuICAgIG1lcmdlKHRyZWU6IFRyZWUuTm9kZSkge1xuICAgICAgb3BzLm1lcmdlKHJvb3QsIHRyZWUpO1xuICAgIH0sXG4gICAgcmVtb3ZlQ2V2YWwoKSB7XG4gICAgICBvcHMudXBkYXRlQWxsKHJvb3QsIGZ1bmN0aW9uIChuKSB7XG4gICAgICAgIGRlbGV0ZSBuLmNldmFsO1xuICAgICAgICBkZWxldGUgbi50aHJlYXQ7XG4gICAgICB9KTtcbiAgICB9LFxuICAgIHJlbW92ZUNvbXB1dGVyVmFyaWF0aW9ucygpIHtcbiAgICAgIG9wcy5tYWlubGluZU5vZGVMaXN0KHJvb3QpLmZvckVhY2goZnVuY3Rpb24gKG4pIHtcbiAgICAgICAgbi5jaGlsZHJlbiA9IG4uY2hpbGRyZW4uZmlsdGVyKGZ1bmN0aW9uIChjKSB7XG4gICAgICAgICAgcmV0dXJuICFjLmNvbXA7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSxcbiAgICBwYXJlbnROb2RlLFxuICAgIGdldFBhcmVudENsb2NrLFxuICB9O1xufVxuIl19